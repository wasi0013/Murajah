<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Murajah - Quran Memorization App">
  <meta name="theme-color" content="#1f2937">
  <title>Murajah - Quran Memorization</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="./resources/favicon.ico">
  
  <!-- Tailwind CSS -->
  <script src="./resources/js/tailwind.3.4.7.js"></script>
  
  <!-- Line Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Vue 3 -->
  <script src="./resources/js/vue.global.js"></script>

  <style>
    :root {
      --primary: #3b82f6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --light-bg: #ffffff;
      --light-text: #111827;
      --dark-bg: #111827;
      --dark-text: #f3f4f6;
      --card-light: #ffffff;
    }

    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Surah Names Font */
    @font-face {
      font-family: 'SurahNames';
      src: url('./resources/surah_names.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
      unicode-range: U+0600-U+06FF;
    }

    html {
      scroll-behavior: smooth;
      background-color: var(--light-bg);
      color: var(--light-text);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    html.dark,
    html.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }

    body {
      transition: background-color 0.3s ease, color 0.3s ease;
      background-color: var(--light-bg);
      color: var(--light-text);
    }

    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }

    /* Root app container */
    #app {
      background-color: inherit;
      color: inherit;
      transition: background-color 0.3s ease, color 0.3s ease;
      min-height: 100vh;
    }

    /* Main app wrapper */
    .dark-mode {
      background-color: var(--dark-bg) !important;
      color: var(--dark-text) !important;
    }

    .dark-mode * {
      color-scheme: dark;
    }

    /* ===== LIGHT MODE DEFAULTS ===== */
    header {
      background-color: var(--card-light);
    }

    main {
      background-color: inherit;
    }

    footer {
      background-color: #111827;
      color: #9ca3af;
    }

    .bg-white {
      background-color: var(--card-light) !important;
      color: var(--light-text) !important;
    }

    .bg-gray-50 {
      background-color: #f9fafb !important;
      color: var(--light-text) !important;
    }

    .bg-gray-100 {
      background-color: #f3f4f6 !important;
      color: var(--light-text) !important;
    }

    .bg-gray-200 {
      background-color: #e5e7eb !important;
      color: var(--light-text) !important;
    }

    .bg-gray-700 {
      background-color: #374151 !important;
    }

    .bg-gray-800 {
      background-color: #1f2937 !important;
    }

    .bg-gray-900 {
      background-color: #111827 !important;
    }

    .text-gray-400 {
      color: #9ca3af !important;
    }

    .text-gray-500 {
      color: #6b7280 !important;
    }

    .text-gray-600 {
      color: #4b5563 !important;
    }

    .text-gray-700 {
      color: #374151 !important;
    }

    .text-gray-900 {
      color: #111827 !important;
    }

    /* ===== DARK MODE OVERRIDES ===== */
    .dark-mode header {
      background-color: var(--card-dark) !important;
      color: var(--dark-text) !important;
    }

    .dark-mode main {
      background-color: var(--dark-bg) !important;
      color: var(--dark-text) !important;
    }

    .dark-mode footer {
      background-color: #0f172a !important;
      color: var(--dark-text) !important;
    }

    .dark-mode .bg-white {
      background-color: var(--card-dark) !important;
      color: var(--dark-text) !important;
    }

    .dark-mode .bg-gray-50 {
      background-color: var(--dark-bg) !important;
      color: var(--dark-text) !important;
    }

    .dark-mode .bg-gray-100 {
      background-color: var(--card-dark) !important;
      color: var(--dark-text) !important;
    }

    .dark-mode .bg-gray-200 {
      background-color: #374151 !important;
      color: var(--dark-text) !important;
    }

    .dark-mode .bg-gray-700 {
      background-color: #1f2937 !important;
      color: var(--dark-text) !important;
    }

    .dark-mode .bg-gray-800 {
      background-color: var(--card-dark) !important;
      color: var(--dark-text) !important;
    }

    .dark-mode .bg-gray-900 {
      background-color: #0f172a !important;
      color: var(--dark-text) !important;
    }

    .dark-mode .text-gray-400 {
      color: #9ca3af !important;
    }

    .dark-mode .text-gray-500 {
      color: #6b7280 !important;
    }

    .dark-mode .text-gray-600 {
      color: #9ca3af !important;
    }

    .dark-mode .text-gray-700 {
      color: #d1d5db !important;
    }

    .dark-mode .text-gray-900 {
      color: var(--dark-text) !important;
    }

    .dark-mode p,
    .dark-mode span,
    .dark-mode div,
    .dark-mode label,
    .dark-mode h1,
    .dark-mode h2,
    .dark-mode h3,
    .dark-mode h4,
    .dark-mode h5,
    .dark-mode h6 {
      color: var(--dark-text) !important;
    }

    /* Quran Text Styling */
    .quran-text {
      font-family: 'QPCV2Page', 'Traditional Arabic', 'Arial Unicode MS', sans-serif;
      line-height: 1.1;
      direction: rtl;
      text-align: right;
      letter-spacing: 0.1em;
      color: #111827;
      background-color: #f3f4f6;
    }

    .dark-mode .quran-text {
      color: #1a1a1a;
      background-color: #d4b896;
    }

    .quran-text-small {
      font-size: 14px !important;
    }

    .quran-text-medium {
      font-size: 20px !important;
    }

    .quran-text-large {
      font-size: 28px !important;
    }

    .quran-word {
      display: inline-block;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0.08rem 0.12rem;
      border-radius: 4px;
      color: inherit;
    }

    .quran-word:hover {
      background-color: #bfdbfe;
      color: #1e3a8a;
    }

    .quran-word.mistake {
      background-color: #fecaca;
      color: #7f1d1d;
    }

    .quran-word.memorized-highlight {
      background-color: #bbf7d0;
      color: #065f46;
    }

    .dark-mode .quran-word:hover {
      background-color: #c4a876;
      color: #1a1a1a;
    }

    .dark-mode .quran-word.mistake {
      background-color: #d97777;
      color: #1a1a1a;
    }

    .dark-mode .quran-word.memorized-highlight {
      background-color: #9acd32;
      color: #1a1a1a;
    }

    /* Responsive Quran Text - Mobile Optimization */
    /* Extra Small Devices (<500px) */
    @media (max-width: 500px) {
      .quran-text-small {
        font-size: 10px !important;
      }
      .quran-text-medium {
        font-size: 14px !important;
      }
      .quran-text-large {
        font-size: 18px !important;
      }
      .quran-text {
        line-height: 0.8;
      }
      .quran-word {
        padding: 0.02rem 0.04rem;
      }
      /* Lighter red background for mistakes on mobile */
      .quran-word.mistake {
        background-color: #fee2e2;
        color: #991b1b;
      }
    }

    /* Small Devices (500px - 640px) */
    @media (min-width: 501px) and (max-width: 640px) {
      .quran-text {
        line-height: 0.9;
      }
      .quran-word {
        padding: 0.03rem 0.06rem;
      }
      /* Lighter red background for mistakes on mobile */
      .quran-word.mistake {
        background-color: #fee2e2;
        color: #991b1b;
      }
    }

    @media (max-width: 768px) and (min-width: 641px) {
      .quran-text {
        line-height: 1.0;
      }
      .quran-word {
        padding: 0.05rem 0.08rem;
      }
      /* Lighter red background for mistakes on mobile */
      .quran-word.mistake {
        background-color: #fee2e2;
        color: #991b1b;
      }
    }

    @media (min-width: 1024px) {
      .quran-text {
        line-height: 1.15;
      }
      .quran-word {
        padding: 0.08rem 0.12rem;
      }
    }

    /* Surah Name Styling */
    .quran-text .surah-name {
      font-family: 'SurahNames', 'Traditional Arabic', serif;
      color: #000 !important;
      font-size: 2.25rem;
    }

    .dark-mode .quran-text .surah-name {
      color: #000 !important;
    }

    /* Basmallah styling */
    .quran-text .basmallah {
      color: #000 !important;
      font-size: 2.25rem;
    }

    .dark-mode .quran-text .basmallah {
      color: #000 !important;
    }

    /* Smooth Transitions */
    .transition-all {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Touch Targets */
    button, a {
      min-height: 44px;
      min-width: 44px;
    }

    /* Loading Animation */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    /* Progress Bar */
    .progress-bar {
      height: 6px;
      background-color: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }

    .dark-mode .progress-bar {
      background-color: #374151;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #10b981);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 50;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Modal */
    .modal-backdrop {
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Responsive Grid */
    .bubble-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(20px, 1fr));
      gap: 4px;
      padding: 16px;
    }

    .memorized-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
      gap: 8px;
      padding: 16px;
    }

    /* Focus Visible for Accessibility */
    button:focus-visible, a:focus-visible, input:focus-visible {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }

    .dark-mode button:focus-visible, .dark-mode a:focus-visible, .dark-mode input:focus-visible {
      outline: 2px solid #60a5fa;
      outline-offset: 2px;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background-color: #f3f4f6;
    }

    .dark-mode ::-webkit-scrollbar-track {
      background-color: #1f2937;
    }

    ::-webkit-scrollbar-thumb {
      background-color: #9ca3af;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: #6b7280;
    }

    .dark-mode ::-webkit-scrollbar-thumb {
      background-color: #4b5563;
      border-radius: 4px;
    }

    .dark-mode ::-webkit-scrollbar-thumb:hover {
      background-color: #6b7280;
    }

    /* Select elements */
    select {
      background-color: var(--card-light);
      color: var(--light-text);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'%3E%3C/path%3E%3C/svg%3E");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
      appearance: none;
    }

    .dark-mode select {
      background-color: var(--card-dark);
      color: var(--dark-text);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%9CA3AF' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'%3E%3C/path%3E%3C/svg%3E");
    }

    select option {
      background-color: var(--card-light);
      color: var(--light-text);
    }

    .dark-mode select option {
      background-color: var(--card-dark);
      color: var(--dark-text);
    }

    /* Input fields */
    input, textarea {
      background-color: var(--card-light);
      color: var(--light-text);
      border-color: #d1d5db;
    }

    .dark-mode input,
    .dark-mode textarea {
      background-color: var(--card-dark);
      color: var(--dark-text);
      border-color: #4b5563;
    }

    input::placeholder,
    textarea::placeholder {
      color: #9ca3af;
    }

    .dark-mode input::placeholder,
    .dark-mode textarea::placeholder {
      color: #6b7280;
    }

    /* Buttons */
    button {
      color: inherit;
    }

    .dark-mode button {
      color: inherit;
    }

    /* Border colors */
    .border-blue-200 {
      border-color: #bfdbfe;
    }

    .dark-mode .border-blue-200 {
      border-color: #1e3a8a;
    }

    .border-blue-900 {
      border-color: #172554;
    }

    .dark-mode .border-blue-900 {
      border-color: #3b82f6;
    }

    /* ===== FIX GRADIENT BACKGROUNDS IN DARK MODE ===== */
    /* Light mode gradients remain, but dark mode overrides them */
    .dark-mode .bg-blue-50,
    .dark-mode .bg-purple-50,
    .dark-mode .bg-green-50,
    .dark-mode .bg-orange-50,
    .dark-mode .bg-yellow-50 {
      background-color: var(--card-dark) !important;
    }

    .dark-mode .bg-gradient-to-br {
      background: var(--card-dark) !important;
    }

    /* ===== BUTTON TEXT COLOR FIXES ===== */
    /* Ensure all buttons with dark backgrounds have white text in light mode */
    .bg-green-600,
    .bg-blue-600,
    .bg-red-600,
    .bg-purple-600,
    .bg-yellow-600,
    .bg-gray-600 {
      color: white !important;
    }

    .bg-green-600 span,
    .bg-blue-600 span,
    .bg-red-600 span,
    .bg-purple-600 span,
    .bg-yellow-600 span,
    .bg-gray-600 span {
      color: white !important;
    }

    .bg-green-600 i,
    .bg-blue-600 i,
    .bg-red-600 i,
    .bg-purple-600 i,
    .bg-yellow-600 i,
    .bg-gray-600 i {
      color: white !important;
    }

    /* Hover states - also white text */
    .hover\:bg-green-700:hover,
    .hover\:bg-blue-700:hover,
    .hover\:bg-red-700:hover,
    .hover\:bg-purple-700:hover {
      color: white !important;
    }

    /* Dark mode button overrides */
    .dark-mode .bg-green-600,
    .dark-mode .bg-blue-600,
    .dark-mode .bg-red-600,
    .dark-mode .bg-purple-600,
    .dark-mode .bg-yellow-600,
    .dark-mode .bg-gray-600 {
      color: white !important;
    }

    .dark-mode .bg-green-600 span,
    .dark-mode .bg-blue-600 span,
    .dark-mode .bg-red-600 span,
    .dark-mode .bg-purple-600 span,
    .dark-mode .bg-yellow-600 span,
    .dark-mode .bg-gray-600 span {
      color: white !important;
    }

    .dark-mode .bg-green-600 i,
    .dark-mode .bg-blue-600 i,
    .dark-mode .bg-red-600 i,
    .dark-mode .bg-purple-600 i,
    .dark-mode .bg-yellow-600 i,
    .dark-mode .bg-gray-600 i {
      color: white !important;
    }

    /* ===== ADDITIONAL BUTTON COLOR FIXES ===== */
    /* Add rules for yellow-500 and red-500 buttons */
    .bg-yellow-500,
    .bg-red-500 {
      color: white !important;
    }

    .bg-yellow-500 span,
    .bg-red-500 span {
      color: white !important;
    }

    .bg-yellow-500 i,
    .bg-red-500 i {
      color: white !important;
    }

    /* Hover states for -500 buttons */
    .hover\:bg-yellow-600:hover,
    .hover\:bg-red-600:hover {
      color: white !important;
    }

    /* Dark mode overrides for -500 buttons */
    .dark-mode .bg-yellow-500,
    .dark-mode .bg-red-500 {
      color: white !important;
    }

    .dark-mode .bg-yellow-500 span,
    .dark-mode .bg-red-500 span {
      color: white !important;
    }

    .dark-mode .bg-yellow-500 i,
    .dark-mode .bg-red-500 i {
      color: white !important;
    }

    .dark-mode .hover\:bg-yellow-600:hover,
    .dark-mode .hover\:bg-red-600:hover {
      color: white !important;
    }

    /* ===== CUSTOM TOOLTIP STYLING ===== */
    .word-tooltip {
      position: fixed;
      background-color: #fef3c7;
      color: #1f2937;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      pointer-events: none;
      z-index: 10000;
      max-width: 300px;
      word-wrap: break-word;
      white-space: normal;
      font-size: 0.875rem;
      font-weight: 500;
      transform: translateX(-50%);
      line-height: 1.5;
      border: 1px solid #fde68a;
    }

    .dark-mode .word-tooltip {
      background-color: #1f2937;
      color: #f3f4f6;
      border: 1px solid #374151;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }

    /* Arrow pointing down */
    .word-tooltip::after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid #fef3c7;
    }

    .dark-mode .word-tooltip::after {
      border-top-color: #1f2937;
    }
  </style>
</head>
<body class="overflow-x-hidden">
  <div id="app"></div>

  <script type="module">
    // Access Vue from global scope since it's loaded as a script tag
    const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

    // IIFE to handle async imports
    (async () => {
      // ==================== IndexedDB Manager ====================
      class MurajahDB {
        constructor() {
          this.dbName = 'murajah-db';
          this.version = 2;
          this.db = null;
        }

        async init() {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.version);

            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
              this.db = request.result;
              console.log('[Murajah] IndexedDB initialized');
              resolve();
            };

            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              
              // Create object stores if they don't exist
              if (!db.objectStoreNames.contains('appData')) {
                db.createObjectStore('appData', { keyPath: 'id' });
              }
              if (!db.objectStoreNames.contains('recordings')) {
                db.createObjectStore('recordings', { keyPath: 'id', autoIncrement: true });
              }
              if (!db.objectStoreNames.contains('dailyGoals')) {
                db.createObjectStore('dailyGoals', { keyPath: 'date' });
              }
              console.log('[Murajah] IndexedDB schema created');
            };
          });
        }

        async saveData(data) {
          const tx = this.db.transaction(['appData'], 'readwrite');
          const store = tx.objectStore('appData');
          store.put({ id: 'murajah-data', ...data });
          return new Promise((resolve, reject) => {
            tx.oncomplete = () => {
              console.log('[Murajah] Data saved to IndexedDB');
              resolve();
            };
            tx.onerror = () => reject(tx.error);
          });
        }

        async loadData() {
          const tx = this.db.transaction(['appData'], 'readonly');
          const store = tx.objectStore('appData');
          return new Promise((resolve, reject) => {
            const request = store.get('murajah-data');
            request.onsuccess = () => {
              const result = request.result;
              if (result) {
                const { id, ...data } = result;
                resolve(data);
              } else {
                resolve(null);
              }
            };
            request.onerror = () => reject(request.error);
          });
        }

        async clearAll() {
          const tx = this.db.transaction(['appData', 'recordings', 'dailyGoals'], 'readwrite');
          tx.objectStore('appData').clear();
          tx.objectStore('recordings').clear();
          tx.objectStore('dailyGoals').clear();
          return new Promise((resolve, reject) => {
            tx.oncomplete = () => {
              console.log('[Murajah] IndexedDB cleared');
              resolve();
            };
            tx.onerror = () => reject(tx.error);
          });
        }

        async saveRecording(index, recording) {
          const tx = this.db.transaction(['recordings'], 'readwrite');
          const store = tx.objectStore('recordings');
          store.put({ id: `recording-${index}`, ...recording });
          return new Promise((resolve, reject) => {
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
          });
        }

        async loadRecording(index) {
          const tx = this.db.transaction(['recordings'], 'readonly');
          const store = tx.objectStore('recordings');
          return new Promise((resolve, reject) => {
            const request = store.get(`recording-${index}`);
            request.onsuccess = () => {
              const result = request.result;
              if (result) {
                const { id, ...data } = result;
                resolve(data);
              } else {
                resolve(null);
              }
            };
            request.onerror = () => reject(request.error);
          });
        }

        async deleteRecording(index) {
          const tx = this.db.transaction(['recordings'], 'readwrite');
          const store = tx.objectStore('recordings');
          store.delete(`recording-${index}`);
          return new Promise((resolve, reject) => {
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
          });
        }

        async saveTheme(theme) {
          const tx = this.db.transaction(['appData'], 'readwrite');
          const store = tx.objectStore('appData');
          store.put({ id: 'murajah-theme', value: theme });
          return new Promise((resolve, reject) => {
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
          });
        }

        async loadTheme() {
          const tx = this.db.transaction(['appData'], 'readonly');
          const store = tx.objectStore('appData');
          return new Promise((resolve, reject) => {
            const request = store.get('murajah-theme');
            request.onsuccess = () => {
              const result = request.result;
              resolve(result ? result.value : 'light');
            };
            request.onerror = () => reject(request.error);
          });
        }

        // ===== Daily Goals Methods =====
        async saveDailyGoal(dailyGoal) {
          const tx = this.db.transaction(['dailyGoals'], 'readwrite');
          const store = tx.objectStore('dailyGoals');
          store.put({ ...dailyGoal, savedAt: new Date().toISOString() });
          return new Promise((resolve, reject) => {
            tx.oncomplete = () => {
              console.log(`[Murajah] Daily goal saved for ${dailyGoal.date}`);
              resolve();
            };
            tx.onerror = () => reject(tx.error);
          });
        }

        async loadDailyGoal(date) {
          const tx = this.db.transaction(['dailyGoals'], 'readonly');
          const store = tx.objectStore('dailyGoals');
          return new Promise((resolve, reject) => {
            const request = store.get(date);
            request.onsuccess = () => {
              resolve(request.result || null);
            };
            request.onerror = () => reject(request.error);
          });
        }

        async loadDailyGoalHistory(daysBack = 90) {
          const tx = this.db.transaction(['dailyGoals'], 'readonly');
          const store = tx.objectStore('dailyGoals');
          return new Promise((resolve, reject) => {
            const request = store.getAll();
            request.onsuccess = () => {
              const allRecords = request.result;
              
              // Filter records from last N days
              const cutoffDate = new Date();
              cutoffDate.setDate(cutoffDate.getDate() - daysBack);
              const cutoffDateStr = cutoffDate.toISOString().split('T')[0];
              
              const recentRecords = allRecords.filter(record => record.date >= cutoffDateStr);
              resolve(recentRecords.sort((a, b) => new Date(a.date) - new Date(b.date)));
            };
            request.onerror = () => reject(request.error);
          });
        }

        async deleteDailyGoal(date) {
          const tx = this.db.transaction(['dailyGoals'], 'readwrite');
          const store = tx.objectStore('dailyGoals');
          store.delete(date);
          return new Promise((resolve, reject) => {
            tx.oncomplete = () => {
              console.log(`[Murajah] Daily goal deleted for ${date}`);
              resolve();
            };
            tx.onerror = () => reject(tx.error);
          });
        }

        async clearOldDailyGoals(daysToKeep = 90) {
          const tx = this.db.transaction(['dailyGoals'], 'readonly');
          const store = tx.objectStore('dailyGoals');
          return new Promise((resolve, reject) => {
            const request = store.getAll();
            request.onsuccess = () => {
              const allRecords = request.result;
              
              const cutoffDate = new Date();
              cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);
              const cutoffDateStr = cutoffDate.toISOString().split('T')[0];
              
              const recordsToDelete = allRecords.filter(record => record.date < cutoffDateStr);
              
              if (recordsToDelete.length > 0) {
                const deleteTx = this.db.transaction(['dailyGoals'], 'readwrite');
                const deleteStore = deleteTx.objectStore('dailyGoals');
                recordsToDelete.forEach(record => deleteStore.delete(record.date));
                
                deleteTx.oncomplete = () => {
                  console.log(`[Murajah] Cleaned up ${recordsToDelete.length} old daily goal records`);
                  resolve(recordsToDelete.length);
                };
                deleteTx.onerror = () => reject(deleteTx.error);
              } else {
                resolve(0);
              }
            };
            request.onerror = () => reject(request.error);
          });
        }
      }

      // Initialize IndexedDB
      const murajahDB = new MurajahDB();
      await murajahDB.init();

      // Import utility modules
      const dataLoaderModule = await import('./resources/js/utils/dataLoader.js');
      const { loadAllQuranData, getPageText, getPageWordsDetailed } = dataLoaderModule;
      
      const calculationsModule = await import('./resources/js/utils/calculations.js');
      const { 
        calculateMemorizationPercentage, 
        calculateProgress,
        formatDuration,
        generateMistakeBubbles,
        generateMemorizedGrid,
        calculateStatistics,
        estimateCompletionDate,
        formatDate,
        getScoreColor,
        generatePageRange
      } = calculationsModule;
      
      const audioRecorderModule = await import('./resources/js/utils/audioRecorder.js');
      const AudioRecorder = audioRecorderModule.default;
      
      const dailyGoalsManagerModule = await import('./resources/js/utils/dailyGoalsManager.js');
      const {
        initializeTodayGoals,
        calculateReviewRange,
        completeTask,
        uncompleteTask,
        calculateStreak,
        checkAllTasksComplete,
        getTaskCounts,
        isNewDay,
        getTodayDate,
        getCompletionPercentage
      } = dailyGoalsManagerModule;

      const app = createApp({
        template: `
          <div :class="{ 'dark-mode': appStore.theme === 'dark' }" class="min-h-screen transition-all bg-white text-gray-900">
            <!-- Loading Screen -->
            <div v-if="isInitializing" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
              <div class="text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-white mb-4"></i>
                <p class="text-white text-lg">Loading Murajah...</p>
              </div>
            </div>

            <!-- Header -->
            <header class="bg-white shadow">
              <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <img src="./resources/logo-bg.png" alt="Murajah" class="h-25 w-auto" style="border-radius: 15%;">
                </div>
                <nav class="flex items-center gap-6">
                  <a href="./index.html#quran-text-section" class="text-gray-700  hover:text-blue-600  font-medium transition-colors">Memorize</a>
                  <a href="./quiz.html" class="text-gray-700  hover:text-blue-600  font-medium transition-colors">Quiz</a>
                </nav>
                <div class="flex items-center gap-4">
 
                  
                  <button @click="showSettingsModal = true" class="p-2 hover:bg-gray-100  rounded-lg transition-colors" title="Settings">
                    <i class="fas fa-cog text-gray-700  text-xl"></i>
                  </button>
                </div>
              </div>
            </header>

            <!-- Main Content -->
            <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
              <!-- Daily Revision Banner -->
              <div v-if="memorizedStore.memorizedPages.size > 0" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg shadow-lg p-6 flex items-center justify-between">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2 flex items-center gap-2">
                    <i class="fas fa-calendar-check"></i>
                    Daily Revision
                  </h3>
                  <p class="text-sm opacity-90">Revise pages from your memorized collection today</p>
                </div>
                <button 
                  @click="selectRandomPage" 
                  class="ml-4 px-6 py-3 bg-white text-green-600 font-bold rounded-lg hover:bg-gray-100 transition-colors whitespace-nowrap flex items-center gap-2"
                >
                  <i class="fas fa-random"></i>
                  Random Page
                </button>
              </div>

              <!-- Daily Goals Card -->
              <div class="bg-gradient-to-br from-amber-50 to-orange-50   rounded-lg shadow-lg p-6 border-2 border-amber-200  space-y-6">
                <div v-if="!dailyGoalsStore.todayGoal" class="text-center py-8">
                  <i class="fas fa-spinner fa-spin text-3xl text-amber-500 mb-3"></i>
                  <p class="text-gray-600 ">Loading daily goals...</p>
                </div>
                <template v-else>
                <!-- Header with Streak Badge -->
                <div class="flex items-center justify-between">
                  <div>
                    <h2 class="text-2xl font-bold text-gray-900  flex items-center gap-3">
                      <i class="fas fa-target text-amber-500"></i>
                      Today's Goals
                    </h2>
                    <p class="text-sm text-gray-600  mt-1">{{ new Date(dailyGoalsStore.todayGoal.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) }}</p>
                  </div>
                  
                  <!-- Streak Badge -->
                  <div class="flex flex-col items-center gap-2">
                    <div class="bg-gradient-to-br from-red-500 to-orange-600 text-white rounded-full px-6 py-4 shadow-lg flex flex-col items-center min-w-[120px]">
                      <div class="flex items-center gap-1 text-3xl font-bold">
                        <i class="fas fa-fire"></i>
                        {{ dailyGoalsStore.streak }}
                      </div>
                      <p class="text-xs font-semibold mt-1">DAY STREAK</p>
                    </div>
                    <p class="text-xs text-gray-600 ">Best: {{ dailyGoalsStore.longestStreak }}</p>
                  </div>
                </div>

                <!-- Progress Ring and Task Count -->
                <div class="flex items-center gap-8">
                  <!-- Progress Bar and Stats -->
                  <div class="flex-shrink-0 text-center">
                    <div class="mb-4">
                      <div class="text-4xl font-bold text-amber-600 ">{{ getTaskProgressPercentage() }}%</div>
                      <div class="text-sm text-gray-600  mt-1">{{ Object.values(dailyGoalsStore.todayGoal.tasks).filter(t => t.completed).length }}/{{ Object.keys(dailyGoalsStore.todayGoal.tasks).length }} tasks</div>
                    </div>
                    <!-- Simple progress bar -->
                    <div class="w-24 h-3 bg-gray-300  rounded-full overflow-hidden">
                      <div 
                        class="h-full bg-gradient-to-r from-amber-400 to-orange-500 transition-all duration-300"
                        :style="{ width: getTaskProgressPercentage() + '%' }"
                      ></div>
                    </div>
                  </div>

                  <!-- Tasks List -->
                  <div class="flex-1 space-y-3">
                    <div v-for="(task, taskName) in dailyGoalsStore.todayGoal.tasks" :key="taskName" class="flex items-start gap-3 p-3 bg-white  rounded-lg hover:shadow-md transition-shadow">
                      <!-- Checkbox -->
                      <button 
                        @click="task.completed ? uncompleteTaskGoal(taskName) : completeTaskGoal(taskName)"
                        :class="[
                          'flex-shrink-0 w-6 h-6 rounded border-2 flex items-center justify-center transition-all mt-0.5',
                          task.completed 
                            ? 'bg-green-500 border-green-500' 
                            : 'border-gray-300  hover:border-green-400'
                        ]"
                      >
                        <i v-if="task.completed" class="fas fa-check text-white text-sm"></i>
                      </button>

                      <!-- Task Info -->
                      <div class="flex-1 min-w-0">
                        <h4 :class="['font-semibold text-gray-900  transition-all', task.completed && 'line-through text-gray-500'] ">
                          {{ task.name }}
                        </h4>
                        <p class="text-sm text-gray-600  mt-0.5">{{ task.description }}</p>
                        
                        <!-- Task-specific details -->
                        <div v-if="taskName === 'reviewRange' && task.pages" class="mt-2 text-xs text-gray-700  bg-blue-50  p-2 rounded">
                          <i class="fas fa-book-open"></i> Pages: {{ task.pages.join(', ') }} ({{ task.pages.length }} pages)
                        </div>
                        <div v-if="taskName === 'memorizeDaily'" class="mt-2 text-xs text-gray-700  bg-purple-50  p-2 rounded">
                          <i class="fas fa-target"></i> Target: {{ task.targetPages }} page{{ task.targetPages !== 1 ? 's' : '' }} today
                        </div>
                      </div>

                      <!-- Completion indicator -->
                      <div v-if="task.completed" class="flex-shrink-0">
                        <p class="text-xs text-green-600  font-semibold">
                          <i class="fas fa-check-circle"></i> Done
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Motivational Message -->
                <div v-if="getTaskProgressPercentage() === 100" class="bg-green-100  border-l-4 border-green-500 p-4 rounded">
                  <p class="text-green-800  font-semibold flex items-center gap-2">
                    <i class="fas fa-star text-yellow-400"></i>
                    Excellent! You've completed all today's goals! Keep up the amazing work! 🎉
                  </p>
                </div>

                <div v-else-if="getTaskProgressPercentage() >= 50" class="bg-blue-100  border-l-4 border-blue-500 p-4 rounded">
                  <p class="text-blue-800  font-semibold flex items-center gap-2">
                    <i class="fas fa-arrow-up text-blue-500"></i>
                    Great progress! Complete {{ Object.keys(dailyGoalsStore.todayGoal.tasks).length - Object.values(dailyGoalsStore.todayGoal.tasks).filter(t => t.completed).length }} more task{{ Object.keys(dailyGoalsStore.todayGoal.tasks).length - Object.values(dailyGoalsStore.todayGoal.tasks).filter(t => t.completed).length !== 1 ? 's' : '' }}.
                  </p>
                </div>
                </template>
              </div>

              <!-- Status Indicators Row -->
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-blue-500 text-white p-6 rounded-lg shadow">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm opacity-90">Memorized</p>
                      <p class="text-3xl font-bold">{{ statistics.memorized }} <i class="fas fa-file-alt text-2xl"></i></p>
                      <p class="text-xs opacity-75">{{ statistics.percentage }}%</p>
                    </div>
                    <i class="fas fa-bookmark text-4xl opacity-30"></i>
                  </div>
                </div>

                <div class="bg-purple-500 text-white p-6 rounded-lg shadow">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm opacity-90">Perfect Revisions</p>
                      <p class="text-3xl font-bold">{{ statistics.perfectRevisions }}</p>
                      <p class="text-xs opacity-75">Avg: {{ statistics.averagePerfect }}/page</p>
                    </div>
                    <i class="fas fa-star text-4xl opacity-30"></i>
                  </div>
                </div>

                <div class="bg-red-500 text-white p-6 rounded-lg shadow">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm opacity-90">Mistakes</p>
                      <p class="text-3xl font-bold">{{ statistics.mistakes }}</p>
                      <p class="text-xs opacity-75">Word-level</p>
                    </div>
                    <i class="fas fa-exclamation-circle text-4xl opacity-30"></i>
                  </div>
                </div>

                <div class="bg-green-500 text-white p-6 rounded-lg shadow">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm opacity-90">Recordings</p>
                      <p class="text-3xl font-bold">{{ statistics.audios }}</p>
                      <p class="text-xs opacity-75">Audio practice</p>
                    </div>
                    <i class="fas fa-microphone text-4xl opacity-30"></i>
                  </div>
                </div>
              </div>

              <!-- Progress Section -->
              <div class="bg-white  rounded-lg shadow-lg p-6 space-y-4">
                <div class="flex items-center justify-between">
                  <h2 class="text-2xl font-bold text-gray-900 ">Progress</h2>
                  <span class="text-sm text-gray-600 ">{{ statistics.memorized }}/604 Pages</span>
                </div>

                <div class="space-y-2">
                  <div class="progress-bar">
                    <div class="progress-fill" :style="{ width: statistics.percentage + '%' }"></div>
                  </div>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
                  <div>
                    <p class="text-gray-600 ">Remaining</p>
                    <p class="text-xl font-bold">{{ statistics.remaining }}</p>
                  </div>
                  <div>
                    <p class="text-gray-600 ">Juzs (Parts)</p>
                    <p class="text-xl font-bold">{{ statistics.juzCount }}/30</p>
                  </div>
                  <div>
                    <p class="text-gray-600 ">Est. Completion</p>
                    <p class="text-sm font-bold">{{ formattedCompletion }}</p>
                  </div>
                </div>
              </div>

              <!-- Quran Text Display with Overlay Navigation -->
              <div id="quran-text-section" class="bg-white  rounded-lg shadow-lg p-8 space-y-6 border-2 border-blue-200  relative group">
                <div class="text-center space-y-2">
                  <p class="text-sm font-medium text-gray-600 ">Page {{ appStore.currentPage }} of 604</p>
                  <h2 class="text-3xl font-bold text-blue-600 " style="font-family: 'SurahNames', 'Traditional Arabic', serif;">{{ currentSurahName }}</h2>
                </div>

                <!-- Quran Text Content - Word by Word Display -->
                <div v-if="quranData && currentPageWords.length > 0" :style="fontSizeStyle" class="quran-text text-center p-8 rounded-lg min-h-96 overflow-y-auto space-y-4 relative">
                  <!-- Hifz Status Bookmark -->
                  <div v-if="currentPageHifzStatus" class="absolute top-0 right-0 -mr-1" style="width: 60px; height: 100px;">
                    <svg viewBox="0 0 60 100" class="w-full h-full drop-shadow-lg" style="filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1)); opacity:60%;">
                      <!-- Bookmark shape -->
                      <defs>
                        <linearGradient id="bookmarkGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" :style="{ stopColor: currentPageHifzStatus.bg, stopOpacity: 1 }" />
                          <stop offset="100%" :style="{ stopColor: currentPageHifzStatus.bg, stopOpacity: 0.85 }" />
                        </linearGradient>
                      </defs>
                      <path d="M 0 0 L 60 0 L 60 75 L 30 60 L 0 75 Z" fill="url(#bookmarkGradient)" stroke="rgba(0,0,0,0.1)" stroke-width="1"/>
                      <!-- Icon in center -->
                      <g transform="translate(30, 20)">
                        <circle cx="0" cy="0" r="16" fill="white" opacity="0.75"/>
                        <text x="0" y="0" text-anchor="middle" dominant-baseline="middle" class="text-lg font-bold" fill="currentColor" :style="{ fill: currentPageHifzStatus.bg, fontSize: '20px' }">
                          <tspan v-if="currentPageHifzStatus.icon === 'la-star'">★</tspan>
                          <tspan v-else-if="currentPageHifzStatus.icon === 'la-check-circle'">✓</tspan>
                          <tspan v-else-if="currentPageHifzStatus.icon === 'la-thumbs-up'">👍</tspan>
                          <tspan v-else-if="currentPageHifzStatus.icon === 'la-exclamation-circle'">!</tspan>
                          <tspan v-else-if="currentPageHifzStatus.icon === 'la-exclamation-triangle'">⚠</tspan>
                          <tspan v-else>📌</tspan>
                        </text>
                      </g>
                      <!-- Score label -->
                      <text x="30" y="55" text-anchor="middle" font-size="10" font-weight="bold" fill="white">
                        {{ currentPageHifzStatus.label }}
                      </text>
                    </svg>
                  </div>

                  <!-- Mistakes Counter Badge -->
                  <div v-if="currentPageMistakeCount > 0" class="absolute top-2 left-7 text-red-500 font-bold text-2xl" style="opacity: 0.4;" title="Number of mistakes on this page">
                    {{ currentPageMistakeCount }}
                  </div>

                  <div v-for="(line, lineIdx) in currentPageWords" :key="lineIdx" class="flex flex-wrap justify-center gap-2">
                    <!-- Surah Name Display -->
                    <div v-if="line.type === 'surah_name'" class="w-full text-4xl font-black text-black  my-4 text-center" style="font-family: 'SurahNames', 'Traditional Arabic', serif;">
                      {{ getSurahNameArabic(parseInt(line.text.replace('Surah ', ''))) }}
                      <div v-if="parseInt(line.text.replace('Surah ', '')) !== 9" class="text-4xl mt-2">﷽</div>
                    </div>
                    
                    <!-- Words Display -->
                    <span 
                      v-for="word in line.words" 
                      :key="word.id"
                      @click="highlightWord(word)"
                      @mouseenter="showWordTooltip(word, $event)"
                      @mousemove="updateTooltipPosition($event)"
                      @mouseleave="hideWordTooltip()"
                      :class="{
                        'bg-blue-100  rounded-md px-2 py-1': hoveredWordId === word.id,
                        'bg-red-200 ': currentPageMistakes.includes(word.id),
                        'cursor-pointer transition-all duration-200': true
                      }"
                       class="quran-word inline-block"
                    >
                      {{ word.text }}
                    </span>
                  </div>
                </div>

                <!-- Empty State -->
                <div v-else class="flex flex-col items-center justify-center p-12 bg-gray-100  rounded-lg">
                  <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                  <p class="text-gray-600 ">Loading Quran text...</p>
                </div>

                <!-- Overlay Navigation Arrows (Hidden by default, visible on hover) -->
                <div class="absolute inset-0 flex items-center justify-between px-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none rounded-lg">
                  <!-- Previous Page Arrow -->
                  <button 
                    v-if="appStore.currentPage > 1"
                    @click="previousPage" 
                    class="p-3 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg transition-all pointer-events-auto"
                    style="opacity: 0.75;"
                    :title="'Previous Page (' + (appStore.currentPage - 1) + ')'"
                  >
                    <i class="fas fa-chevron-left text-2xl"></i>
                  </button>
                  <div v-else class="w-12"></div>

                  <!-- Next Page Arrow -->
                  <button 
                    v-if="appStore.currentPage < appStore.totalPages"
                    @click="nextPage" 
                    class="p-3 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg transition-all pointer-events-auto"
                    style="opacity: 0.75;"
                    :title="'Next Page (' + (appStore.currentPage + 1) + ')'"
                  >
                    <i class="fas fa-chevron-right text-2xl"></i>
                  </button>
                  <div v-else class="w-12"></div>
                </div>
              </div>

                <!-- Page Navigation -->
              <div class="bg-white  rounded-lg shadow-lg p-4 space-y-3">
                <!-- Navigation Controls -->
                <div class="flex items-center justify-center gap-2 flex-wrap">
                  <button @click="previousPage" :disabled="appStore.currentPage === 1" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all" title="Previous page">
                    <i class="fas fa-chevron-left"></i>
                  </button>

                  <div class="flex items-center gap-2 bg-gray-100  px-3 py-2 rounded-lg text-gray-900 ">
                    <span class="text-xl font-bold">{{ appStore.currentPage }}</span>
                    <span class="text-gray-600 ">/604</span>
                  </div>

                  <input v-model.number="gotoInput" @keyup.enter="gotoPage" type="number" min="1" max="604" class="w-16 px-2 py-2 border border-gray-300  rounded-lg    text-center text-sm" placeholder="Go">
                  <button @click="gotoPage" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">Go</button>

                  <!-- Surah Navigator -->
                  <select @change="(e) => { if (e.target.value) { goToPageNumber(getSurahStartPage(parseInt(e.target.value))); e.target.value = ''; } }" class="px-3 py-2 bg-white  border border-gray-300  rounded-lg text-gray-900  text-sm hover:border-blue-500  transition-colors cursor-pointer" title="Jump to Surah">
                    <option value="">📖 Surahs (114)</option>
                    <option value="1">1. الفاتحة</option>
                    <option value="2">2. البقرة</option>
                    <option value="3">3. آل عمران</option>
                    <option value="4">4. النساء</option>
                    <option value="5">5. المائدة</option>
                    <option value="6">6. الأنعام</option>
                    <option value="7">7. الأعراف</option>
                    <option value="8">8. الأنفال</option>
                    <option value="9">9. التوبة</option>
                    <option value="10">10. يونس</option>
                    <option value="11">11. هود</option>
                    <option value="12">12. يوسف</option>
                    <option value="13">13. الرعد</option>
                    <option value="14">14. إبراهيم</option>
                    <option value="15">15. الحجر</option>
                    <option value="16">16. النحل</option>
                    <option value="17">17. الإسراء</option>
                    <option value="18">18. الكهف</option>
                    <option value="19">19. مريم</option>
                    <option value="20">20. طه</option>
                    <option value="21">21. الأنبياء</option>
                    <option value="22">22. الحج</option>
                    <option value="23">23. المؤمنون</option>
                    <option value="24">24. النور</option>
                    <option value="25">25. الفرقان</option>
                    <option value="26">26. الشعراء</option>
                    <option value="27">27. النمل</option>
                    <option value="28">28. القصص</option>
                    <option value="29">29. العنكبوت</option>
                    <option value="30">30. الروم</option>
                    <option value="31">31. لقمان</option>
                    <option value="32">32. السجدة</option>
                    <option value="33">33. الأحزاب</option>
                    <option value="34">34. سبإ</option>
                    <option value="35">35. فاطر</option>
                    <option value="36">36. يس</option>
                    <option value="37">37. الصافات</option>
                    <option value="38">38. ص</option>
                    <option value="39">39. الزمر</option>
                    <option value="40">40. غافر</option>
                    <option value="41">41. فصلت</option>
                    <option value="42">42. الشورى</option>
                    <option value="43">43. الزخرف</option>
                    <option value="44">44. الدخان</option>
                    <option value="45">45. الجاثية</option>
                    <option value="46">46. الأحقاف</option>
                    <option value="47">47. محمد</option>
                    <option value="48">48. الفتح</option>
                    <option value="49">49. الحجرات</option>
                    <option value="50">50. ق</option>
                    <option value="51">51. الذاريات</option>
                    <option value="52">52. الطور</option>
                    <option value="53">53. النجم</option>
                    <option value="54">54. القمر</option>
                    <option value="55">55. الرحمن</option>
                    <option value="56">56. الواقعة</option>
                    <option value="57">57. الحديد</option>
                    <option value="58">58. المجادلة</option>
                    <option value="59">59. الحشر</option>
                    <option value="60">60. الممتحنة</option>
                    <option value="61">61. الصف</option>
                    <option value="62">62. الجمعة</option>
                    <option value="63">63. المنافقون</option>
                    <option value="64">64. التغابن</option>
                    <option value="65">65. الطلاق</option>
                    <option value="66">66. التحريم</option>
                    <option value="67">67. الملك</option>
                    <option value="68">68. القلم</option>
                    <option value="69">69. الحاقة</option>
                    <option value="70">70. المعارج</option>
                    <option value="71">71. نوح</option>
                    <option value="72">72. الجن</option>
                    <option value="73">73. المزمل</option>
                    <option value="74">74. المدثر</option>
                    <option value="75">75. القيامة</option>
                    <option value="76">76. الإنسان</option>
                    <option value="77">77. المرسلات</option>
                    <option value="78">78. النبأ</option>
                    <option value="79">79. النازعات</option>
                    <option value="80">80. عبس</option>
                    <option value="81">81. التكوير</option>
                    <option value="82">82. الإنفطار</option>
                    <option value="83">83. المطففين</option>
                    <option value="84">84. الإنشقاق</option>
                    <option value="85">85. البروج</option>
                    <option value="86">86. الطارق</option>
                    <option value="87">87. الأعلى</option>
                    <option value="88">88. الغاشية</option>
                    <option value="89">89. الفجر</option>
                    <option value="90">90. البلد</option>
                    <option value="91">91. الشمس</option>
                    <option value="92">92. الليل</option>
                    <option value="93">93. الضحى</option>
                    <option value="94">94. الشرح</option>
                    <option value="95">95. التين</option>
                    <option value="96">96. العلق</option>
                    <option value="97">97. القدر</option>
                    <option value="98">98. البينة</option>
                    <option value="99">99. الزلزلة</option>
                    <option value="100">100. العاديات</option>
                    <option value="101">101. القارعة</option>
                    <option value="102">102. التكاثر</option>
                    <option value="103">103. العصر</option>
                    <option value="104">104. الهمزة</option>
                    <option value="105">105. الفيل</option>
                    <option value="106">106. قريش</option>
                    <option value="107">107. الماعون</option>
                    <option value="108">108. الكوثر</option>
                    <option value="109">109. الكافرون</option>
                    <option value="110">110. النصر</option>
                    <option value="111">111. المسد</option>
                    <option value="112">112. الإخلاص</option>
                    <option value="113">113. الفلق</option>
                    <option value="114">114. الناس</option>
                  </select>

                  <button @click="nextPage" :disabled="appStore.currentPage === 604" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all" title="Next page">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>                <!-- Action Buttons -->
                <div class="flex items-center gap-2 flex-wrap justify-center">
                  <button @click="toggleMemorized" :class="isCurrentPageMemorized ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-400 hover:bg-gray-500'" class="flex items-center gap-1 px-3 py-2 text-white rounded-lg transition-colors text-sm">
                    <i :class="isCurrentPageMemorized ? 'fas fa-check-circle' : 'fas fa-circle'"></i>
                    <span>{{ isCurrentPageMemorized ? 'Memorized' : 'Memorize' }}</span>
                  </button>

                  <button @click="incrementPerfectRevision(appStore.currentPage)" class="flex items-center gap-1 px-3 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors text-sm">
                    <i class="fas fa-star"></i>
                    <span>Perfect</span>
                    <span v-if="currentPagePerfectCount > 0" class="font-bold">({{ currentPagePerfectCount }})</span>
                  </button>

                  <button v-if="AudioRecorder.isSupported() && !audioStore.isRecording" @click="startRecording" class="flex items-center gap-1 px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors text-sm">
                    <i class="fas fa-microphone"></i>
                    <span>Record</span>
                  </button>
                </div>

                <!-- Recording Status -->
                <div v-if="audioStore.isRecording" class="flex items-center gap-3 p-3 bg-red-100  rounded-lg border-2 border-red-500">
                  <div class="flex-1">
                    <p class="font-bold text-red-700  text-sm">Recording...</p>
                    <p class="text-xs text-red-600 ">{{ recordingDuration }}</p>
                  </div>
                  <button @click="stopRecording" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm transition-colors">
                    <i class="fas fa-stop"></i>
                  </button>
                  <button @click="cancelRecording" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded text-sm transition-colors">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>

              <!-- Dashboard Stats Grid -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Recent Recordings -->
                <div class="bg-white  rounded-lg shadow-lg p-6 space-y-4">
                  <h3 class="text-xl font-bold flex items-center gap-2 text-gray-900 ">
                    <i class="fas fa-microphone text-blue-600 "></i>
                    Recent Recordings
                  </h3>
                  <div v-if="statistics.audios > 0" class="space-y-3 max-h-48 overflow-y-auto">
                    <div v-for="(recording, idx) in recentRecordings" :key="idx" class="p-3 bg-gray-100  rounded-lg flex items-center justify-between gap-3">
                      <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-900 ">Page {{ recording.pageNumber }}</p>
                        <p class="text-xs text-gray-600 ">{{ recording.recordedAt }}</p>
                        <p class="text-xs text-gray-600 " v-if="recording.duration">Duration: {{ formatAudioDuration(recording.duration) }}</p>
                      </div>
                      <div class="flex items-center gap-2">
                        <button @click="playAudio(recording)" class="p-2 hover:bg-blue-600 hover:text-white rounded-lg transition-colors text-gray-600  " :title="'Play recording for page ' + recording.pageNumber">
                          <i class="fas fa-play"></i>
                        </button>
                        <button @click="deleteAudio(idx)" class="p-2 hover:bg-red-600 hover:text-white rounded-lg transition-colors text-gray-600  " :title="'Delete recording for page ' + recording.pageNumber">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <div v-else class="text-gray-600  text-sm">
                    <i class="fas fa-circle-info mr-2"></i> No recordings yet
                  </div>
                </div>

                <!-- Summary Statistics -->
                <div class="bg-white  rounded-lg shadow-lg p-6 space-y-4">
                  <h3 class="text-xl font-bold flex items-center gap-2 text-gray-900 ">
                    <i class="fas fa-chart-bar text-blue-600 "></i>
                    Summary Statistics
                  </h3>
                  <div class="grid grid-cols-2 gap-3">
                    <div class="p-3 bg-gradient-to-br from-blue-50 to-blue-100   rounded-lg">
                      <p class="text-xs text-gray-600 ">Memorized</p>
                      <p class="text-2xl font-bold text-blue-600 ">{{ statistics.memorized }}</p>
                      <p class="text-xs text-gray-500 ">of 604</p>
                    </div>
                    <div class="p-3 bg-gradient-to-br from-purple-50 to-purple-100   rounded-lg">
                      <p class="text-xs text-gray-600 ">Juzs</p>
                      <p class="text-2xl font-bold text-purple-600 ">{{ statistics.juzCount }}</p>
                      <p class="text-xs text-gray-500 ">of 30</p>
                    </div>
                    <div class="p-3 bg-gradient-to-br from-green-50 to-green-100   rounded-lg">
                      <p class="text-xs text-gray-600 ">Completion</p>
                      <p class="text-2xl font-bold text-green-600 ">{{ statistics.percentage }}%</p>
                    </div>
                    <div class="p-3 bg-gradient-to-br from-orange-50 to-orange-100   rounded-lg">
                      <p class="text-xs text-gray-600 ">Points</p>
                      <p class="text-2xl font-bold text-orange-600 ">{{ statistics.totalPoints }}</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Mistake Bubble Grid -->
              <div v-if="currentPageMistakeCount > 0" class="bg-white  rounded-lg shadow-lg p-6 space-y-4">
                <h3 class="text-xl font-bold flex items-center gap-2 text-gray-900 ">
                  <i class="fas fa-exclamation-circle text-red-600 "></i>
                  Mistakes on Page {{ appStore.currentPage }}
                </h3>
                <p class="text-sm text-gray-600 ">{{ currentPageMistakeCount }} mistake(s) found</p>
                
                <!-- Mistake Bubbles Grid -->
                <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-2">
                  <button 
                    v-for="wordId in currentPageMistakes" 
                    :key="wordId"
                    @click="highlightWord({ id: wordId })"
                    class="p-3 rounded-full bg-red-200  text-red-700  font-bold text-sm hover:bg-red-300  transition-colors text-center border border-red-300 "
                    :title="'Mistake: Word ' + wordId"
                  >
                    {{ wordId }}
                  </button>
                </div>
                
                <button 
                  @click="clearPageMistakes"
                  class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                >
                  Clear All Mistakes
                </button>
              </div>

              <!-- Advanced Analytics Section -->
              <div class="bg-white  rounded-lg shadow-lg p-6 space-y-6">
                <h2 class="text-2xl font-bold flex items-center gap-2 text-gray-900 ">
                  <i class="fas fa-chart-pie text-purple-600 "></i>
                  Analytics & Progress
                </h2>

                <!-- Juz Progress Grid -->
                <div>
                  <h3 class="text-lg font-bold mb-4 text-gray-900 ">Progress by Juz</h3>
                  <div class="grid grid-cols-5 sm:grid-cols-10 gap-2">
                    <button 
                      v-for="juzNum in 30" 
                      :key="juzNum"
                      @click="goToPageNumber(getJuzRange(juzNum)[0])"
                      :class="[
                        'px-3 py-2 rounded-lg font-bold text-sm transition-colors',
                        juzMemorizedCount(juzNum) === (getJuzRange(juzNum)[1] - getJuzRange(juzNum)[0] + 1)
                          ? 'bg-green-500 text-white hover:bg-green-600' 
                          : juzMemorizedCount(juzNum) > 0
                            ? 'text-gray-900 hover:opacity-90'
                            : 'bg-gray-200  text-gray-700  hover:bg-gray-300 '
                      ]"
                      :style="juzMemorizedCount(juzNum) > 0 && juzMemorizedCount(juzNum) < (getJuzRange(juzNum)[1] - getJuzRange(juzNum)[0] + 1) ? getJuzGradientStyle(juzNum) : {}"
                      :title="'Juz ' + juzNum + ': ' + juzMemorizedCount(juzNum) + '/' + (getJuzRange(juzNum)[1] - getJuzRange(juzNum)[0] + 1) + ' pages'"
                    >
                      {{ juzNum }}
                    </button>
                  </div>
                  <p class="text-sm mt-3 flex items-center justify-center gap-4 flex-wrap text-gray-700 ">
                    <span><span class="text-green-600  font-semibold">Completed</span></span>|
                    <span><span class="text-yellow-500  font-semibold">Partial</span></span>|
                    <span><span class="text-gray-400  font-semibold">Not started</span></span>
                  </p>
                </div>

                <!-- Completion Estimate -->
                <div class="border-t border-gray-300  pt-6">
                  <h3 class="text-lg font-bold mb-4 text-gray-900 ">Completion Estimate</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-blue-50  rounded-lg border border-blue-200 ">
                      <p class="text-sm text-gray-600 ">Estimated Completion Date</p>
                      <p class="text-2xl font-bold text-blue-600 ">{{ formattedCompletion }}</p>
                    </div>
                    <div class="p-4 bg-purple-50  rounded-lg border border-purple-200 ">
                      <p class="text-sm text-gray-600 ">Days Remaining</p>
                      <p class="text-2xl font-bold text-purple-600 ">{{ daysRemaining }}</p>
                    </div>
                  </div>
                  <div class="mt-4 p-4 bg-gray-100  rounded-lg text-gray-700  text-sm border border-gray-300 ">
                    <p>
                      Based on {{ settingsStore.pagesPerDay }} page(s) per day, you will complete memorization in approximately {{ daysRemaining }} days.
                    </p>
                  </div>
                </div>
              </div>

            <!-- Settings Modal -->
            <div v-if="showSettingsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
              <div class="bg-white  rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <!-- Modal Header -->
                <div class="sticky top-0 bg-white  border-b border-gray-200  px-6 py-4 flex items-center justify-between">
                  <h2 class="text-2xl font-bold text-gray-900  flex items-center gap-2">
                    <i class="fas fa-cog"></i>
                    Settings
                  </h2>
                  <button @click="showSettingsModal = false" class="text-gray-500  hover:text-gray-700  transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                  </button>
                </div>

                <!-- Modal Content -->
                <div class="px-6 py-6 space-y-6">
                  <!-- General Settings -->
                  <div class="space-y-4">
                    <h3 class="text-lg font-bold text-gray-900  flex items-center gap-2">
                      <i class="fas fa-sliders-h text-blue-600"></i>
                      General Settings
                    </h3>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium mb-2 text-gray-700 ">Pages Per Day</label>
                        <input v-model.number="settingsStore.pagesPerDay" @change="updateSettings" type="number" min="1" max="604" class="w-full px-4 py-2 border border-gray-300  rounded-lg   ">
                      </div>

                      <div>
                        <label class="block text-sm font-medium mb-2 text-gray-700 ">Finish in (days)</label>
                        <input v-model.number="settingsStore.finishRevisionDays" @change="updateSettings" type="number" min="1" max="365" class="w-full px-4 py-2 border border-gray-300  rounded-lg   ">
                      </div>

                      <div>
                        <label class="block text-sm font-medium mb-2 text-gray-700 ">Font Size</label>
                        <select v-model="settingsStore.fontSize" @change="updateSettings" class="w-full px-4 py-2 border border-gray-300  rounded-lg  ">
                          <option value="small">Small</option>
                          <option value="medium">Medium</option>
                          <option value="large">Large</option>
                        </select>
                      </div>

                      <div class="flex items-center">
                        <input v-model="settingsStore.tajweedEnabled" @change="updateSettings" type="checkbox" id="tajweed" class="rounded  ">
                        <label for="tajweed" class="ml-3 text-sm font-medium text-gray-700 ">Enable Tajweed Colors</label>
                      </div>
                    </div>
                  </div>

                  <!-- Daily Goals Settings -->
                  <div class="border-t border-gray-300  pt-6 space-y-4">
                    <h3 class="text-lg font-bold text-gray-900  flex items-center gap-2">
                      <i class="fas fa-fire text-orange-500"></i>
                      Daily Goals
                    </h3>
                    
                    <!-- Streak Info -->
                    <div class="p-4 bg-amber-50  rounded-lg border-l-4 border-amber-500 space-y-2">
                      <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold text-gray-700 ">Current Streak</span>
                        <span class="text-2xl font-bold text-orange-600 ">
                          <i class="fas fa-fire"></i>
                          {{ dailyGoalsStore.streak }} days
                        </span>
                      </div>
                      <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold text-gray-700 ">Best Streak</span>
                        <span class="text-lg font-bold text-orange-500">{{ dailyGoalsStore.longestStreak }} days</span>
                      </div>
                      <div v-if="dailyGoalsStore.todayGoal && Object.values(dailyGoalsStore.todayGoal.tasks).some(t => t.completed)" class="flex items-center gap-2 text-green-700  text-sm font-semibold mt-2">
                        <i class="fas fa-check-circle"></i>
                        Tasks completed today: {{ Object.values(dailyGoalsStore.todayGoal.tasks).filter(t => t.completed).length }}/{{ Object.keys(dailyGoalsStore.todayGoal.tasks).length }}
                      </div>
                    </div>

                    <!-- Task Selection -->
                    <div>
                      <label class="block text-sm font-semibold text-gray-700  mb-3">Select which tasks count towards your streak:</label>
                      <div class="space-y-2">
                        <div class="flex items-center">
                          <input 
                            v-model="dailyGoalsStore.selectedTasks"
                            @change="updateSettings"
                            type="checkbox" 
                            value="recordRandomPage" 
                            id="task-record"
                            class="rounded  "
                          >
                          <label for="task-record" class="ml-3 text-sm text-gray-700  flex items-center gap-2">
                            <i class="fas fa-microphone text-red-500"></i>
                            Record Random Page
                          </label>
                        </div>

                        <div class="flex items-center">
                          <input 
                            v-model="dailyGoalsStore.selectedTasks"
                            @change="updateSettings"
                            type="checkbox" 
                            value="reviewRange" 
                            id="task-review"
                            class="rounded  "
                          >
                          <label for="task-review" class="ml-3 text-sm text-gray-700  flex items-center gap-2">
                            <i class="fas fa-book-open text-blue-500"></i>
                            Review Range
                          </label>
                        </div>

                        <div class="flex items-center">
                          <input 
                            v-model="dailyGoalsStore.selectedTasks"
                            @change="updateSettings"
                            type="checkbox" 
                            value="memorizeDaily" 
                            id="task-memorize"
                            class="rounded  "
                          >
                          <label for="task-memorize" class="ml-3 text-sm text-gray-700  flex items-center gap-2">
                            <i class="fas fa-quran text-purple-500"></i>
                            Memorize Daily
                          </label>
                        </div>

                        <div class="flex items-center">
                          <input 
                            v-model="dailyGoalsStore.selectedTasks"
                            @change="updateSettings"
                            type="checkbox" 
                            value="reciteAyahs" 
                            id="task-recite"
                            class="rounded  "
                          >
                          <label for="task-recite" class="ml-3 text-sm text-gray-700  flex items-center gap-2">
                            <i class="fas fa-volume-up text-green-500"></i>
                            Recite 10 Ayahs
                          </label>
                        </div>
                      </div>
                    </div>

                    <!-- Streak Info Note -->
                    <div class="p-3 bg-blue-50  rounded-lg text-sm text-blue-800 ">
                      <i class="fas fa-info-circle mr-2"></i>
                      Streak breaks when no selected tasks are completed in a day. At least one completed task keeps the streak alive.
                    </div>
                  </div>

                  <!-- Data Management Section -->
                  <div class="border-t border-gray-300  pt-6 space-y-4">
                    <h3 class="text-lg font-bold text-gray-900  flex items-center gap-2">
                      <i class="fas fa-database text-green-600"></i>
                      Data Management
                    </h3>
                    
                    <div class="flex gap-3 flex-wrap">
                      <button @click="exportData" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                        <i class="fas fa-download"></i>
                        <span>Export Data</span>
                      </button>

                      <button @click="importData" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        <i class="fas fa-upload"></i>
                        <span>Import Data</span>
                      </button>

                      <button @click="resetApp" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                        <i class="fas fa-redo"></i>
                        <span>Reset All</span>
                      </button>
                    </div>
                  </div>

                  <!-- Bulk Memorization Tool -->
                  <div class="border-t border-gray-300  pt-6 space-y-4">
                    <h3 class="text-lg font-bold text-gray-900  flex items-center gap-2">
                      <i class="fas fa-list-check text-purple-600"></i>
                      Bulk Memorization
                    </h3>
                    <p class="text-sm text-gray-600 ">Mark multiple pages as memorized at once</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                        <label class="block text-sm font-medium mb-2 text-gray-700 ">Start Page</label>
                        <input v-model.number="bulkStartPage" type="number" min="1" max="604" class="w-full px-3 py-2 border border-gray-300  rounded-lg   ">
                      </div>
                      <div>
                        <label class="block text-sm font-medium mb-2 text-gray-700 ">End Page</label>
                        <input v-model.number="bulkEndPage" type="number" min="1" max="604" class="w-full px-3 py-2 border border-gray-300  rounded-lg   ">
                      </div>
                      <div class="flex items-end">
                        <button 
                          @click="bulkMemorize"
                          class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center gap-2"
                        >
                          <i class="fas fa-check-double"></i>
                          <span>Memorize Range</span>
                        </button>
                      </div>
                    </div>

                    <div v-if="bulkWarning" class="p-3 bg-yellow-50  rounded-lg text-sm text-yellow-800  border border-yellow-200 ">
                      <i class="fas fa-exclamation-triangle mr-2"></i>
                      {{ bulkWarning }}
                    </div>
                  </div>
                </div>

                <!-- Modal Footer -->
                <div class="sticky bottom-0 bg-gray-50  border-t border-gray-200  px-6 py-4 flex justify-end">
                  <button @click="showSettingsModal = false" class="px-4 py-2 bg-gray-600  text-white  rounded-lg hover:bg-gray-700  transition-colors font-medium">
                    Close
                  </button>
                </div>
              </div>
            </div>

            <!-- Analytics Dashboard -->
            <div v-if="dailyGoalsStore.goalHistory.length > 0" class="bg-white  rounded-lg shadow-lg p-6">
              <h3 class="text-xl font-bold text-gray-900  flex items-center gap-2 mb-6">
                <i class="fas fa-chart-line text-blue-600"></i>
                Daily Goal Analytics
              </h3>

              <!-- Stats Grid -->
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <!-- Current Streak -->
                <div class="bg-gradient-to-br from-orange-50 to-orange-100   rounded-lg p-4 border border-orange-200 ">
                  <div class="text-sm font-medium text-orange-700  mb-1">Current Streak</div>
                  <div class="text-3xl font-bold text-orange-600  flex items-center gap-2">
                    <i class="fas fa-fire"></i>
                    {{ dailyGoalsStore.streak }}
                  </div>
                  <div class="text-xs text-orange-600  mt-2">{{ streakMessage }}</div>
                </div>

                <!-- Longest Streak -->
                <div class="bg-gradient-to-br from-purple-50 to-purple-100   rounded-lg p-4 border border-purple-200 ">
                  <div class="text-sm font-medium text-purple-700  mb-1">Longest Streak</div>
                  <div class="text-3xl font-bold text-purple-600  flex items-center gap-2">
                    <i class="fas fa-crown"></i>
                    {{ dailyGoalsStore.longestStreak }}
                  </div>
                  <div class="text-xs text-purple-600  mt-2">Personal best</div>
                </div>

                <!-- Completion Rate -->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100   rounded-lg p-4 border border-blue-200 ">
                  <div class="text-sm font-medium text-blue-700  mb-1">Completion Rate</div>
                  <div class="text-3xl font-bold text-blue-600 ">{{ completionRate }}%</div>
                  <div class="text-xs text-blue-600  mt-2">{{ completedDays }} of {{ totalDays }} days</div>
                </div>

                <!-- Total Completed -->
                <div class="bg-gradient-to-br from-green-50 to-green-100   rounded-lg p-4 border border-green-200 ">
                  <div class="text-sm font-medium text-green-700  mb-1">Days Completed</div>
                  <div class="text-3xl font-bold text-green-600  flex items-center gap-2">
                    <i class="fas fa-check-circle"></i>
                    {{ completedDays }}
                  </div>
                  <div class="text-xs text-green-600  mt-2">All goals achieved</div>
                </div>
              </div>

              <!-- Charts Section -->
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Completion Trend (Last 30 Days) -->
                <div class="bg-gray-50  rounded-lg p-4 border border-gray-200  ">
                  <h4 class="font-semibold text-gray-900  mb-4 flex items-center gap-2">
                    <i class="fas fa-trending-up text-green-600"></i>
                    Last 30 Days Trend
                  </h4>
                  <div class="h-32 flex items-end gap-1 justify-between px-2">
                    <div v-for="(status, index) in last30DaysTrend" :key="index" class="flex-1 flex flex-col items-center gap-1 group">
                      <div 
                        :class="[
                          'w-full rounded-t transition-all duration-200 hover:opacity-80',
                          status === 'complete' ? 'bg-green-500 h-20' : 
                          status === 'partial' ? 'bg-yellow-400 h-10' : 
                          'bg-gray-300  h-2'
                        ]"
                        :title="getTrendDayTooltip(index, status)"
                      >
                      </div>
                    </div>
                  </div>
                  <div class="text-xs text-gray-600  mt-4 text-center">Past 30 days completion status</div>
                </div>

                <!-- Completion Breakdown -->
                <div class="bg-gray-50  rounded-lg p-4 border border-gray-200  ">
                  <h4 class="font-semibold text-gray-900  mb-4 flex items-center gap-2">
                    <i class="fas fa-pie-chart text-blue-600"></i>
                    Overall Breakdown
                  </h4>
                  <div class="flex items-center justify-center gap-8">
                    <!-- Pie Chart representation with percentages -->
                    <div class="flex flex-col gap-3">
                      <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded bg-green-500"></div>
                        <div>
                          <div class="text-sm font-semibold text-gray-900  ">Completed</div>
                          <div class="text-xs text-gray-600  ">{{ completePercentage }}%</div>
                        </div>
                      </div>
                      <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded bg-yellow-400"></div>
                        <div>
                          <div class="text-sm font-semibold text-gray-900  ">Partial</div>
                          <div class="text-xs text-gray-600  ">{{ partialPercentage }}%</div>
                        </div>
                      </div>
                      <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded bg-gray-300  "></div>
                        <div>
                          <div class="text-sm font-semibold text-gray-900 ">None</div>
                          <div class="text-xs text-gray-600  ">{{ nonePercentage }}%</div>
                        </div>
                      </div>
                    </div>
                    <!-- Visual circle representation -->
                    <div class="w-32 h-32 rounded-full bg-gradient-conic from-green-500 via-yellow-400 to-gray-300  flex items-center justify-center">
                      <div class="w-28 h-28 rounded-full bg-white  flex items-center justify-center">
                        <div class="text-center">
                          <div class="text-lg font-bold text-gray-900  ">{{ completionRate }}%</div>
                          <div class="text-xs text-gray-600  ">Complete</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Recent Activity -->
              <div class="mt-6 border-t border-gray-200  pt-6">
                <h4 class="font-semibold text-gray-900  mb-4 flex items-center gap-2">
                  <i class="fas fa-history text-indigo-600"></i>
                  Recent Activity
                </h4>
                <div class="space-y-2 max-h-40 overflow-y-auto">
                  <div v-if="recentActivity.length === 0" class="text-sm text-gray-600  ">
                    No recent activity
                  </div>
                  <div v-for="(activity, index) in recentActivity.slice(0, 5)" :key="index" class="flex items-center gap-3 p-2 rounded bg-gray-100  text-sm">
                    <i :class="['fas', activity.icon, activity.color]"></i>
                    <div class="flex-1">
                      <div class="text-gray-900  ">{{ activity.text }}</div>
                      <div class="text-xs text-gray-600  ">{{ activity.date }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Daily Goals Contribution Graph (GitHub-style) -->
            <div v-if="dailyGoalsStore.goalHistory.length > 0" class="overflow-x-auto">
              <div class="bg-white  rounded-lg shadow-lg p-6 mb-12">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-xl font-bold text-gray-900  flex items-center gap-2">
                    <i class="fas fa-fire text-orange-500"></i>
                    Last 365 Days Goal Contribution Graph
                  </h3>
                  <div class="flex gap-3 text-xs">
                    <div class="flex items-center gap-1">
                      <div class="w-3 h-3 rounded-sm bg-gray-200  "></div>
                      <span class="text-gray-600  ">None</span>
                    </div>
                    <div class="flex items-center gap-1">
                      <div class="w-3 h-3 rounded-sm bg-yellow-300  "></div>
                      <span class="text-gray-600  ">Partial</span>
                    </div>
                    <div class="flex items-center gap-1">
                      <div class="w-3 h-3 rounded-sm bg-green-500"></div>
                      <span class="text-gray-600  ">Complete</span>
                    </div>
                  </div>
                </div>

                <!-- GitHub-style Contribution Graph -->
                <div class="">
                  <div class="inline-block p-2">
                    <!-- Month Labels Row -->
                    <div class="flex gap-0.5 mb-2 ml-6">
                      <div v-for="label in monthLabels" :key="label.name" :style="{ marginLeft: label.weekIndex === 0 ? '25px' : '50px' }" class="text-xs font-semibold text-gray-600  w-10">
                        {{ label.name }}
                      </div>
                    </div>

                    <!-- Day labels and contribution grid -->
                    <div class="flex gap-0.5">
                      <!-- Day of week labels (Sun-Sat) -->
                      <div class="flex flex-col gap-1 mr-0.5">
                        <div class="text-xs font-semibold text-gray-600  w-6 text-center mb-2">S</div>
                        <div class="text-xs font-semibold text-gray-600  w-6 text-center mb-2">M</div>
                        <div class="text-xs font-semibold text-gray-600  w-6 text-center mb-2">T</div>
                        <div class="text-xs font-semibold text-gray-600  w-6 text-center mb-2">W</div>
                        <div class="text-xs font-semibold text-gray-600  w-6 text-center mb-2">T</div>
                        <div class="text-xs font-semibold text-gray-600  w-6 text-center mb-2">F</div>
                        <div class="text-xs font-semibold text-gray-600  w-6 text-center">S</div>
                      </div>

                      <!-- Contribution squares grid -->
                      <div class="flex gap-0.5">
                        <div v-for="(week, weekIndex) in contributionGraph" :key="weekIndex" class="flex flex-col gap-0.5">
                          <div 
                            v-for="day in week"
                            :key="day ? day.date : 'empty-' + weekIndex"
                            @mouseenter="day ? showCalendarTooltip($event, day.tooltip) : null"
                            @mouseleave="hideCalendarTooltip()"
                            class="relative group"
                          >
                            <button
                              v-if="day"
                              :class="[
                                'rounded transition-all duration-200',
                                getDayStatusColor(day.status)
                              ]"
                              style="width: 20px; height: 20px; padding: 0; border: none; cursor: pointer; min-width: 20px; min-height: 20px;"
                              :title="day.tooltip"
                            >
                            </button>
                            <div v-else style="width: 20px; height: 20px; min-width: 20px; min-height: 20px;"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Legend and Stats -->
                <div class="mt-6 pt-4 border-t border-gray-300  text-xs text-gray-600  ">
                  <p>Contribution graph shows daily goal completion status for 2025. Green = all tasks completed, Yellow = partial completion, Gray = no tasks completed.</p>
                </div>

                <!-- Tooltip -->
                <div 
                  v-if="hoverTooltip.visible"
                  class="fixed bg-gray-900 text-white px-3 py-2 rounded shadow-lg text-sm z-50 pointer-events-none"
                  :style="{ 
                    left: hoverTooltip.x + 'px', 
                    top: hoverTooltip.y + 'px',
                    transform: 'translate(-50%, -100%)'
                  }"
                >
                  {{ hoverTooltip.text }}
                </div>
              </div>
            </div>

            </main>

            <!-- Footer -->
            <footer class="bg-gray-900 text-gray-400 text-center py-6 mt-12">
              <p>Murajah v2.0.0 - Beta | Made with <i class="fas fa-heart text-red-500"></i> for Qur'an memorization</p>
            </footer>

            <!-- Error Toast -->
            <div v-if="appStore.errorMessage" class="toast bg-red-500 text-white p-4 rounded-lg shadow-lg">
              <div class="flex items-center gap-3">
                <i class="fas fa-exclamation-circle"></i>
                <span>{{ appStore.errorMessage }}</span>
                <button @click="appStore.errorMessage = ''" class="ml-auto text-xl">&times;</button>
              </div>
            </div>

            <!-- Success Toast -->
            <div v-if="appStore.successMessage" class="toast bg-green-500 text-white p-4 rounded-lg shadow-lg">
              <div class="flex items-center gap-3">
                <i class="fas fa-check-circle"></i>
                <span>{{ appStore.successMessage }}</span>
                <button @click="appStore.successMessage = ''" class="ml-auto text-xl">&times;</button>
              </div>
            </div>

            <!-- Word Translation Tooltip -->
            <div v-if="showTooltip" class="word-tooltip" :style="{ left: tooltipX + 'px', top: (tooltipY - 50) + 'px' }">
              {{ tooltipText }}
            </div>
          </div>
        `,

        setup() {
          // State Stores
          const appStore = reactive({
            currentPage: parseInt(new URLSearchParams(window.location.search).get('page') || 1),
            totalPages: 604,
            isLoading: false,
            theme: 'light', // Will be loaded from IndexedDB in initializeApp
            appVersion: '2.0.0-beta',
            errorMessage: '',
            successMessage: ''
          });

          const settingsStore = reactive({
            finishRevisionDays: 30,
            pagesPerDay: 1,
            fontSize: 'medium',
            tajweedEnabled: true
          });

          const memorizedStore = reactive({
            memorizedPages: new Set(),
            lastUpdated: null
          });

          const mistakesStore = reactive({
            mistakes: new Map(),
            lastUpdated: null
          });

          const audioStore = reactive({
            recordings: [],
            isRecording: false,
            lastUpdated: null
          });

          const perfectRevisionsStore = reactive({
            perfectRevisions: new Map(), // pageNum -> count
            lastUpdated: null
          });

          const dailyGoalsStore = reactive({
            todayGoal: null, // Current day's goal object
            goalHistory: [], // Array of historical goal records
            streak: 0, // Current streak
            longestStreak: 0, // Best streak ever
            selectedTasks: ['recordRandomPage', 'reviewRange', 'memorizeDaily'], // Default tasks
            lastUpdated: null
          });

          // Local state
          const isInitializing = ref(true);
          const quranData = ref(null);
          const gotoInput = ref('');
          const audioRecorder = new AudioRecorder();
          const showSettingsModal = ref(false);
          
          // Word interaction state
          const hoveredWordId = ref(null);
          const selectedWords = ref(new Set());
          
          // Tooltip state
          const showTooltip = ref(false);
          const tooltipX = ref(0);
          const tooltipY = ref(0);
          const tooltipText = ref('');

          // Touch device detection
          const isTouchDevice = () => {
            return (
              ('ontouchstart' in window) ||
              (navigator.maxTouchPoints > 0) ||
              (navigator.msMaxTouchPoints > 0) ||
              window.matchMedia('(hover: none) and (pointer: coarse)').matches
            );
          };

          // Initialize app
          const initializeApp = async () => {
            try {
              isInitializing.value = true;
              
              // Load theme from IndexedDB
              try {
                appStore.theme = await murajahDB.loadTheme();
              } catch (error) {
                console.warn('[Murajah] Failed to load theme from IndexedDB:', error);
                appStore.theme = 'light';
              }
              
              // Load Quran data
              quranData.value = await loadAllQuranData();
              console.log('[Murajah] QuranData loaded, surahNames sample:', Object.keys(quranData.value.surahNames || {}).slice(0, 3), quranData.value.surahNames);
              console.log('[Murajah] Translations sample:', Object.keys(quranData.value.translations || {}).slice(0, 5), 'Total translations:', Object.keys(quranData.value.translations || {}).length);
              
              // Load stored data
              await loadStoredData();
              
              // Initialize daily goals
              await initializeDailyGoals();
              
              console.log('[Murajah] App initialized successfully');
              appStore.successMessage = 'Murajah loaded successfully!';
              setTimeout(() => appStore.successMessage = '', 3000);
            } catch (error) {
              console.error('[Murajah] Initialization error:', error);
              appStore.errorMessage = 'Failed to load Murajah. Please refresh.';
            } finally {
              isInitializing.value = false;
            }
          };

          const loadStoredData = async () => {
            try {
              // Try to load from IndexedDB first
              const data = await murajahDB.loadData();
              if (data) {
                if (data.memorized) memorizedStore.memorizedPages = new Set(data.memorized);
                if (data.perfectRevisions) {
                  perfectRevisionsStore.perfectRevisions = new Map(Object.entries(data.perfectRevisions).map(([k, v]) => [parseInt(k), v]));
                }
                if (data.mistakes) {
                  mistakesStore.mistakes = new Map(Object.entries(data.mistakes).map(([k, v]) => [parseInt(k), new Set(v)]));
                }
                if (data.recordings) {
                  // Load recordings with their blobs from IndexedDB
                  audioStore.recordings = [];
                  for (let i = 0; i < data.recordings.length; i++) {
                    try {
                      const recordingWithBlob = await murajahDB.loadRecording(i);
                      if (recordingWithBlob) {
                        audioStore.recordings.push(recordingWithBlob);
                      }
                    } catch (error) {
                      console.warn('[Murajah] Failed to load recording blob:', error);
                    }
                  }
                }
                if (data.settings) {
                  Object.assign(settingsStore, data.settings);
                  // Load selectedTasks for daily goals
                  if (data.settings.selectedTasks) {
                    dailyGoalsStore.selectedTasks = data.settings.selectedTasks;
                  }
                }
              } else {
                // Fallback: Try localStorage for backward compatibility
                const stored = localStorage.getItem('murajah-data');
                if (stored) {
                  const data = JSON.parse(stored);
                  if (data.memorized) memorizedStore.memorizedPages = new Set(data.memorized);
                  if (data.perfectRevisions) {
                    perfectRevisionsStore.perfectRevisions = new Map(Object.entries(data.perfectRevisions).map(([k, v]) => [parseInt(k), v]));
                  }
                  if (data.mistakes) {
                    mistakesStore.mistakes = new Map(Object.entries(data.mistakes).map(([k, v]) => [parseInt(k), new Set(v)]));
                  }
                  if (data.recordings) audioStore.recordings = data.recordings;
                  if (data.settings) {
                    Object.assign(settingsStore, data.settings);
                    // Load selectedTasks for daily goals
                    if (data.settings.selectedTasks) {
                      dailyGoalsStore.selectedTasks = data.settings.selectedTasks;
                    }
                  }
                  
                  // Migrate to IndexedDB
                  await saveData();
                  localStorage.removeItem('murajah-data');
                }
              }
            } catch (error) {
              console.error('[Murajah] Failed to load stored data:', error);
            }
            // Ensure fontSize is always a valid value
            if (!['small', 'medium', 'large'].includes(settingsStore.fontSize)) {
              settingsStore.fontSize = 'medium';
            }
          };

          // Save data to IndexedDB
          const saveData = async () => {
            // Separate recordings data: blobs go to IndexedDB recordings store, metadata to appData
            const recordingsMetadata = audioStore.recordings.map(r => ({
              pageNumber: r.pageNumber,
              recordedAt: r.recordedAt,
              duration: r.duration,
              timestamp: r.timestamp
            }));

            // Extract plain objects from reactive stores (Proxy objects can't be cloned by IndexedDB)
            const plainSettings = {
              finishRevisionDays: Number(settingsStore.finishRevisionDays),
              pagesPerDay: Number(settingsStore.pagesPerDay),
              fontSize: String(settingsStore.fontSize),
              tajweedEnabled: Boolean(settingsStore.tajweedEnabled),
              selectedTasks: Array.isArray(dailyGoalsStore.selectedTasks) 
                ? dailyGoalsStore.selectedTasks.map(t => String(t))
                : []
            };

            const data = {
              memorized: Array.from(memorizedStore.memorizedPages).map(p => Number(p)),
              perfectRevisions: Object.fromEntries(
                Array.from(perfectRevisionsStore.perfectRevisions).map(([k, v]) => [String(k), Number(v)])
              ),
              mistakes: Object.fromEntries(
                Array.from(mistakesStore.mistakes).map(([key, val]) => [String(key), Array.from(val).map(v => Number(v))])
              ),
              recordings: recordingsMetadata, // Only metadata, not blobs
              settings: plainSettings, // Plain object, not Proxy
              lastSaved: new Date().toISOString()
            };
            try {
              await murajahDB.saveData(data);
              
              // Also save audio blobs separately (without metadata fields that might cause issues)
              for (let i = 0; i < audioStore.recordings.length; i++) {
                const recording = audioStore.recordings[i];
                if (recording.blob) {
                  try {
                    await murajahDB.saveRecording(i, recording);
                  } catch (blobError) {
                    console.warn('[Murajah] Failed to save audio blob:', blobError);
                  }
                }
              }
            } catch (error) {
              console.error('[Murajah] Failed to save data to IndexedDB:', error);
              // Fallback to localStorage (but exclude blobs)
              localStorage.setItem('murajah-data', JSON.stringify(data));
            }
          };

          // Fire-and-forget wrapper for saveData (for non-critical saves)
          const saveDataBackground = () => {
            saveData().catch(console.error);
          };

          // ===== Daily Goals Functions =====
          const initializeDailyGoals = async () => {
            try {
              const today = getTodayDate();
              console.log('[Murajah] Initializing daily goals for', today, 'with memorized pages:', Array.from(memorizedStore.memorizedPages || []).slice(0, 5));
              
              // Check if this is a new user (no memorized pages) and adjust tasks accordingly
              const isNewUser = memorizedStore.memorizedPages.size === 0;
              const hasReviewRangeTask = dailyGoalsStore.selectedTasks.includes('reviewRange');
              const hasRecordRandomPageTask = dailyGoalsStore.selectedTasks.includes('recordRandomPage');
              
              if (isNewUser && (hasReviewRangeTask || hasRecordRandomPageTask)) {
                // For new users with no memorized pages, remove tasks that require memorized pages
                dailyGoalsStore.selectedTasks = dailyGoalsStore.selectedTasks.filter(
                  task => task !== 'reviewRange' && task !== 'recordRandomPage'
                );
                
                // Ensure new users have at least reciteAyahs and memorizeDaily
                if (!dailyGoalsStore.selectedTasks.includes('reciteAyahs')) {
                  dailyGoalsStore.selectedTasks.push('reciteAyahs');
                }
                if (!dailyGoalsStore.selectedTasks.includes('memorizeDaily')) {
                  dailyGoalsStore.selectedTasks.push('memorizeDaily');
                }
                
                console.log('[Murajah] New user detected (no memorized pages) - adjusted tasks to:', dailyGoalsStore.selectedTasks);
              }
              
              try {
                // Try to load today's goal from IndexedDB
                const storedGoal = await murajahDB.loadDailyGoal(today);
                
                if (storedGoal) {
                  // Today's goal already exists, just load it
                  dailyGoalsStore.todayGoal = storedGoal;
                  console.log('[Murajah] Today\'s goal loaded from IndexedDB', storedGoal);
                  console.log('[Murajah] Loaded tasks:', Object.entries(storedGoal.tasks || {}).map(([k, v]) => `${k}: completed=${v.completed}`));
                } else {
                  // New day, initialize new goals
                  const newGoal = initializeTodayGoals(settingsStore, memorizedStore.memorizedPages, dailyGoalsStore.todayGoal);
                  dailyGoalsStore.todayGoal = newGoal;
                  console.log('[Murajah] New goal created:', newGoal);
                  
                  // Save new goal to IndexedDB (use plain object conversion)
                  const goalToSave = {
                    date: newGoal.date,
                    tasks: {},
                    completedCount: newGoal.completedCount,
                    lastUpdated: newGoal.lastUpdated
                  };
                  for (const [taskName, taskObj] of Object.entries(newGoal.tasks)) {
                    const plainTask = {
                      name: String(taskObj.name),
                      description: String(taskObj.description),
                      completed: Boolean(taskObj.completed),
                      completedAt: taskObj.completedAt ? String(taskObj.completedAt) : null,
                      recordingId: taskObj.recordingId ? String(taskObj.recordingId) : null,
                      startPage: taskObj.startPage ? Number(taskObj.startPage) : null,
                      endPage: taskObj.endPage ? Number(taskObj.endPage) : null,
                      pages: Array.isArray(taskObj.pages) ? taskObj.pages.map(p => Number(p)) : [],
                      targetPages: taskObj.targetPages ? Number(taskObj.targetPages) : 0,
                      pagesAddedToday: taskObj.pagesAddedToday ? Number(taskObj.pagesAddedToday) : 0
                    };
                    goalToSave.tasks[taskName] = plainTask;
                  }
                  await murajahDB.saveDailyGoal(goalToSave);
                  console.log('[Murajah] New daily goal initialized and saved for', today);
                }
              } catch (dbError) {
                console.warn('[Murajah] Database error, creating in-memory goal:', dbError);
                // Fallback: Create goal in memory if database fails
                const newGoal = initializeTodayGoals(settingsStore, memorizedStore.memorizedPages, null);
                dailyGoalsStore.todayGoal = newGoal;
              }
              
              // Try to load goal history for streak calculation
              try {
                const history = await murajahDB.loadDailyGoalHistory(90);
                dailyGoalsStore.goalHistory = history;
              } catch (historyError) {
                console.warn('[Murajah] Failed to load history, using empty:', historyError);
                dailyGoalsStore.goalHistory = [];
              }
              
              // Calculate streak
              const streakInfo = calculateStreak(dailyGoalsStore.goalHistory, dailyGoalsStore.selectedTasks);
              dailyGoalsStore.streak = streakInfo.currentStreak;
              dailyGoalsStore.longestStreak = streakInfo.longestStreak;
              
              dailyGoalsStore.lastUpdated = new Date().toISOString();
              console.log('[Murajah] Daily goals initialized - Streak:', dailyGoalsStore.streak, 'todayGoal:', dailyGoalsStore.todayGoal);
            } catch (error) {
              console.error('[Murajah] Error initializing daily goals:', error);
              appStore.errorMessage = 'Failed to initialize daily goals';
              setTimeout(() => appStore.errorMessage = '', 3000);
            }
          };

          // Reinitialize daily goals when settings change (force new goal with updated settings)
          const reinitializeDailyGoalsWithNewSettings = async () => {
            try {
              const today = getTodayDate();
              console.log('[Murajah] Reinitializing daily goals with new settings');
              
              // Create a NEW goal with the updated settings (ignore the stored one)
              const newGoal = initializeTodayGoals(settingsStore, memorizedStore.memorizedPages, dailyGoalsStore.todayGoal);
              
              // Preserve completion status of tasks that still exist
              if (dailyGoalsStore.todayGoal && dailyGoalsStore.todayGoal.tasks) {
                for (const [taskName, newTask] of Object.entries(newGoal.tasks)) {
                  if (dailyGoalsStore.todayGoal.tasks[taskName]) {
                    // Preserve the completion status
                    newTask.completed = dailyGoalsStore.todayGoal.tasks[taskName].completed;
                    newTask.completedAt = dailyGoalsStore.todayGoal.tasks[taskName].completedAt;
                  }
                }
              }
              
              dailyGoalsStore.todayGoal = newGoal;
              console.log('[Murajah] Daily goals reinitialized with new settings:', newGoal);
              
              // Save the updated goal to IndexedDB
              const goalToSave = {
                date: newGoal.date,
                tasks: {},
                completedCount: newGoal.completedCount,
                lastUpdated: newGoal.lastUpdated
              };
              for (const [taskName, taskObj] of Object.entries(newGoal.tasks)) {
                const plainTask = {
                  name: String(taskObj.name),
                  description: String(taskObj.description),
                  completed: Boolean(taskObj.completed),
                  completedAt: taskObj.completedAt ? String(taskObj.completedAt) : null,
                  recordingId: taskObj.recordingId ? String(taskObj.recordingId) : null,
                  startPage: taskObj.startPage ? Number(taskObj.startPage) : null,
                  endPage: taskObj.endPage ? Number(taskObj.endPage) : null,
                  pages: Array.isArray(taskObj.pages) ? taskObj.pages.map(p => Number(p)) : [],
                  targetPages: taskObj.targetPages ? Number(taskObj.targetPages) : 0,
                  pagesAddedToday: taskObj.pagesAddedToday ? Number(taskObj.pagesAddedToday) : 0
                };
                goalToSave.tasks[taskName] = plainTask;
              }
              await murajahDB.saveDailyGoal(goalToSave);
              appStore.successMessage = 'Daily goals updated with new settings!';
              setTimeout(() => appStore.successMessage = '', 2000);
            } catch (error) {
              console.error('[Murajah] Error reinitializing daily goals:', error);
              appStore.errorMessage = 'Failed to update daily goals';
              setTimeout(() => appStore.errorMessage = '', 3000);
            }
          };

          const saveDailyGoal = async () => {
            try {
              // Convert Proxy object to plain object for IndexedDB serialization
              const goalToSave = {
                date: dailyGoalsStore.todayGoal.date,
                tasks: {},
                completedCount: dailyGoalsStore.todayGoal.completedCount,
                lastUpdated: dailyGoalsStore.todayGoal.lastUpdated
              };
              
              // Convert tasks object (Proxy) to plain object with plain arrays
              for (const [taskName, taskObj] of Object.entries(dailyGoalsStore.todayGoal.tasks)) {
                const plainTask = {
                  name: String(taskObj.name),
                  description: String(taskObj.description),
                  completed: Boolean(taskObj.completed),
                  completedAt: taskObj.completedAt ? String(taskObj.completedAt) : null,
                  recordingId: taskObj.recordingId ? String(taskObj.recordingId) : null,
                  startPage: taskObj.startPage ? Number(taskObj.startPage) : null,
                  endPage: taskObj.endPage ? Number(taskObj.endPage) : null,
                  pages: Array.isArray(taskObj.pages) ? taskObj.pages.map(p => Number(p)) : [],
                  targetPages: taskObj.targetPages ? Number(taskObj.targetPages) : 0,
                  pagesAddedToday: taskObj.pagesAddedToday ? Number(taskObj.pagesAddedToday) : 0
                };
                goalToSave.tasks[taskName] = plainTask;
              }
              
              console.log('[Murajah] Saving goal with tasks:', Object.keys(goalToSave.tasks).map(k => `${k}: pages=${goalToSave.tasks[k].pages ? goalToSave.tasks[k].pages.length : 0}`));
              await murajahDB.saveDailyGoal(goalToSave);
              console.log('[Murajah] Daily goal saved:', goalToSave);
            } catch (error) {
              console.error('[Murajah] Failed to save daily goal:', error);
              appStore.errorMessage = 'Failed to save task - will save in memory';
              setTimeout(() => appStore.errorMessage = '', 3000);
            }
          };

          const completeTaskGoal = async (taskName, metadata = {}) => {
            if (!dailyGoalsStore.todayGoal || !dailyGoalsStore.todayGoal.tasks[taskName]) {
              console.warn(`[Murajah] Task ${taskName} not found in today's goal`);
              return;
            }
            
            completeTask(dailyGoalsStore.todayGoal, taskName, metadata);
            await saveDailyGoal();
            
            // Recalculate streak
            const history = [...dailyGoalsStore.goalHistory, dailyGoalsStore.todayGoal];
            const streakInfo = calculateStreak(history, dailyGoalsStore.selectedTasks);
            dailyGoalsStore.streak = streakInfo.currentStreak;
            dailyGoalsStore.longestStreak = streakInfo.longestStreak;
            
            appStore.successMessage = `Task "${taskName}" completed!`;
            setTimeout(() => appStore.successMessage = '', 2000);
          };

          const uncompleteTaskGoal = async (taskName) => {
            if (!dailyGoalsStore.todayGoal || !dailyGoalsStore.todayGoal.tasks[taskName]) {
              console.warn(`[Murajah] Task ${taskName} not found in today's goal`);
              return;
            }
            
            uncompleteTask(dailyGoalsStore.todayGoal, taskName);
            await saveDailyGoal();
            
            appStore.successMessage = `Task "${taskName}" uncompleted`;
            setTimeout(() => appStore.successMessage = '', 2000);
          };

          const getTaskProgressPercentage = () => {
            if (!dailyGoalsStore.todayGoal) return 0;
            return getCompletionPercentage(dailyGoalsStore.todayGoal);
          };

          // Navigation functions
          const previousPage = () => {
            if (appStore.currentPage > 1) {
              appStore.currentPage--;
              updateURL();
            }
          };

          const nextPage = () => {
            if (appStore.currentPage < 604) {
              appStore.currentPage++;
              updateURL();
            }
          };

          const gotoPage = () => {
            const num = parseInt(gotoInput.value);
            if (isNaN(num) || num < 1 || num > 604) {
              appStore.errorMessage = 'Please enter a page number between 1 and 604';
              setTimeout(() => appStore.errorMessage = '', 2000);
              return;
            }
            goToPageNumber(num);
          };

          const goToPageNumber = (pageNum) => {
            if (pageNum < 1 || pageNum > 604) {
              appStore.errorMessage = 'Please enter a page number between 1 and 604';
              setTimeout(() => appStore.errorMessage = '', 2000);
              return;
            }
            appStore.currentPage = pageNum;
            gotoInput.value = '';
            updateURL();
          };

          const selectRandomPage = () => {
            if (memorizedStore.memorizedPages.size === 0) {
              appStore.errorMessage = 'No memorized pages yet';
              return;
            }
            const memorizedArray = Array.from(memorizedStore.memorizedPages);
            const randomPage = memorizedArray[Math.floor(Math.random() * memorizedArray.length)];
            appStore.currentPage = randomPage;
            updateURL();
            appStore.successMessage = `Random page selected: Page ${randomPage}`;
            setTimeout(() => appStore.successMessage = '', 3000);
            
            // Scroll to Quran text section after a brief delay to let Vue update the DOM
            setTimeout(() => {
              const quranSection = document.getElementById('quran-text-section');
              if (quranSection) {
                quranSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }, 100);
          };

          const updateURL = () => {
            window.history.replaceState(
              {},
              '',
              `?page=${appStore.currentPage}`
            );
          };

          // Memorization functions
          const toggleMemorized = () => {
            if (memorizedStore.memorizedPages.has(appStore.currentPage)) {
              memorizedStore.memorizedPages.delete(appStore.currentPage);
              appStore.successMessage = 'Removed from memorized';
            } else {
              memorizedStore.memorizedPages.add(appStore.currentPage);
              // Set score to 40 only if page is new (score = 0)
              const currentScore = getHifzScore(appStore.currentPage);
              if (currentScore < 40) {
                perfectRevisionsStore.perfectRevisions.set(appStore.currentPage, 40);
                appStore.successMessage = 'Marked as memorized! (Score: 40)';
              } else {
                appStore.successMessage = `Marked as memorized! (Score: ${currentScore} - kept)`;
              }
            }
            setTimeout(() => appStore.successMessage = '', 2000);
            saveDataBackground();
          };

          const isCurrentPageMemorized = computed(() => {
            return memorizedStore.memorizedPages.has(appStore.currentPage);
          });

          // Theme functions - Always use light mode
          const applyThemeToDOM = (theme) => {
            // Always apply light mode
            document.documentElement.classList.remove('dark');
            document.documentElement.classList.remove('dark-mode');
            document.body.classList.remove('dark-mode');
            // Set inline styles
            document.documentElement.style.backgroundColor = '#ffffff';
            document.documentElement.style.color = '#111827';
            console.log('[Murajah] Light mode applied to DOM');
          };

          const toggleTheme = () => {
            // Theme toggle disabled - always use light mode
            console.log('[Murajah] Theme toggle disabled - light mode is always active');
          };

          // Perfect Revision functions
          const getPerfectCount = (pageNum) => {
            return perfectRevisionsStore.perfectRevisions.get(pageNum) || 0;
          };

          const incrementPerfectRevision = (pageNum) => {
            const currentCount = getPerfectCount(pageNum);
            perfectRevisionsStore.perfectRevisions.set(pageNum, currentCount + 1);
            perfectRevisionsStore.lastUpdated = new Date();
            appStore.successMessage = `Page ${pageNum} marked perfect! (+1)`;
            setTimeout(() => appStore.successMessage = '', 2000);
            saveDataBackground();
          };

          const currentPagePerfectCount = computed(() => {
            return getPerfectCount(appStore.currentPage);
          });

          // Get memorization score (0-100) based on perfect revision count
          // Score = perfect count directly (each mistake decreases count by 1)
          const getHifzScore = (pageNum) => {
            const perfectCount = getPerfectCount(pageNum);
            // Cap at 100, but allow negative scores to go to 0
            return Math.max(0, Math.min(perfectCount, 100));
          };

          // Get score colors for UI display
          const getScoreColors = (score) => {
            if (score > 90) {
              return { label: 'Firm', bg: '#111', color: '#fff', icon: 'la-star' };
            } else if (score >= 80) {
              return { label: 'Strong', bg: '#1b5e20', color: '#fff', icon: 'la-check-circle' };
            } else if (score >= 60) {
              return { label: 'Good', bg: '#0277bd', color: '#fff', icon: 'la-thumbs-up' };
            } else if (score >= 40) {
              return { label: 'Fair', bg: '#ff8f00', color: '#fff', icon: 'la-exclamation-circle' };
            } else if (score > 0) {
              return { label: 'Weak', bg: '#c62828', color: '#fff', icon: 'la-exclamation-triangle' };
            } else {
              return { label: 'New', bg: '#757575', color: '#fff', icon: 'la-bookmark' };
            }
          };

          // Get Arabic surah name from surah number
          const getSurahNameArabic = (surahNum) => {
            console.log(`[getSurahNameArabic] Called with surahNum:`, surahNum, 'type:', typeof surahNum);
            if (!surahNum || !quranData.value || !quranData.value.surahNames) {
              console.log(`[getSurahNameArabic] Failed guard check - surahNum:`, surahNum, 'quranData exists:', !!quranData.value, 'surahNames exists:', !!(quranData.value && quranData.value.surahNames));
              return 'Quran Content';
            }
            const surahNames = quranData.value.surahNames;
            console.log(`[getSurahNameArabic] Looking up surahNames[${surahNum}]`, surahNames[surahNum]);
            // The surahNames object has numeric keys (1, 2, 3, etc.) from the loaded JSON
            let surahName = surahNames[surahNum];
            if (surahName) {
              console.log(`[Murajah] Got surah name for ${surahNum}:`, surahName);
              return surahName;
            }
            console.warn(`[Murajah] Surah name not found for:`, surahNum);
            return `Surah ${surahNum}`;
          };

          const currentPageHifzStatus = computed(() => {
            const score = getHifzScore(appStore.currentPage);
            return getScoreColors(score);
          });

          // Word interaction functions
          const highlightWord = (word) => {
            // Add/remove word from mistakes for current page
            if (!mistakesStore.mistakes.has(appStore.currentPage)) {
              mistakesStore.mistakes.set(appStore.currentPage, new Set());
            }
            
            const pageErrors = mistakesStore.mistakes.get(appStore.currentPage);
            
            if (pageErrors.has(word.id)) {
              // Removing a mistake - increase perfect score
              pageErrors.delete(word.id);
              appStore.successMessage = 'Mistake removed!';
            } else {
              // Adding a mistake - decrease perfect score
              pageErrors.add(word.id);
              const currentCount = getPerfectCount(appStore.currentPage);
              perfectRevisionsStore.perfectRevisions.set(appStore.currentPage, Math.max(0, currentCount - 1));
              appStore.successMessage = 'Mistake marked! (-1 score)';
            }
            setTimeout(() => appStore.successMessage = '', 2000);
            
            // Save after updating
            saveDataBackground();
            console.log(`[Murajah] Word ${word.id} mistake toggled on page ${appStore.currentPage}`);
          };

          // Tooltip functions for word translations
          const showWordTooltip = (word, event) => {
            // Don't show tooltip on touch devices
            if (isTouchDevice()) {
              console.log('[Murajah] Tooltip blocked on touch device');
              return;
            }

            hoveredWordId.value = word.id;
            if (!quranData.value || !quranData.value.translations) {
              console.warn('[Murajah] No translations available');
              return;
            }
            
            // The translation key format is "surah:ayah:word" (e.g., "2:275:1")
            const key = `${word.surah}:${word.ayah}:${word.word}`;
            const translation = quranData.value.translations[key];
            
            console.log('[Murajah] Word tooltip lookup:', { 
              word: { id: word.id, surah: word.surah, ayah: word.ayah, word: word.word },
              key,
              found: !!translation,
              translation: translation || 'N/A'
            });
            
            if (translation) {
              tooltipText.value = translation;
              
              // Position tooltip above the word
              const rect = event.target.getBoundingClientRect();
              tooltipX.value = rect.left + rect.width / 2; // Center horizontally above the word
              tooltipY.value = rect.top; // Top of the word
              
              showTooltip.value = true;
              console.log('[Murajah] Word tooltip shown:', key, translation);
            } else {
              console.warn('[Murajah] Translation not found for key:', key);
              // Don't show tooltip if no translation found
              showTooltip.value = false;
            }
          };

          const updateTooltipPosition = (event) => {
            // Position tooltip above the word instead of following mouse
            const rect = event.target.getBoundingClientRect();
            tooltipX.value = rect.left + rect.width / 2; // Center horizontally above the word
            tooltipY.value = rect.top; // Top of the word
          };

          const hideWordTooltip = () => {
            hoveredWordId.value = null;
            showTooltip.value = false;
          };

          // Settings functions
          const updateSettings = () => {
            saveDataBackground(); // Save to IndexedDB
            appStore.successMessage = 'Settings updated!';
            setTimeout(() => appStore.successMessage = '', 2000);
          };

          const clearPageMistakes = () => {
            if (confirm(`Clear all mistakes on page ${appStore.currentPage}?`)) {
              mistakesStore.mistakes.delete(appStore.currentPage);
              saveDataBackground();
              appStore.successMessage = 'Mistakes cleared!';
              setTimeout(() => appStore.successMessage = '', 2000);
            }
          };

          // Bulk memorization and statistics functions
          const bulkStartPage = ref(1);
          const bulkEndPage = ref(20);
          const bulkWarning = ref('');
          const selectedJuzPreset = ref(1);

          // Hardcoded Juz ranges (Juz 1 has 21 pages, Juz 2-29 have 20 pages each, Juz 30 has 23 pages)
          const JUZ_RANGES = {
            1: [1, 21],
            2: [22, 41],
            3: [42, 61],
            4: [62, 81],
            5: [82, 101],
            6: [102, 121],
            7: [122, 141],
            8: [142, 161],
            9: [162, 181],
            10: [182, 201],
            11: [202, 221],
            12: [222, 241],
            13: [242, 261],
            14: [262, 281],
            15: [282, 301],
            16: [302, 321],
            17: [322, 341],
            18: [342, 361],
            19: [362, 381],
            20: [382, 401],
            21: [402, 421],
            22: [422, 441],
            23: [442, 461],
            24: [462, 481],
            25: [482, 501],
            26: [502, 521],
            27: [522, 541],
            28: [542, 561],
            29: [562, 581],
            30: [582, 604]
          };

          const getJuzRange = (juzNum) => JUZ_RANGES[juzNum] || [1, 21];

          // Surah starting pages mapping (surah number -> starting page) - Extracted from actual Quran data
          const SURAH_PAGES = {
            1: 1, 2: 2, 3: 50, 4: 76, 5: 106, 6: 128, 7: 151, 8: 177, 9: 187, 10: 207,
            11: 221, 12: 235, 13: 249, 14: 255, 15: 262, 16: 267, 17: 282, 18: 293, 19: 305, 20: 312,
            21: 322, 22: 331, 23: 341, 24: 349, 25: 359, 26: 366, 27: 376, 28: 385, 29: 396, 30: 404,
            31: 411, 32: 414, 33: 417, 34: 428, 35: 434, 36: 440, 37: 445, 38: 452, 39: 458, 40: 467,
            41: 477, 42: 483, 43: 489, 44: 496, 45: 498, 46: 502, 47: 506, 48: 511, 49: 515, 50: 518,
            51: 520, 52: 523, 53: 525, 54: 528, 55: 531, 56: 534, 57: 537, 58: 542, 59: 545, 60: 548,
            61: 551, 62: 553, 63: 554, 64: 555, 65: 557, 66: 560, 67: 562, 68: 564, 69: 566, 70: 568,
            71: 570, 72: 572, 73: 574, 74: 575, 75: 577, 76: 578, 77: 580, 78: 582, 79: 583, 80: 584,
            81: 586, 82: 587, 83: 587, 84: 589, 85: 590, 86: 591, 87: 591, 88: 592, 89: 593, 90: 594,
            91: 595, 92: 595, 93: 596, 94: 596, 95: 597, 96: 597, 97: 598, 98: 598, 99: 599, 100: 599,
            101: 600, 102: 600, 103: 601, 104: 601, 105: 601, 106: 602, 107: 602, 108: 602, 109: 603, 110: 603,
            111: 603, 112: 604, 113: 604, 114: 604
          };

          const getSurahStartPage = (surahNum) => SURAH_PAGES[surahNum] || 1;

          const juzMemorizedCount = (juzNum) => {
            const [startPage, endPage] = getJuzRange(juzNum);
            let count = 0;
            for (let i = startPage; i <= endPage; i++) {
              if (memorizedStore.memorizedPages.has(i)) count++;
            }
            return count;
          };

          // Calculate memorization percentage for a Juz (0-100)
          const getJuzMemorizedPercentage = (juzNum) => {
            const [startPage, endPage] = getJuzRange(juzNum);
            const totalPages = endPage - startPage + 1;
            const memorized = juzMemorizedCount(juzNum);
            return (memorized / totalPages) * 100;
          };

          // Get gradient background style for partially memorized Juz
          const getJuzGradientStyle = (juzNum) => {
            const memorized = juzMemorizedCount(juzNum);
            const [startPage, endPage] = getJuzRange(juzNum);
            const totalPages = endPage - startPage + 1;

            // If fully memorized or not started, no gradient needed
            if (memorized === 0 || memorized === totalPages) {
              return {};
            }

            // Calculate percentage for gradient (green to yellow split)
            const percentage = (memorized / totalPages) * 100;
            return {
              background: `linear-gradient(to right, #22c55e 0%, #22c55e ${percentage}%, #eab308 ${percentage}%, #eab308 100%)`
            };
          };

          const daysRemaining = computed(() => {
            if (statistics.value.remaining <= 0) return 0;
            if (settingsStore.pagesPerDay <= 0) return 0;
            return Math.ceil(statistics.value.remaining / settingsStore.pagesPerDay);
          });

          const bulkMemorize = () => {
            bulkWarning.value = '';
            const start = Math.max(1, Math.min(bulkStartPage.value, 604));
            const end = Math.max(start, Math.min(bulkEndPage.value, 604));

            if (start > end) {
              bulkWarning.value = 'Start page must be less than or equal to end page';
              return;
            }

            let added = 0;
            let alreadyHigherScore = 0;
            for (let i = start; i <= end; i++) {
              if (!memorizedStore.memorizedPages.has(i)) {
                memorizedStore.memorizedPages.add(i);
                // Set score to 40 only if page is new (score = 0)
                const currentScore = getHifzScore(i);
                if (currentScore < 40) {
                  perfectRevisionsStore.perfectRevisions.set(i, 40);
                }
                added++;
              } else {
                // Check if already memorized with higher score
                const currentScore = getHifzScore(i);
                if (currentScore > 0) {
                  alreadyHigherScore++;
                }
              }
            }

            if (added > 0) {
              saveDataBackground();
              if (alreadyHigherScore > 0) {
                appStore.successMessage = `${added} added, ${alreadyHigherScore} already memorized (scores kept)`;
              } else {
                appStore.successMessage = `${added} page(s) marked as memorized! (Score: 40)`;
              }
              setTimeout(() => appStore.successMessage = '', 2000);
            } else {
              bulkWarning.value = `All pages in range ${start}-${end} were already memorized`;
            }
          };

          const bulkMemorizePreset = (type, value) => {
            bulkWarning.value = '';

            if (type === 'juz' && selectedJuzPreset.value >= 1 && selectedJuzPreset.value <= 30) {
              const juzNum = selectedJuzPreset.value;
              const [startPage, endPage] = getJuzRange(juzNum);
              bulkStartPage.value = startPage;
              bulkEndPage.value = endPage;
              bulkMemorize();
            } else if (type === 'all') {
              if (confirm('Mark ALL 604 pages as memorized?')) {
                for (let i = 1; i <= 604; i++) {
                  memorizedStore.memorizedPages.add(i);
                }
                saveDataBackground();
                appStore.successMessage = 'All 604 pages marked as memorized!';
                setTimeout(() => appStore.successMessage = '', 2000);
              }
            } else if (type === 'clear') {
              if (confirm('Clear all memorized pages?')) {
                memorizedStore.memorizedPages.clear();
                saveDataBackground();
                appStore.successMessage = 'All memorized pages cleared!';
                setTimeout(() => appStore.successMessage = '', 2000);
              }
            }
          };

          // Audio functions
          const playAudio = async (recording) => {
            try {
              await AudioRecorder.playAudio(recording.blob);
            } catch (error) {
              console.error('[Murajah] Playback error:', error);
              appStore.errorMessage = 'Failed to play recording';
            }
          };

          let recordingTimer = null;
          const recordingStartTime = ref(null);
          const recordingDuration = ref('0:00');

          const startRecording = async () => {
            try {
              await audioRecorder.startRecording();
              audioStore.isRecording = true;
              recordingStartTime.value = Date.now();

              recordingTimer = setInterval(() => {
                const elapsed = Date.now() - recordingStartTime.value;
                recordingDuration.value = AudioRecorder.formatDuration(elapsed);
              }, 100);

              appStore.successMessage = 'Recording started...';
              setTimeout(() => appStore.successMessage = '', 2000);
            } catch (error) {
              console.error('[Murajah] Recording error:', error);
              appStore.errorMessage = 'Failed to start recording: ' + error.message;
              audioStore.isRecording = false;
            }
          };

          const stopRecording = async () => {
            try {
              if (recordingTimer) clearInterval(recordingTimer);
              
              const result = await audioRecorder.stopRecording();
              
              if (result) {
                const recording = {
                  pageNumber: appStore.currentPage,
                  recordedAt: new Date().toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                  }),
                  duration: result.duration,
                  blob: result.blob,
                  timestamp: Date.now()
                };

                audioStore.recordings.push(recording);
                audioStore.isRecording = false;
                recordingStartTime.value = null;
                recordingDuration.value = '0:00';

                saveDataBackground();
                appStore.successMessage = `Recording saved! (${AudioRecorder.formatDuration(result.duration)})`;
                setTimeout(() => appStore.successMessage = '', 3000);
              }
            } catch (error) {
              console.error('[Murajah] Stop recording error:', error);
              appStore.errorMessage = 'Failed to stop recording';
              audioStore.isRecording = false;
            }
          };

          const cancelRecording = () => {
            try {
              if (recordingTimer) clearInterval(recordingTimer);
              
              audioRecorder.cancelRecording();
              
              audioStore.isRecording = false;
              recordingStartTime.value = null;
              recordingDuration.value = '0:00';

              appStore.successMessage = 'Recording cancelled';
              setTimeout(() => appStore.successMessage = '', 2000);
            } catch (error) {
              console.error('[Murajah] Cancel recording error:', error);
              audioStore.isRecording = false;
            }
          };

          const deleteAudio = (index) => {
            if (confirm('Delete this recording?')) {
              audioStore.recordings.splice(index, 1);
              saveDataBackground();
              appStore.successMessage = 'Recording deleted';
              setTimeout(() => appStore.successMessage = '', 2000);
            }
          };

          const formatAudioDuration = (ms) => {
            return AudioRecorder.formatDuration(ms);
          };

          const exportData = () => {
            const data = {
              version: '2.0.0',
              exported: new Date().toISOString(),
              memorized: Array.from(memorizedStore.memorizedPages),
              perfectRevisions: Object.fromEntries(perfectRevisionsStore.perfectRevisions),
              mistakes: Object.fromEntries(
                Array.from(mistakesStore.mistakes).map(([key, val]) => [key, Array.from(val)])
              ),
              settings: settingsStore,
              recordings: audioStore.recordings
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `murajah-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            appStore.successMessage = 'Data exported!';
            setTimeout(() => appStore.successMessage = '', 2000);
          };

          const importData = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
              try {
                const file = e.target.files[0];
                const text = await file.text();
                const data = JSON.parse(text);

                if (data.version === '2.0.0') {
                  if (data.memorized) memorizedStore.memorizedPages = new Set(data.memorized);
                  if (data.settings) Object.assign(settingsStore, data.settings);
                  await saveData();
                  appStore.successMessage = 'Data imported successfully!';
                  setTimeout(() => location.reload(), 2000);
                }
              } catch (error) {
                appStore.errorMessage = 'Invalid backup file';
              }
            };
            input.click();
          };

          const resetApp = async () => {
            if (confirm('Are you sure? This will reset all data.')) {
              try {
                memorizedStore.memorizedPages.clear();
                mistakesStore.mistakes.clear();
                audioStore.recordings = [];
                appStore.currentPage = 1;
                await murajahDB.clearAll();
                appStore.successMessage = 'App reset!';
                setTimeout(() => location.reload(), 2000);
              } catch (error) {
                console.error('[Murajah] Error resetting app:', error);
                appStore.errorMessage = 'Failed to reset app';
              }
            }
          };

          // Computed
          const currentPageAudioCount = computed(() => {
            return audioStore.recordings.filter(r => r.pageNumber === appStore.currentPage).length;
          });

          const currentPageMistakeCount = computed(() => {
            const mistakes = mistakesStore.mistakes.get(appStore.currentPage);
            return mistakes ? mistakes.size : 0;
          });

          const currentPageMistakes = computed(() => {
            const mistakes = mistakesStore.mistakes.get(appStore.currentPage);
            return mistakes ? Array.from(mistakes).sort((a, b) => a - b) : [];
          });

          const fontSizeStyle = computed(() => {
            const sizeMap = {
              'small': '20px',
              'medium': '32px',
              'large': '44px'
            };
            const fontSize = sizeMap[settingsStore.fontSize] || '32px';
            console.log('[Murajah] fontSizeStyle computed:', {
              fontSize: settingsStore.fontSize,
              style: `font-size: ${fontSize}`
            });
            return { fontSize: fontSize };
          });

          const currentSurahName = computed(() => {
            if (!quranData.value || !currentPageWords.value || currentPageWords.value.length === 0) {
              return 'Quran Content';
            }
            
            // Extract surah number from the first word of current page
            for (const line of currentPageWords.value) {
              if (line.words && line.words.length > 0) {
                const firstWord = line.words[0];
                if (firstWord && firstWord.surah) {
                  const surahNum = firstWord.surah;
                  // Get surah names from quranData - should be an object with string keys
                  if (quranData.value.surahNames) {
                    const surahNames = quranData.value.surahNames;
                    // Try both array and object access patterns
                    let surahName = surahNames[surahNum] || surahNames[surahNum.toString()] || surahNames[surahNum - 1];
                    if (surahName) {
                      return surahName;
                    }
                  }
                  return `Surah ${surahNum}`;
                }
              }
            }
            
            return 'Quran Content';
          });

          const statistics = computed(() => {
            return calculateStatistics({
              memorized: memorizedStore.memorizedPages.size,
              mistakes: Array.from(mistakesStore.mistakes.values()).reduce((sum, set) => sum + set.size, 0),
              audios: audioStore.recordings.length,
              perfectRevisions: Array.from(perfectRevisionsStore.perfectRevisions.values()).reduce((sum, count) => sum + count, 0)
            });
          });

          const recentRecordings = computed(() => {
            return audioStore.recordings.slice(-5).reverse();
          });

          const formattedCompletion = computed(() => {
            const estimate = estimateCompletionDate(statistics.value.remaining, settingsStore.pagesPerDay);
            return estimate ? formatDate(estimate) : 'N/A';
          });

          const currentJuzProgress = computed(() => {
            // Find which Juz the current page belongs to
            let juzNum = 1;
            for (let j = 1; j <= 30; j++) {
              const [start, end] = getJuzRange(j);
              if (appStore.currentPage >= start && appStore.currentPage <= end) {
                juzNum = j;
                break;
              }
            }
            const [startPage, endPage] = getJuzRange(juzNum);
            let count = 0;
            for (let i = startPage; i < appStore.currentPage && i <= endPage; i++) {
              if (memorizedStore.memorizedPages.has(i)) count++;
            }
            return count;
          });

          // Get current page text on demand
          const currentPageText = computed(() => {
            if (!quranData.value || !quranData.value.layout || !quranData.value.words) {
              return [];
            }
            return getPageText(appStore.currentPage, quranData.value.layout, quranData.value.words);
          });

          // Get current page words with word-by-word detail
          const currentPageWords = computed(() => {
            if (!quranData.value || !quranData.value.layout || !quranData.value.words) {
              return [];
            }
            return getPageWordsDetailed(appStore.currentPage, quranData.value.layout, quranData.value.words);
          });

          // Load font dynamically for current page
          const loadPageFont = (pageNum) => {
            const fontId = 'dynamicQPCPageFont';
            let styleTag = document.getElementById(fontId);
            if (styleTag) styleTag.remove();
            
            styleTag = document.createElement('style');
            styleTag.id = fontId;
            
            // Use settingsStore to check if tajweed is enabled
            const tajweed = settingsStore.tajweedEnabled;
            
            let src;
            if (tajweed) {
              src = `src: url('./resources/tajweed/p${pageNum}.woff2') format('woff2')`;
            } else {
              src = `src: url('./resources/font/p${pageNum}.woff2') format('woff2')`;
            }
            
            styleTag.innerHTML = `@font-face { font-family: 'QPCV2Page'; ${src}; font-weight: normal; font-style: normal; }`;
            document.head.appendChild(styleTag);
            console.log(`[Murajah] Loaded font for page ${pageNum} (tajweed: ${tajweed})`);
          };

          // ===== Calendar View Functions =====
          const getDayStatus = (date) => {
            // Check if this is today's date
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            // For today, check todayGoal first
            if (date === todayStr && dailyGoalsStore.todayGoal) {
              const tasks = Object.values(dailyGoalsStore.todayGoal.tasks);
              const totalSelected = dailyGoalsStore.selectedTasks.length;
              const completedCount = tasks.filter(t => t.completed).length;
              
              if (completedCount === totalSelected && totalSelected > 0) return 'complete';
              if (completedCount > 0) return 'partial';
              return 'none';
            }
            
            // For other dates, find goal in history
            const goal = dailyGoalsStore.goalHistory.find(g => g.date === date);
            if (!goal) return 'none'; // No goal recorded
            
            const tasks = Object.values(goal.tasks);
            const totalSelected = dailyGoalsStore.selectedTasks.length;
            const completedCount = tasks.filter(t => t.completed).length;
            
            if (completedCount === totalSelected && totalSelected > 0) return 'complete'; // All tasks done
            if (completedCount > 0) return 'partial'; // Some tasks done
            return 'none'; // No tasks done
          };

          // Analytics Dashboard Computed Properties
          const completedDays = computed(() => {
            return dailyGoalsStore.goalHistory.filter(g => {
              const tasks = Object.values(g.tasks);
              const completed = tasks.filter(t => t.completed).length;
              return completed === dailyGoalsStore.selectedTasks.length && dailyGoalsStore.selectedTasks.length > 0;
            }).length;
          });

          const totalDays = computed(() => {
            // Count days with goalHistory + today if has todayGoal
            let total = dailyGoalsStore.goalHistory.length;
            if (dailyGoalsStore.todayGoal) total += 1;
            return total;
          });

          const completionRate = computed(() => {
            if (totalDays.value === 0) return 0;
            return Math.round((completedDays.value / totalDays.value) * 100);
          });

          const streakMessage = computed(() => {
            const streak = dailyGoalsStore.streak;
            if (streak === 0) return 'Start your streak today!';
            if (streak === 1) return '1 day strong';
            if (streak < 7) return `${streak} days going`;
            if (streak < 30) return `${Math.floor(streak / 7)} weeks strong`;
            return `${Math.floor(streak / 30)} months strong`;
          });

          // Breakdown percentages
          const completePercentage = computed(() => {
            if (totalDays.value === 0) return 0;
            return Math.round((completedDays.value / totalDays.value) * 100);
          });

          const partialDays = computed(() => {
            return dailyGoalsStore.goalHistory.filter(g => {
              const tasks = Object.values(g.tasks);
              const completed = tasks.filter(t => t.completed).length;
              return completed > 0 && completed < dailyGoalsStore.selectedTasks.length;
            }).length;
          });

          const partialPercentage = computed(() => {
            if (totalDays.value === 0) return 0;
            return Math.round((partialDays.value / totalDays.value) * 100);
          });

          const nonePercentage = computed(() => {
            return 100 - completePercentage.value - partialPercentage.value;
          });

          // Last 30 days trend
          const last30DaysTrend = computed(() => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const trend = [];

            for (let i = 29; i >= 0; i--) {
              const date = new Date(today);
              date.setDate(date.getDate() - i);
              const dateStr = date.toISOString().split('T')[0];

              // Check today's goal first
              if (dateStr === today.toISOString().split('T')[0] && dailyGoalsStore.todayGoal) {
                const tasks = Object.values(dailyGoalsStore.todayGoal.tasks);
                const completed = tasks.filter(t => t.completed).length;
                if (completed === dailyGoalsStore.selectedTasks.length && dailyGoalsStore.selectedTasks.length > 0) {
                  trend.push('complete');
                } else if (completed > 0) {
                  trend.push('partial');
                } else {
                  trend.push('none');
                }
              } else {
                // Check history
                const goal = dailyGoalsStore.goalHistory.find(g => g.date === dateStr);
                if (goal) {
                  const tasks = Object.values(goal.tasks);
                  const completed = tasks.filter(t => t.completed).length;
                  if (completed === dailyGoalsStore.selectedTasks.length && dailyGoalsStore.selectedTasks.length > 0) {
                    trend.push('complete');
                  } else if (completed > 0) {
                    trend.push('partial');
                  } else {
                    trend.push('none');
                  }
                } else {
                  trend.push('none');
                }
              }
            }

            return trend;
          });

          // Recent activity log
          const recentActivity = computed(() => {
            const activities = [];

            // Add completion activities from last 7 days
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            dailyGoalsStore.goalHistory.slice(-7).forEach(goal => {
              const tasks = Object.values(goal.tasks);
              const completed = tasks.filter(t => t.completed).length;
              
              if (completed > 0) {
                const goalDate = new Date(goal.date);
                const isToday = goal.date === today.toISOString().split('T')[0];
                const isYesterday = goal.date === new Date(today.getTime() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                let dateText = goalDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                if (isToday) dateText = 'Today';
                else if (isYesterday) dateText = 'Yesterday';

                activities.push({
                  text: `${completed}/${dailyGoalsStore.selectedTasks.length} tasks completed`,
                  date: dateText,
                  icon: 'fa-check-circle',
                  color: completed === dailyGoalsStore.selectedTasks.length ? 'text-green-600' : 'text-yellow-600'
                });
              }
            });

            return activities.reverse();
          });

          // Helper method for trend tooltip
          const getTrendDayTooltip = (index, status) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const date = new Date(today);
            date.setDate(date.getDate() - (29 - index));
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            return `${dateStr}: ${status}`;
          };

          const getDayStatusColor = (status) => {
            switch (status) {
              case 'complete':
                return 'bg-green-500 hover:bg-green-600'; // Green for all tasks
              case 'partial':
                return 'bg-yellow-400 hover:bg-yellow-500'; // Yellow for some tasks
              case 'none':
              default:
                return 'bg-gray-200  hover:bg-gray-300'; // Gray for none
            }
          };

          const getDayTooltip = (date) => {
            // Check if this is today's date
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            // For today, use todayGoal
            if (date === todayStr && dailyGoalsStore.todayGoal) {
              const tasks = Object.values(dailyGoalsStore.todayGoal.tasks);
              const completed = tasks.filter(t => t.completed).length;
              const total = dailyGoalsStore.selectedTasks.length;
              return `${completed}/${total} tasks completed on ${new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}`;
            }
            
            // For other dates, find in history
            const goal = dailyGoalsStore.goalHistory.find(g => g.date === date);
            if (!goal) return 'No goal';
            
            const tasks = Object.values(goal.tasks);
            const completed = tasks.filter(t => t.completed).length;
            const total = dailyGoalsStore.selectedTasks.length;
            
            return `${completed}/${total} tasks completed on ${new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}`;
          };

          // GitHub-style contribution graph: Last 365 days
          const contributionGraph = computed(() => {
            // Last 365 days ending with today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const endDate = new Date(today);
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 364); // 365 days including today
            
            // Start with the actual first day (no padding at start)
            const weeks = [];
            let currentWeek = [];
            let currentDate = new Date(startDate);
            
            // Add all 365 days
            while (currentDate <= endDate) {
              const dateStr = currentDate.toISOString().split('T')[0];
              const status = getDayStatus(dateStr);
              
              currentWeek.push({
                date: dateStr,
                dateObj: new Date(currentDate),
                status: status,
                tooltip: getDayTooltip(dateStr)
              });
              
              // Start new week on Sunday (7 items per week)
              if (currentWeek.length === 7) {
                weeks.push([...currentWeek]);
                currentWeek = [];
              }
              
              currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Add remaining partial week with padding at the END
            if (currentWeek.length > 0) {
              // Pad with empty days at end to complete the week
              while (currentWeek.length < 7) {
                currentWeek.push(null);
              }
              weeks.push(currentWeek);
            }
            
            return weeks;
          });

          // Month labels for GitHub-style graph (last 365 days)
          const monthLabels = computed(() => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const endDate = new Date(today);
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 364);
            
            const labels = [];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            let currentDate = new Date(startDate);
            let lastMonth = -1;
            let dayCount = 0; // Days since start
            
            // Add labels for each month that appears in the 365-day range
            while (currentDate <= endDate) {
              const month = currentDate.getMonth();
              
              // If month changed and we haven't added label yet
              if (month !== lastMonth) {
                // Calculate which week this month starts in (day count / 7)
                const monthWeek = Math.floor(dayCount / 7);
                labels.push({
                  name: monthNames[month],
                  weekIndex: monthWeek
                });
                lastMonth = month;
              }
              
              currentDate.setDate(currentDate.getDate() + 1);
              dayCount++;
            }
            
            return labels;
          });

          const hoverTooltip = ref({ visible: false, x: 0, y: 0, text: '' });

          const showCalendarTooltip = (event, tooltip) => {
            const rect = event.target.getBoundingClientRect();
            hoverTooltip.value = {
              visible: true,
              x: rect.left + rect.width / 2,
              y: rect.top - 10,
              text: tooltip
            };
          };

          const hideCalendarTooltip = () => {
            hoverTooltip.value.visible = false;
          };

          // Lifecycle
          onMounted(async () => {
            await initializeApp();
            
            // Apply theme to html and body elements
            applyThemeToDOM(appStore.theme);
            
            // Load font for initial page
            loadPageFont(appStore.currentPage);
          });

          // Watch URL changes and load font when page changes
          watch(() => appStore.currentPage, (newPage) => {
            updateURL();
            loadPageFont(newPage);
          });

          // Watch theme changes and apply to document
          watch(() => appStore.theme, (newTheme) => {
            applyThemeToDOM(newTheme);
            console.log('[Murajah] Theme changed to:', newTheme);
          });

          // Watch tajweed setting and reload font when toggled
          watch(() => settingsStore.tajweedEnabled, () => {
            loadPageFont(appStore.currentPage);
            console.log('[Murajah] Tajweed setting changed, font reloaded');
          });

          // Watch fontSize setting and save changes
          watch(() => settingsStore.fontSize, (newFontSize) => {
            console.log('[Murajah] Font size changed to:', newFontSize);
            saveDataBackground();
          });

          // Watch settings that affect daily goals (finishRevisionDays and selectedTasks)
          watch(() => [settingsStore.finishRevisionDays, dailyGoalsStore.selectedTasks.length], async () => {
            console.log('[Murajah] Settings changed, reinitializing daily goals');
            // Reinitialize today's goals with new settings
            await reinitializeDailyGoalsWithNewSettings();
          });

          // Keyboard shortcuts handler
          const handleKeyboardShortcut = (event) => {
            // Don't trigger shortcuts if user is typing in an input field
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
              return;
            }

            // Don't trigger shortcuts if Ctrl, Cmd, or Alt are pressed (let browser handle these)
            if (event.ctrlKey || event.metaKey || event.altKey) {
              return;
            }

            const key = event.key.toLowerCase();
            
            // T - Toggle Tajweed
            if (key === 't') {
              event.preventDefault();
              settingsStore.tajweedEnabled = !settingsStore.tajweedEnabled;
              updateSettings();
              appStore.successMessage = `Tajweed ${settingsStore.tajweedEnabled ? 'enabled' : 'disabled'}`;
              setTimeout(() => appStore.successMessage = '', 2000);
              console.log('[Murajah] Tajweed toggled via keyboard:', settingsStore.tajweedEnabled);
            }
            
            // Left Arrow - Previous Page
            if (event.key === 'ArrowLeft') {
              event.preventDefault();
              previousPage();
              console.log('[Murajah] Previous page via keyboard');
            }
            
            // Right Arrow - Next Page
            if (event.key === 'ArrowRight') {
              event.preventDefault();
              nextPage();
              console.log('[Murajah] Next page via keyboard');
            }
            
            // M - Toggle Memorized
            if (key === 'm') {
              event.preventDefault();
              toggleMemorized();
              console.log('[Murajah] Memorized toggled via keyboard');
            }
            
            // P - Perfect Revision
            if (key === 'p') {
              event.preventDefault();
              incrementPerfectRevision(appStore.currentPage);
              console.log('[Murajah] Perfect revision via keyboard');
            }
            
            // D - Toggle Dark Mode
            if (key === 'd') {
              event.preventDefault();
              toggleTheme();
              appStore.successMessage = `${appStore.theme === 'dark' ? 'Dark' : 'Light'} mode`;
              setTimeout(() => appStore.successMessage = '', 2000);
              console.log('[Murajah] Theme toggled via keyboard:', appStore.theme);
            }
            
            // R - Random Page
            if (key === 'r') {
              event.preventDefault();
              selectRandomPage();
              console.log('[Murajah] Random page selected via keyboard');
            }
            
            // G - Go to page (with prompt)
            if (key === 'g') {
              event.preventDefault();
              const pageNum = prompt('Go to page (1-604):', appStore.currentPage.toString());
              if (pageNum) {
                const num = parseInt(pageNum);
                if (!isNaN(num) && num >= 1 && num <= 604) {
                  appStore.currentPage = num;
                  updateURL();
                } else {
                  appStore.errorMessage = 'Invalid page number';
                  setTimeout(() => appStore.errorMessage = '', 2000);
                }
              }
              console.log('[Murajah] Go to page via keyboard');
            }
            
            // ? or H - Show Help (keyboard shortcuts)
            if (key === '?' || key === 'h') {
              event.preventDefault();
              showKeyboardShortcutsHelp();
            }
          };

          const showKeyboardShortcutsHelp = () => {
            const shortcuts = `
Murajah Keyboard Shortcuts:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Navigation:
  ← / → Arrow Keys   Navigate between pages
  G                  Go to specific page
  R                  Random memorized page

Memorization:
  M                  Toggle memorized status
  P                  Mark perfect revision
  T                  Toggle Tajweed colors

Display:
  D                  Toggle dark mode
  ? / H              Show this help menu

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            `;
            alert(shortcuts);
            console.log('[Murajah] Keyboard shortcuts displayed');
          };

          // Add keyboard event listener on mount
          onMounted(() => {
            document.addEventListener('keydown', handleKeyboardShortcut);
            console.log('[Murajah] Keyboard shortcuts enabled');
          });

          // Clean up keyboard listener before unmount (optional for Vue 3)
          const cleanupKeyboardListener = () => {
            document.removeEventListener('keydown', handleKeyboardShortcut);
            console.log('[Murajah] Keyboard shortcuts disabled');
          };

          return {
            appStore,
            settingsStore,
            memorizedStore,
            mistakesStore,
            audioStore,
            perfectRevisionsStore,
            dailyGoalsStore,
            isInitializing,
            quranData,
            gotoInput,
            showSettingsModal,
            statistics,
            recentRecordings,
            formattedCompletion,
            currentJuzProgress,
            daysRemaining,
            bulkStartPage,
            bulkEndPage,
            bulkWarning,
            selectedJuzPreset,
            getJuzRange,
            juzMemorizedCount,
            getJuzMemorizedPercentage,
            getJuzGradientStyle,
            getSurahStartPage,
            currentPageText,
            currentPageWords,
            fontSizeStyle,
            hoveredWordId,
            showTooltip,
            tooltipX,
            tooltipY,
            tooltipText,
            isCurrentPageMemorized,
            currentPagePerfectCount,
            currentPageHifzStatus,
            currentPageAudioCount,
            currentPageMistakeCount,
            currentPageMistakes,
            currentSurahName,
            recordingDuration,
            previousPage,
            nextPage,
            gotoPage,
            goToPageNumber,
            selectRandomPage,
            toggleTheme,
            toggleMemorized,
            incrementPerfectRevision,
            highlightWord,
            showWordTooltip,
            updateTooltipPosition,
            hideWordTooltip,
            getSurahNameArabic,
            updateSettings,
            clearPageMistakes,
            bulkMemorize,
            bulkMemorizePreset,
            playAudio,
            startRecording,
            stopRecording,
            cancelRecording,
            deleteAudio,
            formatAudioDuration,
            AudioRecorder,
            exportData,
            importData,
            resetApp,
            loadPageFont,
            handleKeyboardShortcut,
            showKeyboardShortcutsHelp,
            cleanupKeyboardListener,
            initializeDailyGoals,
            reinitializeDailyGoalsWithNewSettings,
            saveDailyGoal,
            completeTaskGoal,
            uncompleteTaskGoal,
            getTaskProgressPercentage,
            getDayStatus,
            getDayStatusColor,
            getDayTooltip,
            contributionGraph,
            monthLabels,
            hoverTooltip,
            showCalendarTooltip,
            hideCalendarTooltip,
            completedDays,
            totalDays,
            completionRate,
            streakMessage,
            completePercentage,
            partialDays,
            partialPercentage,
            nonePercentage,
            last30DaysTrend,
            recentActivity,
            getTrendDayTooltip
          };
        }
      });

      app.mount('#app');
    })();
  </script>
</body>
</html>
