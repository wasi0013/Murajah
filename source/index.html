<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Murajah - Quran Memorization App">
  <meta name="theme-color" content="#1f2937">
  <title>Murajah - Quran Memorization</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="./resources/favicon.ico">
  
  <!-- Tailwind CSS -->
  <script src="./resources/js/tailwind.3.4.7.js"></script>
  
  <!-- Line Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Vue 3 -->
  <script src="./resources/js/vue.global.js"></script>

  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #1e40af;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Surah Names Font */
    @font-face {
      font-family: 'SurahNames';
      src: url('./resources/surah_names.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
      unicode-range: U+0600-U+06FF;
    }

    html {
      scroll-behavior: smooth;
      background-color: #ffffff;
      color: #111827;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    html.dark {
      background-color: #111827;
      color: #f3f4f6;
    }

    body {
      transition: background-color 0.3s ease, color 0.3s ease;
      background-color: inherit;
      color: inherit;
    }

    body.dark-mode {
      background-color: #111827;
      color: #f3f4f6;
    }

    body:not(.dark-mode) {
      background-color: #ffffff;
      color: #111827;
    }

    /* Root app container */
    #app {
      background-color: inherit;
      color: inherit;
      transition: background-color 0.3s ease, color 0.3s ease;
      min-height: 100vh;
    }

    /* Main app wrapper */
    .dark-mode {
      background-color: #111827;
      color: #f3f4f6;
    }

    .dark-mode main {
      background-color: #111827;
      color: #f3f4f6;
    }

    /* Quran Text Styling */
    .quran-text {
      font-family: 'QPCV2Page', 'Traditional Arabic', 'Arial Unicode MS', sans-serif;
      line-height: 1.1;
      direction: rtl;
      text-align: right;
      letter-spacing: 0.1em;
      color: #111827; /* Explicit color for light mode */
      background-color: #f3f4f6; /* Light mode background */
    }

    .dark-mode .quran-text {
      color: #1a1a1a; /* Black text in dark mode */
      background-color: #d4b896; /* Sepia/parchment color for dark mode */
    }

    .quran-text-small {
      font-size: 20px !important;
    }

    .quran-text-medium {
      font-size: 32px !important;
    }

    .quran-text-large {
      font-size: 44px !important;
    }

    .quran-word {
      display: inline-block;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0.25rem;
      border-radius: 4px;
      color: inherit; /* Ensure text inherits from parent */
    }

    .quran-word:hover {
      @apply bg-blue-200 text-blue-900;
    }

    .quran-word.mistake {
      @apply bg-red-200 text-red-900;
    }

    .quran-word.memorized-highlight {
      @apply bg-green-200 text-green-900;
    }

    .dark-mode .quran-word:hover {
      background-color: #c4a876;
      color: #1a1a1a;
    }

    .dark-mode .quran-word.mistake {
      background-color: #d97777;
      color: #1a1a1a;
    }

    .dark-mode .quran-word.memorized-highlight {
      background-color: #9acd32;
      color: #1a1a1a;
    }

    /* Responsive Quran Text - Mobile Optimization */
    @media (max-width: 640px) {
      /* Small phones */
      .quran-text {
        line-height: 1.2;
      }
      .quran-word {
        padding: 0.05rem 0.1rem;
      }
    }

    @media (max-width: 768px) and (min-width: 641px) {
      /* Tablets and medium devices */
      .quran-text {
        line-height: 1.35;
      }
      .quran-word {
        padding: 0.08rem 0.15rem;
      }
    }

    @media (min-width: 1024px) {
      /* Desktop and larger screens */
      .quran-text {
        line-height: 1.6;
      }
      .quran-word {
        padding: 0.1rem 0.25rem;
      }
    }

    /* Surah Name Styling - keep black text for readability */
    .quran-text .surah-name {
      font-family: 'SurahNames', 'Traditional Arabic', serif;
      color: #000 !important;
      font-size: 2.25rem;
    }

    .dark-mode .quran-text .surah-name {
      color: #000 !important;
    }

    /* Basmallah styling */
    .quran-text .basmallah {
      color: #000 !important;
      font-size: 2.25rem;
    }

    .dark-mode .quran-text .basmallah {
      color: #000 !important;
    }

    /* Smooth Transitions */
    .transition-all {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Touch Targets */
    button, a {
      min-height: 44px;
      min-width: 44px;
    }

    /* Loading Animation */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    /* Progress Bar */
    .progress-bar {
      height: 6px;
      background-color: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }

    .dark-mode .progress-bar {
      background-color: #374151;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #10b981);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 50;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Modal */
    .modal-backdrop {
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Responsive Grid */
    .bubble-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(20px, 1fr));
      gap: 4px;
      padding: 16px;
    }

    .memorized-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
      gap: 8px;
      padding: 16px;
    }

    .dark-mode * {
      color-scheme: dark;
    }

    /* Dark mode backgrounds for major sections */
    .dark-mode header,
    .dark-mode main,
    .dark-mode footer {
      background-color: inherit;
      color: inherit;
    }

    /* Card backgrounds in dark mode */
    .dark-mode .bg-white {
      background-color: #1f2937;
      color: #f3f4f6;
    }

    .dark-mode .bg-gray-50 {
      background-color: #111827;
      color: #f3f4f6;
    }

    .dark-mode .bg-gray-100 {
      background-color: #1f2937;
      color: #f3f4f6;
    }

    .dark-mode .bg-gray-200 {
      background-color: #374151;
      color: #f3f4f6;
    }

    /* Ensure text in dark mode sections is visible */
    .dark-mode p,
    .dark-mode span,
    .dark-mode div,
    .dark-mode label,
    .dark-mode h1,
    .dark-mode h2,
    .dark-mode h3,
    .dark-mode h4,
    .dark-mode h5,
    .dark-mode h6 {
      color: inherit;
    }

    /* Enhanced button styling for dark mode */
    .dark-mode button {
      color: inherit;
    }

    /* Focus Visible for Accessibility */
    button:focus-visible, a:focus-visible, input:focus-visible {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }

    .dark-mode button:focus-visible, .dark-mode a:focus-visible, .dark-mode input:focus-visible {
      outline: 2px solid #60a5fa;
      outline-offset: 2px;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background-color: #f3f4f6;
    }

    .dark-mode ::-webkit-scrollbar-track {
      background-color: #1f2937;
    }

    ::-webkit-scrollbar-thumb {
      background-color: #9ca3af;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: #6b7280;
    }

    .dark-mode ::-webkit-scrollbar-thumb {
      background-color: #4b5563;
      border-radius: 4px;
    }

    .dark-mode ::-webkit-scrollbar-thumb:hover {
      background-color: #6b7280;
    }

    /* Ensure text elements maintain proper colors in dark mode */
    .dark-mode p,
    .dark-mode span,
    .dark-mode div,
    .dark-mode label,
    .dark-mode h1,
    .dark-mode h2,
    .dark-mode h3,
    .dark-mode h4,
    .dark-mode h5,
    .dark-mode h6 {
      color: inherit;
    }

    /* Ensure option elements have proper text in dark mode */
    .dark-mode option {
      background-color: #374151;
      color: #f3f4f6;
    }

    /* Enhancement for select elements */
    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'%3E%3C/path%3E%3C/svg%3E");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
      appearance: none;
    }

    .dark-mode select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%9CA3AF' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'%3E%3C/path%3E%3C/svg%3E");
    }
  </style>
</head>
<body class="overflow-x-hidden">
  <div id="app"></div>

  <script type="module">
    // Access Vue from global scope since it's loaded as a script tag
    const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

    // IIFE to handle async imports
    (async () => {
      // ==================== IndexedDB Manager ====================
      class MurajahDB {
        constructor() {
          this.dbName = 'murajah-db';
          this.version = 1;
          this.db = null;
        }

        async init() {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.version);

            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
              this.db = request.result;
              console.log('[Murajah] IndexedDB initialized');
              resolve();
            };

            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              
              // Create object stores if they don't exist
              if (!db.objectStoreNames.contains('appData')) {
                db.createObjectStore('appData', { keyPath: 'id' });
              }
              if (!db.objectStoreNames.contains('recordings')) {
                db.createObjectStore('recordings', { keyPath: 'id', autoIncrement: true });
              }
              console.log('[Murajah] IndexedDB schema created');
            };
          });
        }

        async saveData(data) {
          const tx = this.db.transaction(['appData'], 'readwrite');
          const store = tx.objectStore('appData');
          store.put({ id: 'murajah-data', ...data });
          return new Promise((resolve, reject) => {
            tx.oncomplete = () => {
              console.log('[Murajah] Data saved to IndexedDB');
              resolve();
            };
            tx.onerror = () => reject(tx.error);
          });
        }

        async loadData() {
          const tx = this.db.transaction(['appData'], 'readonly');
          const store = tx.objectStore('appData');
          return new Promise((resolve, reject) => {
            const request = store.get('murajah-data');
            request.onsuccess = () => {
              const result = request.result;
              if (result) {
                const { id, ...data } = result;
                resolve(data);
              } else {
                resolve(null);
              }
            };
            request.onerror = () => reject(request.error);
          });
        }

        async clearAll() {
          const tx = this.db.transaction(['appData', 'recordings'], 'readwrite');
          tx.objectStore('appData').clear();
          tx.objectStore('recordings').clear();
          return new Promise((resolve, reject) => {
            tx.oncomplete = () => {
              console.log('[Murajah] IndexedDB cleared');
              resolve();
            };
            tx.onerror = () => reject(tx.error);
          });
        }

        async saveRecording(index, recording) {
          const tx = this.db.transaction(['recordings'], 'readwrite');
          const store = tx.objectStore('recordings');
          store.put({ id: `recording-${index}`, ...recording });
          return new Promise((resolve, reject) => {
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
          });
        }

        async loadRecording(index) {
          const tx = this.db.transaction(['recordings'], 'readonly');
          const store = tx.objectStore('recordings');
          return new Promise((resolve, reject) => {
            const request = store.get(`recording-${index}`);
            request.onsuccess = () => {
              const result = request.result;
              if (result) {
                const { id, ...data } = result;
                resolve(data);
              } else {
                resolve(null);
              }
            };
            request.onerror = () => reject(request.error);
          });
        }

        async deleteRecording(index) {
          const tx = this.db.transaction(['recordings'], 'readwrite');
          const store = tx.objectStore('recordings');
          store.delete(`recording-${index}`);
          return new Promise((resolve, reject) => {
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
          });
        }

        async saveTheme(theme) {
          const tx = this.db.transaction(['appData'], 'readwrite');
          const store = tx.objectStore('appData');
          store.put({ id: 'murajah-theme', value: theme });
          return new Promise((resolve, reject) => {
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
          });
        }

        async loadTheme() {
          const tx = this.db.transaction(['appData'], 'readonly');
          const store = tx.objectStore('appData');
          return new Promise((resolve, reject) => {
            const request = store.get('murajah-theme');
            request.onsuccess = () => {
              const result = request.result;
              resolve(result ? result.value : 'light');
            };
            request.onerror = () => reject(request.error);
          });
        }
      }

      // Initialize IndexedDB
      const murajahDB = new MurajahDB();
      await murajahDB.init();

      // Import utility modules
      const dataLoaderModule = await import('./resources/js/utils/dataLoader.js');
      const { loadAllQuranData, getPageText, getPageWordsDetailed } = dataLoaderModule;
      
      const calculationsModule = await import('./resources/js/utils/calculations.js');
      const { 
        calculateMemorizationPercentage, 
        calculateProgress,
        formatDuration,
        generateMistakeBubbles,
        generateMemorizedGrid,
        calculateStatistics,
        estimateCompletionDate,
        formatDate,
        getScoreColor,
        generatePageRange
      } = calculationsModule;
      
      const audioRecorderModule = await import('./resources/js/utils/audioRecorder.js');
      const AudioRecorder = audioRecorderModule.default;

      const app = createApp({
        template: `
          <div :class="{ 'dark-mode': appStore.theme === 'dark' }" class="min-h-screen transition-all bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
            <!-- Loading Screen -->
            <div v-if="isInitializing" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
              <div class="text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-white mb-4"></i>
                <p class="text-white text-lg">Loading Murajah...</p>
              </div>
            </div>

            <!-- Header -->
            <header class="bg-white dark:bg-gray-800 shadow">
              <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <img src="./resources/logo-bg.png" alt="Murajah" class="h-25 w-auto" style="border-radius: 15%;">
                </div>
                <nav class="flex items-center gap-6">
                  <a href="./index.html#quran-text-section" class="text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 font-medium transition-colors">Memorize</a>
                  <a href="./quiz.html" class="text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 font-medium transition-colors">Quiz</a>
                </nav>
                <div class="flex items-center gap-4">
 
                  
                  <button @click="toggleTheme" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" :title="appStore.theme === 'light' ? 'Dark Mode' : 'Light Mode'">
                    <span v-if="appStore.theme === 'light'" class="text-orange-500 text-xl">☀️</span>
                    <span v-else class="text-yellow-500 text-xl">🌙</span>
                  </button>

                  <button @click="showSettingsModal = true" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" title="Settings">
                    <i class="fas fa-cog text-gray-700 dark:text-gray-200 text-xl"></i>
                  </button>
                </div>
              </div>
            </header>

            <!-- Main Content -->
            <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
              <!-- Daily Revision Banner -->
              <div v-if="memorizedStore.memorizedPages.size > 0" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg shadow-lg p-6 flex items-center justify-between">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2 flex items-center gap-2">
                    <i class="fas fa-calendar-check"></i>
                    Daily Revision
                  </h3>
                  <p class="text-sm opacity-90">Revise pages from your memorized collection today</p>
                </div>
                <button 
                  @click="selectRandomPage" 
                  class="ml-4 px-6 py-3 bg-white text-green-600 font-bold rounded-lg hover:bg-gray-100 transition-colors whitespace-nowrap flex items-center gap-2"
                >
                  <i class="fas fa-random"></i>
                  Random Page
                </button>
              </div>

              <!-- Status Indicators Row -->
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-blue-500 text-white p-6 rounded-lg shadow">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm opacity-90">Memorized</p>
                      <p class="text-3xl font-bold">{{ statistics.memorized }} <i class="fas fa-file-alt text-2xl"></i></p>
                      <p class="text-xs opacity-75">{{ statistics.percentage }}%</p>
                    </div>
                    <i class="fas fa-bookmark text-4xl opacity-30"></i>
                  </div>
                </div>

                <div class="bg-purple-500 text-white p-6 rounded-lg shadow">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm opacity-90">Perfect Revisions</p>
                      <p class="text-3xl font-bold">{{ statistics.perfectRevisions }}</p>
                      <p class="text-xs opacity-75">Avg: {{ statistics.averagePerfect }}/page</p>
                    </div>
                    <i class="fas fa-star text-4xl opacity-30"></i>
                  </div>
                </div>

                <div class="bg-red-500 text-white p-6 rounded-lg shadow">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm opacity-90">Mistakes</p>
                      <p class="text-3xl font-bold">{{ statistics.mistakes }}</p>
                      <p class="text-xs opacity-75">Word-level</p>
                    </div>
                    <i class="fas fa-exclamation-circle text-4xl opacity-30"></i>
                  </div>
                </div>

                <div class="bg-green-500 text-white p-6 rounded-lg shadow">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm opacity-90">Recordings</p>
                      <p class="text-3xl font-bold">{{ statistics.audios }}</p>
                      <p class="text-xs opacity-75">Audio practice</p>
                    </div>
                    <i class="fas fa-microphone text-4xl opacity-30"></i>
                  </div>
                </div>
              </div>

              <!-- Progress Section -->
              <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 space-y-4">
                <div class="flex items-center justify-between">
                  <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Progress</h2>
                  <span class="text-sm text-gray-600 dark:text-gray-400">{{ statistics.memorized }}/604 Pages</span>
                </div>

                <div class="space-y-2">
                  <div class="progress-bar">
                    <div class="progress-fill" :style="{ width: statistics.percentage + '%' }"></div>
                  </div>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
                  <div>
                    <p class="text-gray-600 dark:text-gray-400">Remaining</p>
                    <p class="text-xl font-bold">{{ statistics.remaining }}</p>
                  </div>
                  <div>
                    <p class="text-gray-600 dark:text-gray-400">Juzs (Parts)</p>
                    <p class="text-xl font-bold">{{ statistics.juzCount }}/30</p>
                  </div>
                  <div>
                    <p class="text-gray-600 dark:text-gray-400">Est. Completion</p>
                    <p class="text-sm font-bold">{{ formattedCompletion }}</p>
                  </div>
                </div>
              </div>

              <!-- Quran Text Display with Overlay Navigation -->
              <div id="quran-text-section" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8 space-y-6 border-2 border-blue-200 dark:border-blue-900 relative group">
                <div class="text-center space-y-2">
                  <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Page {{ appStore.currentPage }} of 604</p>
                  <h2 class="text-3xl font-bold text-blue-600 dark:text-blue-400" style="font-family: 'SurahNames', 'Traditional Arabic', serif;">{{ currentSurahName }}</h2>
                </div>

                <!-- Quran Text Content - Word by Word Display -->
                <div v-if="quranData && currentPageWords.length > 0" :style="fontSizeStyle" class="quran-text text-center p-8 rounded-lg min-h-96 overflow-y-auto space-y-4 relative">
                  <!-- Hifz Status Bookmark -->
                  <div v-if="currentPageHifzStatus" class="absolute top-0 right-0 -mr-1" style="width: 60px; height: 100px;">
                    <svg viewBox="0 0 60 100" class="w-full h-full drop-shadow-lg" style="filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1)); opacity:60%;">
                      <!-- Bookmark shape -->
                      <defs>
                        <linearGradient id="bookmarkGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" :style="{ stopColor: currentPageHifzStatus.bg, stopOpacity: 1 }" />
                          <stop offset="100%" :style="{ stopColor: currentPageHifzStatus.bg, stopOpacity: 0.85 }" />
                        </linearGradient>
                      </defs>
                      <path d="M 0 0 L 60 0 L 60 75 L 30 60 L 0 75 Z" fill="url(#bookmarkGradient)" stroke="rgba(0,0,0,0.1)" stroke-width="1"/>
                      <!-- Icon in center -->
                      <g transform="translate(30, 20)">
                        <circle cx="0" cy="0" r="16" fill="white" opacity="0.75"/>
                        <text x="0" y="0" text-anchor="middle" dominant-baseline="middle" class="text-lg font-bold" fill="currentColor" :style="{ fill: currentPageHifzStatus.bg, fontSize: '20px' }">
                          <tspan v-if="currentPageHifzStatus.icon === 'la-star'">★</tspan>
                          <tspan v-else-if="currentPageHifzStatus.icon === 'la-check-circle'">✓</tspan>
                          <tspan v-else-if="currentPageHifzStatus.icon === 'la-thumbs-up'">👍</tspan>
                          <tspan v-else-if="currentPageHifzStatus.icon === 'la-exclamation-circle'">!</tspan>
                          <tspan v-else-if="currentPageHifzStatus.icon === 'la-exclamation-triangle'">⚠</tspan>
                          <tspan v-else>📌</tspan>
                        </text>
                      </g>
                      <!-- Score label -->
                      <text x="30" y="55" text-anchor="middle" font-size="10" font-weight="bold" fill="white">
                        {{ currentPageHifzStatus.label }}
                      </text>
                    </svg>
                  </div>

                  <!-- Mistakes Counter Badge -->
                  <div v-if="currentPageMistakeCount > 0" class="absolute top-2 left-7 text-red-500 font-bold text-2xl" style="opacity: 0.4;" title="Number of mistakes on this page">
                    {{ currentPageMistakeCount }}
                  </div>

                  <div v-for="(line, lineIdx) in currentPageWords" :key="lineIdx" class="flex flex-wrap justify-center gap-2">
                    <!-- Surah Name Display -->
                    <div v-if="line.type === 'surah_name'" class="w-full text-4xl font-black text-black dark:text-black my-4 text-center" style="font-family: 'SurahNames', 'Traditional Arabic', serif;">
                      {{ getSurahNameArabic(parseInt(line.text.replace('Surah ', ''))) }}
                      <div v-if="parseInt(line.text.replace('Surah ', '')) !== 9" class="text-4xl mt-2">﷽</div>
                    </div>
                    
                    <!-- Words Display -->
                    <span 
                      v-for="word in line.words" 
                      :key="word.id"
                      @click="highlightWord(word)"
                      @mouseenter="showWordTooltip(word, $event)"
                      @mousemove="updateTooltipPosition($event)"
                      @mouseleave="hideWordTooltip()"
                      :class="{
                        'bg-blue-100 dark:bg-blue-900 rounded-md px-2 py-1': hoveredWordId === word.id,
                        'bg-red-200 dark:bg-red-900': currentPageMistakes.includes(word.id),
                        'cursor-pointer transition-all duration-200': true
                      }"
                       class="quran-word inline-block"
                    >
                      {{ word.text }}
                    </span>
                  </div>
                </div>

                <!-- Empty State -->
                <div v-else class="flex flex-col items-center justify-center p-12 bg-gray-100 dark:bg-gray-700 rounded-lg">
                  <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                  <p class="text-gray-600 dark:text-gray-400">Loading Quran text...</p>
                </div>

                <!-- Overlay Navigation Arrows (Hidden by default, visible on hover) -->
                <div class="absolute inset-0 flex items-center justify-between px-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none rounded-lg">
                  <!-- Previous Page Arrow -->
                  <button 
                    v-if="appStore.currentPage > 1"
                    @click="previousPage" 
                    class="p-3 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg transition-all pointer-events-auto"
                    style="opacity: 0.75;"
                    :title="'Previous Page (' + (appStore.currentPage - 1) + ')'"
                  >
                    <i class="fas fa-chevron-left text-2xl"></i>
                  </button>
                  <div v-else class="w-12"></div>

                  <!-- Next Page Arrow -->
                  <button 
                    v-if="appStore.currentPage < appStore.totalPages"
                    @click="nextPage" 
                    class="p-3 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg transition-all pointer-events-auto"
                    style="opacity: 0.75;"
                    :title="'Next Page (' + (appStore.currentPage + 1) + ')'"
                  >
                    <i class="fas fa-chevron-right text-2xl"></i>
                  </button>
                  <div v-else class="w-12"></div>
                </div>
              </div>

                <!-- Page Navigation -->
              <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 space-y-3">
                <!-- Navigation Controls -->
                <div class="flex items-center justify-center gap-2 flex-wrap">
                  <button @click="previousPage" :disabled="appStore.currentPage === 1" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all" title="Previous page">
                    <i class="fas fa-chevron-left"></i>
                  </button>

                  <div class="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 px-3 py-2 rounded-lg text-gray-900 dark:text-gray-100">
                    <span class="text-xl font-bold">{{ appStore.currentPage }}</span>
                    <span class="text-gray-600 dark:text-gray-400">/604</span>
                  </div>

                  <input v-model.number="gotoInput" @keyup.enter="gotoPage" type="number" min="1" max="604" class="w-16 px-2 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-400 text-center text-sm" placeholder="Go">
                  <button @click="gotoPage" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">Go</button>

                  <button @click="nextPage" :disabled="appStore.currentPage === 604" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all" title="Next page">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>                <!-- Action Buttons -->
                <div class="flex items-center gap-2 flex-wrap justify-center">
                  <button @click="toggleMemorized" :class="isCurrentPageMemorized ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-400 hover:bg-gray-500'" class="flex items-center gap-1 px-3 py-2 text-white rounded-lg transition-colors text-sm">
                    <i :class="isCurrentPageMemorized ? 'fas fa-check-circle' : 'fas fa-circle'"></i>
                    <span>{{ isCurrentPageMemorized ? 'Memorized' : 'Memorize' }}</span>
                  </button>

                  <button @click="incrementPerfectRevision(appStore.currentPage)" class="flex items-center gap-1 px-3 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors text-sm">
                    <i class="fas fa-star"></i>
                    <span>Perfect</span>
                    <span v-if="currentPagePerfectCount > 0" class="font-bold">({{ currentPagePerfectCount }})</span>
                  </button>

                  <button v-if="AudioRecorder.isSupported() && !audioStore.isRecording" @click="startRecording" class="flex items-center gap-1 px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors text-sm">
                    <i class="fas fa-microphone"></i>
                    <span>Record</span>
                  </button>
                </div>

                <!-- Recording Status -->
                <div v-if="audioStore.isRecording" class="flex items-center gap-3 p-3 bg-red-100 dark:bg-red-900 rounded-lg border-2 border-red-500">
                  <div class="flex-1">
                    <p class="font-bold text-red-700 dark:text-red-200 text-sm">Recording...</p>
                    <p class="text-xs text-red-600 dark:text-red-300">{{ recordingDuration }}</p>
                  </div>
                  <button @click="stopRecording" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm transition-colors">
                    <i class="fas fa-stop"></i>
                  </button>
                  <button @click="cancelRecording" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded text-sm transition-colors">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>

              <!-- Dashboard Stats Grid -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Recent Recordings -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 space-y-4">
                  <h3 class="text-xl font-bold flex items-center gap-2 text-gray-900 dark:text-gray-100">
                    <i class="fas fa-microphone text-blue-600 dark:text-blue-400"></i>
                    Recent Recordings
                  </h3>
                  <div v-if="statistics.audios > 0" class="space-y-3 max-h-48 overflow-y-auto">
                    <div v-for="(recording, idx) in recentRecordings" :key="idx" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-between gap-3">
                      <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-900 dark:text-gray-100">Page {{ recording.pageNumber }}</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400">{{ recording.recordedAt }}</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400" v-if="recording.duration">Duration: {{ formatAudioDuration(recording.duration) }}</p>
                      </div>
                      <div class="flex items-center gap-2">
                        <button @click="playAudio(recording)" class="p-2 hover:bg-blue-600 hover:text-white rounded-lg transition-colors text-gray-600 dark:text-gray-400 dark:hover:text-white" :title="'Play recording for page ' + recording.pageNumber">
                          <i class="fas fa-play"></i>
                        </button>
                        <button @click="deleteAudio(idx)" class="p-2 hover:bg-red-600 hover:text-white rounded-lg transition-colors text-gray-600 dark:text-gray-400 dark:hover:text-white" :title="'Delete recording for page ' + recording.pageNumber">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <div v-else class="text-gray-600 dark:text-gray-400 text-sm">
                    <i class="fas fa-circle-info mr-2"></i> No recordings yet
                  </div>
                </div>

                <!-- Summary Statistics -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 space-y-4">
                  <h3 class="text-xl font-bold flex items-center gap-2 text-gray-900 dark:text-gray-100">
                    <i class="fas fa-chart-bar text-blue-600 dark:text-blue-400"></i>
                    Summary Statistics
                  </h3>
                  <div class="grid grid-cols-2 gap-3">
                    <div class="p-3 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900 dark:to-blue-800 rounded-lg">
                      <p class="text-xs text-gray-600 dark:text-gray-300">Memorized</p>
                      <p class="text-2xl font-bold text-blue-600 dark:text-blue-300">{{ statistics.memorized }}</p>
                      <p class="text-xs text-gray-500 dark:text-gray-400">of 604</p>
                    </div>
                    <div class="p-3 bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900 dark:to-purple-800 rounded-lg">
                      <p class="text-xs text-gray-600 dark:text-gray-300">Juzs</p>
                      <p class="text-2xl font-bold text-purple-600 dark:text-purple-300">{{ statistics.juzCount }}</p>
                      <p class="text-xs text-gray-500 dark:text-gray-400">of 30</p>
                    </div>
                    <div class="p-3 bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900 dark:to-green-800 rounded-lg">
                      <p class="text-xs text-gray-600 dark:text-gray-300">Completion</p>
                      <p class="text-2xl font-bold text-green-600 dark:text-green-300">{{ statistics.percentage }}%</p>
                    </div>
                    <div class="p-3 bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900 dark:to-orange-800 rounded-lg">
                      <p class="text-xs text-gray-600 dark:text-gray-300">Points</p>
                      <p class="text-2xl font-bold text-orange-600 dark:text-orange-300">{{ statistics.totalPoints }}</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Mistake Bubble Grid -->
              <div v-if="currentPageMistakeCount > 0" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 space-y-4">
                <h3 class="text-xl font-bold flex items-center gap-2 text-gray-900 dark:text-gray-100">
                  <i class="fas fa-exclamation-circle text-red-600 dark:text-red-400"></i>
                  Mistakes on Page {{ appStore.currentPage }}
                </h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">{{ currentPageMistakeCount }} mistake(s) found</p>
                
                <!-- Mistake Bubbles Grid -->
                <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-2">
                  <button 
                    v-for="wordId in currentPageMistakes" 
                    :key="wordId"
                    @click="highlightWord({ id: wordId })"
                    class="p-3 rounded-full bg-red-200 dark:bg-red-900 text-red-700 dark:text-red-200 font-bold text-sm hover:bg-red-300 dark:hover:bg-red-800 transition-colors text-center border border-red-300 dark:border-red-700"
                    :title="'Mistake: Word ' + wordId"
                  >
                    {{ wordId }}
                  </button>
                </div>
                
                <button 
                  @click="clearPageMistakes"
                  class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                >
                  Clear All Mistakes
                </button>
              </div>

              <!-- Advanced Analytics Section -->
              <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 space-y-6">
                <h2 class="text-2xl font-bold flex items-center gap-2 text-gray-900 dark:text-gray-100">
                  <i class="fas fa-chart-pie text-purple-600 dark:text-purple-400"></i>
                  Analytics & Progress
                </h2>

                <!-- Juz Progress Grid -->
                <div>
                  <h3 class="text-lg font-bold mb-4 text-gray-900 dark:text-gray-100">Progress by Juz</h3>
                  <div class="grid grid-cols-5 sm:grid-cols-10 gap-2">
                    <button 
                      v-for="juzNum in 30" 
                      :key="juzNum"
                      @click="goToPageNumber(getJuzRange(juzNum)[0])"
                      :class="[
                        'px-3 py-2 rounded-lg font-bold text-sm transition-colors',
                        juzMemorizedCount(juzNum) === (getJuzRange(juzNum)[1] - getJuzRange(juzNum)[0] + 1)
                          ? 'bg-green-500 text-white hover:bg-green-600' 
                          : juzMemorizedCount(juzNum) > 0
                            ? 'bg-yellow-400 text-gray-900 hover:bg-yellow-500'
                            : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600'
                      ]"
                      :title="'Juz ' + juzNum + ': ' + juzMemorizedCount(juzNum) + '/' + (getJuzRange(juzNum)[1] - getJuzRange(juzNum)[0] + 1) + ' pages'"
                    >
                      {{ juzNum }}
                    </button>
                  </div>
                  <p class="text-sm mt-3 flex items-center justify-center gap-4 flex-wrap text-gray-700 dark:text-gray-300">
                    <span><span class="text-green-600 dark:text-green-400 font-semibold">Completed</span></span>|
                    <span><span class="text-yellow-500 dark:text-yellow-400 font-semibold">Partial</span></span>|
                    <span><span class="text-gray-400 dark:text-gray-500 font-semibold">Not started</span></span>
                  </p>
                </div>

                <!-- Completion Estimate -->
                <div class="border-t border-gray-300 dark:border-gray-700 pt-6">
                  <h3 class="text-lg font-bold mb-4 text-gray-900 dark:text-gray-100">Completion Estimate</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-blue-50 dark:bg-blue-900 rounded-lg border border-blue-200 dark:border-blue-700">
                      <p class="text-sm text-gray-600 dark:text-gray-300">Estimated Completion Date</p>
                      <p class="text-2xl font-bold text-blue-600 dark:text-blue-300">{{ formattedCompletion }}</p>
                    </div>
                    <div class="p-4 bg-purple-50 dark:bg-purple-900 rounded-lg border border-purple-200 dark:border-purple-700">
                      <p class="text-sm text-gray-600 dark:text-gray-300">Days Remaining</p>
                      <p class="text-2xl font-bold text-purple-600 dark:text-purple-300">{{ daysRemaining }}</p>
                    </div>
                  </div>
                  <div class="mt-4 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-300 text-sm border border-gray-300 dark:border-gray-600">
                    <p>
                      Based on {{ settingsStore.pagesPerDay }} page(s) per day, you will complete memorization in approximately {{ daysRemaining }} days.
                    </p>
                  </div>
                </div>
              </div>


            </main>

            <!-- Settings Modal -->
            <div v-if="showSettingsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
              <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <!-- Modal Header -->
                <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex items-center justify-between">
                  <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2">
                    <i class="fas fa-cog"></i>
                    Settings
                  </h2>
                  <button @click="showSettingsModal = false" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                  </button>
                </div>

                <!-- Modal Content -->
                <div class="px-6 py-6 space-y-6">
                  <!-- General Settings -->
                  <div class="space-y-4">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2">
                      <i class="fas fa-sliders-h text-blue-600"></i>
                      General Settings
                    </h3>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Pages Per Day</label>
                        <input v-model.number="settingsStore.pagesPerDay" @change="updateSettings" type="number" min="1" max="604" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-400">
                      </div>

                      <div>
                        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Finish in (days)</label>
                        <input v-model.number="settingsStore.finishRevisionDays" @change="updateSettings" type="number" min="1" max="365" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-400">
                      </div>

                      <div>
                        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Font Size</label>
                        <select v-model="settingsStore.fontSize" @change="updateSettings" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-gray-100">
                          <option value="small">Small</option>
                          <option value="medium">Medium</option>
                          <option value="large">Large</option>
                        </select>
                      </div>

                      <div class="flex items-center">
                        <input v-model="settingsStore.tajweedEnabled" @change="updateSettings" type="checkbox" id="tajweed" class="rounded dark:bg-gray-700 dark:border-gray-600">
                        <label for="tajweed" class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300">Enable Tajweed Colors</label>
                      </div>
                    </div>
                  </div>

                  <!-- Data Management Section -->
                  <div class="border-t border-gray-300 dark:border-gray-700 pt-6 space-y-4">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2">
                      <i class="fas fa-database text-green-600"></i>
                      Data Management
                    </h3>
                    
                    <div class="flex gap-3 flex-wrap">
                      <button @click="exportData" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                        <i class="fas fa-download"></i>
                        <span>Export Data</span>
                      </button>

                      <button @click="importData" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        <i class="fas fa-upload"></i>
                        <span>Import Data</span>
                      </button>

                      <button @click="resetApp" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                        <i class="fas fa-redo"></i>
                        <span>Reset All</span>
                      </button>
                    </div>
                  </div>

                  <!-- Bulk Memorization Tool -->
                  <div class="border-t border-gray-300 dark:border-gray-700 pt-6 space-y-4">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2">
                      <i class="fas fa-list-check text-purple-600"></i>
                      Bulk Memorization
                    </h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Mark multiple pages as memorized at once</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Start Page</label>
                        <input v-model.number="bulkStartPage" type="number" min="1" max="604" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-400">
                      </div>
                      <div>
                        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">End Page</label>
                        <input v-model.number="bulkEndPage" type="number" min="1" max="604" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-400">
                      </div>
                      <div class="flex items-end">
                        <button 
                          @click="bulkMemorize"
                          class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center gap-2"
                        >
                          <i class="fas fa-check-double"></i>
                          <span>Memorize Range</span>
                        </button>
                      </div>
                    </div>

                    <div v-if="bulkWarning" class="p-3 bg-yellow-50 dark:bg-yellow-900 rounded-lg text-sm text-yellow-800 dark:text-yellow-200 border border-yellow-200 dark:border-yellow-700">
                      <i class="fas fa-exclamation-triangle mr-2"></i>
                      {{ bulkWarning }}
                    </div>
                  </div>
                </div>

                <!-- Modal Footer -->
                <div class="sticky bottom-0 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex justify-end">
                  <button @click="showSettingsModal = false" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-900 dark:text-gray-100 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors font-medium">
                    Close
                  </button>
                </div>
              </div>
            </div>

            <!-- Footer -->
            <footer class="bg-gray-900 text-gray-400 text-center py-6 mt-12">
              <p>Murajah v2.0.0 - Beta | Made with <i class="fas fa-heart text-red-500"></i> for Qur'an memorization</p>
            </footer>

            <!-- Error Toast -->
            <div v-if="appStore.errorMessage" class="toast bg-red-500 text-white p-4 rounded-lg shadow-lg">
              <div class="flex items-center gap-3">
                <i class="fas fa-exclamation-circle"></i>
                <span>{{ appStore.errorMessage }}</span>
                <button @click="appStore.errorMessage = ''" class="ml-auto text-xl">&times;</button>
              </div>
            </div>

            <!-- Success Toast -->
            <div v-if="appStore.successMessage" class="toast bg-green-500 text-white p-4 rounded-lg shadow-lg">
              <div class="flex items-center gap-3">
                <i class="fas fa-check-circle"></i>
                <span>{{ appStore.successMessage }}</span>
                <button @click="appStore.successMessage = ''" class="ml-auto text-xl">&times;</button>
              </div>
            </div>

            <!-- Word Translation Tooltip -->
            <div v-if="showTooltip" class="fixed bg-white dark:bg-gray-800 text-gray-900 dark:text-white px-4 py-3 rounded-lg shadow-2xl border-2 border-blue-500 pointer-events-none text-base font-semibold whitespace-nowrap" style="z-index: 10000; max-width: 400px; word-wrap: break-word; white-space: normal;" :style="{ left: tooltipX + 'px', top: tooltipY + 'px' }">
              {{ tooltipText }}
            </div>
          </div>
        `,

        setup() {
          // State Stores
          const appStore = reactive({
            currentPage: parseInt(new URLSearchParams(window.location.search).get('page') || 1),
            totalPages: 604,
            isLoading: false,
            theme: 'light', // Will be loaded from IndexedDB in initializeApp
            appVersion: '2.0.0-beta',
            errorMessage: '',
            successMessage: ''
          });

          const settingsStore = reactive({
            finishRevisionDays: 30,
            pagesPerDay: 1,
            fontSize: 'medium',
            tajweedEnabled: true
          });

          const memorizedStore = reactive({
            memorizedPages: new Set(),
            lastUpdated: null
          });

          const mistakesStore = reactive({
            mistakes: new Map(),
            lastUpdated: null
          });

          const audioStore = reactive({
            recordings: [],
            isRecording: false,
            lastUpdated: null
          });

          const perfectRevisionsStore = reactive({
            perfectRevisions: new Map(), // pageNum -> count
            lastUpdated: null
          });

          // Local state
          const isInitializing = ref(true);
          const quranData = ref(null);
          const gotoInput = ref('');
          const audioRecorder = new AudioRecorder();
          const showSettingsModal = ref(false);
          
          // Word interaction state
          const hoveredWordId = ref(null);
          const selectedWords = ref(new Set());
          
          // Tooltip state
          const showTooltip = ref(false);
          const tooltipX = ref(0);
          const tooltipY = ref(0);
          const tooltipText = ref('');

          // Initialize app
          const initializeApp = async () => {
            try {
              isInitializing.value = true;
              
              // Load theme from IndexedDB
              try {
                appStore.theme = await murajahDB.loadTheme();
              } catch (error) {
                console.warn('[Murajah] Failed to load theme from IndexedDB:', error);
                appStore.theme = 'light';
              }
              
              // Load Quran data
              quranData.value = await loadAllQuranData();
              console.log('[Murajah] QuranData loaded, surahNames sample:', Object.keys(quranData.value.surahNames || {}).slice(0, 3), quranData.value.surahNames);
              console.log('[Murajah] Translations sample:', Object.keys(quranData.value.translations || {}).slice(0, 5), 'Total translations:', Object.keys(quranData.value.translations || {}).length);
              
              // Load stored data
              await loadStoredData();
              
              console.log('[Murajah] App initialized successfully');
              appStore.successMessage = 'Murajah loaded successfully!';
              setTimeout(() => appStore.successMessage = '', 3000);
            } catch (error) {
              console.error('[Murajah] Initialization error:', error);
              appStore.errorMessage = 'Failed to load Murajah. Please refresh.';
            } finally {
              isInitializing.value = false;
            }
          };

          const loadStoredData = async () => {
            try {
              // Try to load from IndexedDB first
              const data = await murajahDB.loadData();
              if (data) {
                if (data.memorized) memorizedStore.memorizedPages = new Set(data.memorized);
                if (data.perfectRevisions) {
                  perfectRevisionsStore.perfectRevisions = new Map(Object.entries(data.perfectRevisions).map(([k, v]) => [parseInt(k), v]));
                }
                if (data.mistakes) {
                  mistakesStore.mistakes = new Map(Object.entries(data.mistakes).map(([k, v]) => [parseInt(k), new Set(v)]));
                }
                if (data.recordings) {
                  // Load recordings with their blobs from IndexedDB
                  audioStore.recordings = [];
                  for (let i = 0; i < data.recordings.length; i++) {
                    try {
                      const recordingWithBlob = await murajahDB.loadRecording(i);
                      if (recordingWithBlob) {
                        audioStore.recordings.push(recordingWithBlob);
                      }
                    } catch (error) {
                      console.warn('[Murajah] Failed to load recording blob:', error);
                    }
                  }
                }
                if (data.settings) Object.assign(settingsStore, data.settings);
              } else {
                // Fallback: Try localStorage for backward compatibility
                const stored = localStorage.getItem('murajah-data');
                if (stored) {
                  const data = JSON.parse(stored);
                  if (data.memorized) memorizedStore.memorizedPages = new Set(data.memorized);
                  if (data.perfectRevisions) {
                    perfectRevisionsStore.perfectRevisions = new Map(Object.entries(data.perfectRevisions).map(([k, v]) => [parseInt(k), v]));
                  }
                  if (data.mistakes) {
                    mistakesStore.mistakes = new Map(Object.entries(data.mistakes).map(([k, v]) => [parseInt(k), new Set(v)]));
                  }
                  if (data.recordings) audioStore.recordings = data.recordings;
                  if (data.settings) Object.assign(settingsStore, data.settings);
                  
                  // Migrate to IndexedDB
                  await saveData();
                  localStorage.removeItem('murajah-data');
                }
              }
            } catch (error) {
              console.error('[Murajah] Failed to load stored data:', error);
            }
            // Ensure fontSize is always a valid value
            if (!['small', 'medium', 'large'].includes(settingsStore.fontSize)) {
              settingsStore.fontSize = 'medium';
            }
          };

          // Save data to IndexedDB
          const saveData = async () => {
            // Separate recordings data: blobs go to IndexedDB recordings store, metadata to appData
            const recordingsMetadata = audioStore.recordings.map(r => ({
              pageNumber: r.pageNumber,
              recordedAt: r.recordedAt,
              duration: r.duration,
              timestamp: r.timestamp
            }));

            // Extract plain objects from reactive stores (Proxy objects can't be cloned by IndexedDB)
            const plainSettings = {
              finishRevisionDays: settingsStore.finishRevisionDays,
              pagesPerDay: settingsStore.pagesPerDay,
              fontSize: settingsStore.fontSize,
              tajweedEnabled: settingsStore.tajweedEnabled
            };

            const data = {
              memorized: Array.from(memorizedStore.memorizedPages),
              perfectRevisions: Object.fromEntries(perfectRevisionsStore.perfectRevisions),
              mistakes: Object.fromEntries(
                Array.from(mistakesStore.mistakes).map(([key, val]) => [key, Array.from(val)])
              ),
              recordings: recordingsMetadata, // Only metadata, not blobs
              settings: plainSettings, // Plain object, not Proxy
              lastSaved: new Date().toISOString()
            };
            try {
              await murajahDB.saveData(data);
              
              // Also save audio blobs separately (without metadata fields that might cause issues)
              for (let i = 0; i < audioStore.recordings.length; i++) {
                const recording = audioStore.recordings[i];
                if (recording.blob) {
                  try {
                    await murajahDB.saveRecording(i, recording);
                  } catch (blobError) {
                    console.warn('[Murajah] Failed to save audio blob:', blobError);
                  }
                }
              }
            } catch (error) {
              console.error('[Murajah] Failed to save data to IndexedDB:', error);
              // Fallback to localStorage (but exclude blobs)
              localStorage.setItem('murajah-data', JSON.stringify(data));
            }
          };

          // Fire-and-forget wrapper for saveData (for non-critical saves)
          const saveDataBackground = () => {
            saveData().catch(console.error);
          };

          // Navigation functions
          const previousPage = () => {
            if (appStore.currentPage > 1) {
              appStore.currentPage--;
              updateURL();
            }
          };

          const nextPage = () => {
            if (appStore.currentPage < 604) {
              appStore.currentPage++;
              updateURL();
            }
          };

          const gotoPage = () => {
            const num = parseInt(gotoInput.value);
            if (isNaN(num) || num < 1 || num > 604) {
              appStore.errorMessage = 'Please enter a page number between 1 and 604';
              setTimeout(() => appStore.errorMessage = '', 2000);
              return;
            }
            goToPageNumber(num);
          };

          const goToPageNumber = (pageNum) => {
            if (pageNum < 1 || pageNum > 604) {
              appStore.errorMessage = 'Please enter a page number between 1 and 604';
              setTimeout(() => appStore.errorMessage = '', 2000);
              return;
            }
            appStore.currentPage = pageNum;
            gotoInput.value = '';
            updateURL();
          };

          const selectRandomPage = () => {
            if (memorizedStore.memorizedPages.size === 0) {
              appStore.errorMessage = 'No memorized pages yet';
              return;
            }
            const memorizedArray = Array.from(memorizedStore.memorizedPages);
            const randomPage = memorizedArray[Math.floor(Math.random() * memorizedArray.length)];
            appStore.currentPage = randomPage;
            updateURL();
            appStore.successMessage = `Random page selected: Page ${randomPage}`;
            setTimeout(() => appStore.successMessage = '', 3000);
            
            // Scroll to Quran text section after a brief delay to let Vue update the DOM
            setTimeout(() => {
              const quranSection = document.getElementById('quran-text-section');
              if (quranSection) {
                quranSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }, 100);
          };

          const updateURL = () => {
            window.history.replaceState(
              {},
              '',
              `?page=${appStore.currentPage}`
            );
          };

          // Memorization functions
          const toggleMemorized = () => {
            if (memorizedStore.memorizedPages.has(appStore.currentPage)) {
              memorizedStore.memorizedPages.delete(appStore.currentPage);
              appStore.successMessage = 'Removed from memorized';
            } else {
              memorizedStore.memorizedPages.add(appStore.currentPage);
              // Set score to 40 only if page is new (score = 0)
              const currentScore = getHifzScore(appStore.currentPage);
              if (currentScore < 40) {
                perfectRevisionsStore.perfectRevisions.set(appStore.currentPage, 40);
                appStore.successMessage = 'Marked as memorized! (Score: 40)';
              } else {
                appStore.successMessage = `Marked as memorized! (Score: ${currentScore} - kept)`;
              }
            }
            setTimeout(() => appStore.successMessage = '', 2000);
            saveDataBackground();
          };

          const isCurrentPageMemorized = computed(() => {
            return memorizedStore.memorizedPages.has(appStore.currentPage);
          });

          // Theme functions
          const toggleTheme = () => {
            appStore.theme = appStore.theme === 'light' ? 'dark' : 'light';
            
            // Toggle dark class on html and body elements
            if (appStore.theme === 'dark') {
              document.documentElement.classList.add('dark');
              document.body.classList.add('dark-mode');
              document.documentElement.style.backgroundColor = '#111827';
              document.documentElement.style.color = '#f3f4f6';
            } else {
              document.documentElement.classList.remove('dark');
              document.body.classList.remove('dark-mode');
              document.documentElement.style.backgroundColor = '#ffffff';
              document.documentElement.style.color = '#111827';
            }
            
            murajahDB.saveTheme(appStore.theme).catch(error => {
              console.warn('[Murajah] Failed to save theme:', error);
            });
          };

          // Perfect Revision functions
          const getPerfectCount = (pageNum) => {
            return perfectRevisionsStore.perfectRevisions.get(pageNum) || 0;
          };

          const incrementPerfectRevision = (pageNum) => {
            const currentCount = getPerfectCount(pageNum);
            perfectRevisionsStore.perfectRevisions.set(pageNum, currentCount + 1);
            perfectRevisionsStore.lastUpdated = new Date();
            appStore.successMessage = `Page ${pageNum} marked perfect! (+1)`;
            setTimeout(() => appStore.successMessage = '', 2000);
            saveDataBackground();
          };

          const currentPagePerfectCount = computed(() => {
            return getPerfectCount(appStore.currentPage);
          });

          // Get memorization score (0-100) based on perfect revision count
          // Score = perfect count directly (each mistake decreases count by 1)
          const getHifzScore = (pageNum) => {
            const perfectCount = getPerfectCount(pageNum);
            // Cap at 100, but allow negative scores to go to 0
            return Math.max(0, Math.min(perfectCount, 100));
          };

          // Get score colors for UI display
          const getScoreColors = (score) => {
            if (score > 90) {
              return { label: 'Firm', bg: '#111', color: '#fff', icon: 'la-star' };
            } else if (score >= 80) {
              return { label: 'Strong', bg: '#1b5e20', color: '#fff', icon: 'la-check-circle' };
            } else if (score >= 60) {
              return { label: 'Good', bg: '#0277bd', color: '#fff', icon: 'la-thumbs-up' };
            } else if (score >= 40) {
              return { label: 'Fair', bg: '#ff8f00', color: '#fff', icon: 'la-exclamation-circle' };
            } else if (score > 0) {
              return { label: 'Weak', bg: '#c62828', color: '#fff', icon: 'la-exclamation-triangle' };
            } else {
              return { label: 'New', bg: '#757575', color: '#fff', icon: 'la-bookmark' };
            }
          };

          // Get Arabic surah name from surah number
          const getSurahNameArabic = (surahNum) => {
            console.log(`[getSurahNameArabic] Called with surahNum:`, surahNum, 'type:', typeof surahNum);
            if (!surahNum || !quranData.value || !quranData.value.surahNames) {
              console.log(`[getSurahNameArabic] Failed guard check - surahNum:`, surahNum, 'quranData exists:', !!quranData.value, 'surahNames exists:', !!(quranData.value && quranData.value.surahNames));
              return 'Quran Content';
            }
            const surahNames = quranData.value.surahNames;
            console.log(`[getSurahNameArabic] Looking up surahNames[${surahNum}]`, surahNames[surahNum]);
            // The surahNames object has numeric keys (1, 2, 3, etc.) from the loaded JSON
            let surahName = surahNames[surahNum];
            if (surahName) {
              console.log(`[Murajah] Got surah name for ${surahNum}:`, surahName);
              return surahName;
            }
            console.warn(`[Murajah] Surah name not found for:`, surahNum);
            return `Surah ${surahNum}`;
          };

          const currentPageHifzStatus = computed(() => {
            const score = getHifzScore(appStore.currentPage);
            return getScoreColors(score);
          });

          // Word interaction functions
          const highlightWord = (word) => {
            // Add/remove word from mistakes for current page
            if (!mistakesStore.mistakes.has(appStore.currentPage)) {
              mistakesStore.mistakes.set(appStore.currentPage, new Set());
            }
            
            const pageErrors = mistakesStore.mistakes.get(appStore.currentPage);
            
            if (pageErrors.has(word.id)) {
              // Removing a mistake - increase perfect score
              pageErrors.delete(word.id);
              appStore.successMessage = 'Mistake removed!';
            } else {
              // Adding a mistake - decrease perfect score
              pageErrors.add(word.id);
              const currentCount = getPerfectCount(appStore.currentPage);
              perfectRevisionsStore.perfectRevisions.set(appStore.currentPage, Math.max(0, currentCount - 1));
              appStore.successMessage = 'Mistake marked! (-1 score)';
            }
            setTimeout(() => appStore.successMessage = '', 2000);
            
            // Save after updating
            saveDataBackground();
            console.log(`[Murajah] Word ${word.id} mistake toggled on page ${appStore.currentPage}`);
          };

          // Tooltip functions for word translations
          const showWordTooltip = (word, event) => {
            hoveredWordId.value = word.id;
            if (!quranData.value || !quranData.value.translations) {
              console.warn('[Murajah] No translations available');
              return;
            }
            
            // The translation key format is "surah:ayah:word" (e.g., "2:275:1")
            const key = `${word.surah}:${word.ayah}:${word.word}`;
            const translation = quranData.value.translations[key];
            
            console.log('[Murajah] Word tooltip lookup:', { 
              word: { id: word.id, surah: word.surah, ayah: word.ayah, word: word.word },
              key,
              found: !!translation,
              translation: translation || 'N/A'
            });
            
            if (translation) {
              tooltipText.value = translation;
              tooltipX.value = event.clientX + 18;
              tooltipY.value = event.clientY + 18;
              showTooltip.value = true;
              console.log('[Murajah] Word tooltip shown:', key, translation);
            } else {
              console.warn('[Murajah] Translation not found for key:', key);
              // Don't show tooltip if no translation found
              showTooltip.value = false;
            }
          };

          const updateTooltipPosition = (event) => {
            tooltipX.value = event.clientX + 18;
            tooltipY.value = event.clientY + 18;
          };

          const hideWordTooltip = () => {
            hoveredWordId.value = null;
            showTooltip.value = false;
          };

          // Settings functions
          const updateSettings = () => {
            saveDataBackground(); // Save to IndexedDB
            appStore.successMessage = 'Settings updated!';
            setTimeout(() => appStore.successMessage = '', 2000);
          };

          const clearPageMistakes = () => {
            if (confirm(`Clear all mistakes on page ${appStore.currentPage}?`)) {
              mistakesStore.mistakes.delete(appStore.currentPage);
              saveDataBackground();
              appStore.successMessage = 'Mistakes cleared!';
              setTimeout(() => appStore.successMessage = '', 2000);
            }
          };

          // Bulk memorization and statistics functions
          const bulkStartPage = ref(1);
          const bulkEndPage = ref(20);
          const bulkWarning = ref('');
          const selectedJuzPreset = ref(1);

          // Hardcoded Juz ranges (Juz 1 has 21 pages, Juz 2-29 have 20 pages each, Juz 30 has 23 pages)
          const JUZ_RANGES = {
            1: [1, 21],
            2: [22, 41],
            3: [42, 61],
            4: [62, 81],
            5: [82, 101],
            6: [102, 121],
            7: [122, 141],
            8: [142, 161],
            9: [162, 181],
            10: [182, 201],
            11: [202, 221],
            12: [222, 241],
            13: [242, 261],
            14: [262, 281],
            15: [282, 301],
            16: [302, 321],
            17: [322, 341],
            18: [342, 361],
            19: [362, 381],
            20: [382, 401],
            21: [402, 421],
            22: [422, 441],
            23: [442, 461],
            24: [462, 481],
            25: [482, 501],
            26: [502, 521],
            27: [522, 541],
            28: [542, 561],
            29: [562, 581],
            30: [582, 604]
          };

          const getJuzRange = (juzNum) => JUZ_RANGES[juzNum] || [1, 21];

          const juzMemorizedCount = (juzNum) => {
            const [startPage, endPage] = getJuzRange(juzNum);
            let count = 0;
            for (let i = startPage; i <= endPage; i++) {
              if (memorizedStore.memorizedPages.has(i)) count++;
            }
            return count;
          };

          const daysRemaining = computed(() => {
            if (statistics.value.remaining <= 0) return 0;
            if (settingsStore.pagesPerDay <= 0) return 0;
            return Math.ceil(statistics.value.remaining / settingsStore.pagesPerDay);
          });

          const bulkMemorize = () => {
            bulkWarning.value = '';
            const start = Math.max(1, Math.min(bulkStartPage.value, 604));
            const end = Math.max(start, Math.min(bulkEndPage.value, 604));

            if (start > end) {
              bulkWarning.value = 'Start page must be less than or equal to end page';
              return;
            }

            let added = 0;
            let alreadyHigherScore = 0;
            for (let i = start; i <= end; i++) {
              if (!memorizedStore.memorizedPages.has(i)) {
                memorizedStore.memorizedPages.add(i);
                // Set score to 40 only if page is new (score = 0)
                const currentScore = getHifzScore(i);
                if (currentScore < 40) {
                  perfectRevisionsStore.perfectRevisions.set(i, 40);
                }
                added++;
              } else {
                // Check if already memorized with higher score
                const currentScore = getHifzScore(i);
                if (currentScore > 0) {
                  alreadyHigherScore++;
                }
              }
            }

            if (added > 0) {
              saveDataBackground();
              if (alreadyHigherScore > 0) {
                appStore.successMessage = `${added} added, ${alreadyHigherScore} already memorized (scores kept)`;
              } else {
                appStore.successMessage = `${added} page(s) marked as memorized! (Score: 40)`;
              }
              setTimeout(() => appStore.successMessage = '', 2000);
            } else {
              bulkWarning.value = `All pages in range ${start}-${end} were already memorized`;
            }
          };

          const bulkMemorizePreset = (type, value) => {
            bulkWarning.value = '';

            if (type === 'juz' && selectedJuzPreset.value >= 1 && selectedJuzPreset.value <= 30) {
              const juzNum = selectedJuzPreset.value;
              const [startPage, endPage] = getJuzRange(juzNum);
              bulkStartPage.value = startPage;
              bulkEndPage.value = endPage;
              bulkMemorize();
            } else if (type === 'all') {
              if (confirm('Mark ALL 604 pages as memorized?')) {
                for (let i = 1; i <= 604; i++) {
                  memorizedStore.memorizedPages.add(i);
                }
                saveDataBackground();
                appStore.successMessage = 'All 604 pages marked as memorized!';
                setTimeout(() => appStore.successMessage = '', 2000);
              }
            } else if (type === 'clear') {
              if (confirm('Clear all memorized pages?')) {
                memorizedStore.memorizedPages.clear();
                saveDataBackground();
                appStore.successMessage = 'All memorized pages cleared!';
                setTimeout(() => appStore.successMessage = '', 2000);
              }
            }
          };

          // Audio functions
          const playAudio = async (recording) => {
            try {
              await AudioRecorder.playAudio(recording.blob);
            } catch (error) {
              console.error('[Murajah] Playback error:', error);
              appStore.errorMessage = 'Failed to play recording';
            }
          };

          let recordingTimer = null;
          const recordingStartTime = ref(null);
          const recordingDuration = ref('0:00');

          const startRecording = async () => {
            try {
              await audioRecorder.startRecording();
              audioStore.isRecording = true;
              recordingStartTime.value = Date.now();

              recordingTimer = setInterval(() => {
                const elapsed = Date.now() - recordingStartTime.value;
                recordingDuration.value = AudioRecorder.formatDuration(elapsed);
              }, 100);

              appStore.successMessage = 'Recording started...';
              setTimeout(() => appStore.successMessage = '', 2000);
            } catch (error) {
              console.error('[Murajah] Recording error:', error);
              appStore.errorMessage = 'Failed to start recording: ' + error.message;
              audioStore.isRecording = false;
            }
          };

          const stopRecording = async () => {
            try {
              if (recordingTimer) clearInterval(recordingTimer);
              
              const result = await audioRecorder.stopRecording();
              
              if (result) {
                const recording = {
                  pageNumber: appStore.currentPage,
                  recordedAt: new Date().toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                  }),
                  duration: result.duration,
                  blob: result.blob,
                  timestamp: Date.now()
                };

                audioStore.recordings.push(recording);
                audioStore.isRecording = false;
                recordingStartTime.value = null;
                recordingDuration.value = '0:00';

                saveDataBackground();
                appStore.successMessage = `Recording saved! (${AudioRecorder.formatDuration(result.duration)})`;
                setTimeout(() => appStore.successMessage = '', 3000);
              }
            } catch (error) {
              console.error('[Murajah] Stop recording error:', error);
              appStore.errorMessage = 'Failed to stop recording';
              audioStore.isRecording = false;
            }
          };

          const cancelRecording = () => {
            try {
              if (recordingTimer) clearInterval(recordingTimer);
              
              audioRecorder.cancelRecording();
              
              audioStore.isRecording = false;
              recordingStartTime.value = null;
              recordingDuration.value = '0:00';

              appStore.successMessage = 'Recording cancelled';
              setTimeout(() => appStore.successMessage = '', 2000);
            } catch (error) {
              console.error('[Murajah] Cancel recording error:', error);
              audioStore.isRecording = false;
            }
          };

          const deleteAudio = (index) => {
            if (confirm('Delete this recording?')) {
              audioStore.recordings.splice(index, 1);
              saveDataBackground();
              appStore.successMessage = 'Recording deleted';
              setTimeout(() => appStore.successMessage = '', 2000);
            }
          };

          const formatAudioDuration = (ms) => {
            return AudioRecorder.formatDuration(ms);
          };

          const exportData = () => {
            const data = {
              version: '2.0.0',
              exported: new Date().toISOString(),
              memorized: Array.from(memorizedStore.memorizedPages),
              perfectRevisions: Object.fromEntries(perfectRevisionsStore.perfectRevisions),
              mistakes: Object.fromEntries(
                Array.from(mistakesStore.mistakes).map(([key, val]) => [key, Array.from(val)])
              ),
              settings: settingsStore,
              recordings: audioStore.recordings
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `murajah-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            appStore.successMessage = 'Data exported!';
            setTimeout(() => appStore.successMessage = '', 2000);
          };

          const importData = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
              try {
                const file = e.target.files[0];
                const text = await file.text();
                const data = JSON.parse(text);

                if (data.version === '2.0.0') {
                  if (data.memorized) memorizedStore.memorizedPages = new Set(data.memorized);
                  if (data.settings) Object.assign(settingsStore, data.settings);
                  await saveData();
                  appStore.successMessage = 'Data imported successfully!';
                  setTimeout(() => location.reload(), 2000);
                }
              } catch (error) {
                appStore.errorMessage = 'Invalid backup file';
              }
            };
            input.click();
          };

          const resetApp = async () => {
            if (confirm('Are you sure? This will reset all data.')) {
              try {
                memorizedStore.memorizedPages.clear();
                mistakesStore.mistakes.clear();
                audioStore.recordings = [];
                appStore.currentPage = 1;
                await murajahDB.clearAll();
                appStore.successMessage = 'App reset!';
                setTimeout(() => location.reload(), 2000);
              } catch (error) {
                console.error('[Murajah] Error resetting app:', error);
                appStore.errorMessage = 'Failed to reset app';
              }
            }
          };

          // Computed
          const currentPageAudioCount = computed(() => {
            return audioStore.recordings.filter(r => r.pageNumber === appStore.currentPage).length;
          });

          const currentPageMistakeCount = computed(() => {
            const mistakes = mistakesStore.mistakes.get(appStore.currentPage);
            return mistakes ? mistakes.size : 0;
          });

          const currentPageMistakes = computed(() => {
            const mistakes = mistakesStore.mistakes.get(appStore.currentPage);
            return mistakes ? Array.from(mistakes).sort((a, b) => a - b) : [];
          });

          const fontSizeStyle = computed(() => {
            const sizeMap = {
              'small': '20px',
              'medium': '32px',
              'large': '44px'
            };
            const fontSize = sizeMap[settingsStore.fontSize] || '32px';
            console.log('[Murajah] fontSizeStyle computed:', {
              fontSize: settingsStore.fontSize,
              style: `font-size: ${fontSize}`
            });
            return { fontSize: fontSize };
          });

          const currentSurahName = computed(() => {
            if (!quranData.value || !currentPageWords.value || currentPageWords.value.length === 0) {
              return 'Quran Content';
            }
            
            // Extract surah number from the first word of current page
            for (const line of currentPageWords.value) {
              if (line.words && line.words.length > 0) {
                const firstWord = line.words[0];
                if (firstWord && firstWord.surah) {
                  const surahNum = firstWord.surah;
                  // Get surah names from quranData - should be an object with string keys
                  if (quranData.value.surahNames) {
                    const surahNames = quranData.value.surahNames;
                    // Try both array and object access patterns
                    let surahName = surahNames[surahNum] || surahNames[surahNum.toString()] || surahNames[surahNum - 1];
                    if (surahName) {
                      return surahName;
                    }
                  }
                  return `Surah ${surahNum}`;
                }
              }
            }
            
            return 'Quran Content';
          });

          const statistics = computed(() => {
            return calculateStatistics({
              memorized: memorizedStore.memorizedPages.size,
              mistakes: Array.from(mistakesStore.mistakes.values()).reduce((sum, set) => sum + set.size, 0),
              audios: audioStore.recordings.length,
              perfectRevisions: Array.from(perfectRevisionsStore.perfectRevisions.values()).reduce((sum, count) => sum + count, 0)
            });
          });

          const recentRecordings = computed(() => {
            return audioStore.recordings.slice(-5).reverse();
          });

          const formattedCompletion = computed(() => {
            const estimate = estimateCompletionDate(statistics.value.remaining, settingsStore.pagesPerDay);
            return estimate ? formatDate(estimate) : 'N/A';
          });

          const currentJuzProgress = computed(() => {
            // Find which Juz the current page belongs to
            let juzNum = 1;
            for (let j = 1; j <= 30; j++) {
              const [start, end] = getJuzRange(j);
              if (appStore.currentPage >= start && appStore.currentPage <= end) {
                juzNum = j;
                break;
              }
            }
            const [startPage, endPage] = getJuzRange(juzNum);
            let count = 0;
            for (let i = startPage; i < appStore.currentPage && i <= endPage; i++) {
              if (memorizedStore.memorizedPages.has(i)) count++;
            }
            return count;
          });

          // Get current page text on demand
          const currentPageText = computed(() => {
            if (!quranData.value || !quranData.value.layout || !quranData.value.words) {
              return [];
            }
            return getPageText(appStore.currentPage, quranData.value.layout, quranData.value.words);
          });

          // Get current page words with word-by-word detail
          const currentPageWords = computed(() => {
            if (!quranData.value || !quranData.value.layout || !quranData.value.words) {
              return [];
            }
            return getPageWordsDetailed(appStore.currentPage, quranData.value.layout, quranData.value.words);
          });

          // Load font dynamically for current page
          const loadPageFont = (pageNum) => {
            const fontId = 'dynamicQPCPageFont';
            let styleTag = document.getElementById(fontId);
            if (styleTag) styleTag.remove();
            
            styleTag = document.createElement('style');
            styleTag.id = fontId;
            
            // Use settingsStore to check if tajweed is enabled
            const tajweed = settingsStore.tajweedEnabled;
            
            let src;
            if (tajweed) {
              src = `src: url('./resources/tajweed/p${pageNum}.woff2') format('woff2')`;
            } else {
              src = `src: url('./resources/font/p${pageNum}.woff2') format('woff2')`;
            }
            
            styleTag.innerHTML = `@font-face { font-family: 'QPCV2Page'; ${src}; font-weight: normal; font-style: normal; }`;
            document.head.appendChild(styleTag);
            console.log(`[Murajah] Loaded font for page ${pageNum} (tajweed: ${tajweed})`);
          };

          // Lifecycle
          onMounted(async () => {
            await initializeApp();
            
            // Apply theme to html and body elements
            if (appStore.theme === 'dark') {
              document.documentElement.classList.add('dark');
              document.body.classList.add('dark-mode');
              document.documentElement.style.backgroundColor = '#111827';
              document.documentElement.style.color = '#f3f4f6';
            } else {
              document.documentElement.classList.remove('dark');
              document.body.classList.remove('dark-mode');
              document.documentElement.style.backgroundColor = '#ffffff';
              document.documentElement.style.color = '#111827';
            }
            
            // Load font for initial page
            loadPageFont(appStore.currentPage);
          });

          // Watch URL changes and load font when page changes
          watch(() => appStore.currentPage, (newPage) => {
            updateURL();
            loadPageFont(newPage);
          });

          // Watch theme changes and apply to document
          watch(() => appStore.theme, (newTheme) => {
            if (newTheme === 'dark') {
              document.documentElement.classList.add('dark');
              document.body.classList.add('dark-mode');
              document.documentElement.style.backgroundColor = '#111827';
              document.documentElement.style.color = '#f3f4f6';
            } else {
              document.documentElement.classList.remove('dark');
              document.body.classList.remove('dark-mode');
              document.documentElement.style.backgroundColor = '#ffffff';
              document.documentElement.style.color = '#111827';
            }
            console.log('[Murajah] Theme changed to:', newTheme);
          });

          // Watch tajweed setting and reload font when toggled
          watch(() => settingsStore.tajweedEnabled, () => {
            loadPageFont(appStore.currentPage);
            console.log('[Murajah] Tajweed setting changed, font reloaded');
          });

          // Watch fontSize setting and save changes
          watch(() => settingsStore.fontSize, (newFontSize) => {
            console.log('[Murajah] Font size changed to:', newFontSize);
            saveDataBackground();
          });

          // Keyboard shortcuts handler
          const handleKeyboardShortcut = (event) => {
            // Don't trigger shortcuts if user is typing in an input field
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
              return;
            }

            // Don't trigger shortcuts if Ctrl, Cmd, or Alt are pressed (let browser handle these)
            if (event.ctrlKey || event.metaKey || event.altKey) {
              return;
            }

            const key = event.key.toLowerCase();
            
            // T - Toggle Tajweed
            if (key === 't') {
              event.preventDefault();
              settingsStore.tajweedEnabled = !settingsStore.tajweedEnabled;
              updateSettings();
              appStore.successMessage = `Tajweed ${settingsStore.tajweedEnabled ? 'enabled' : 'disabled'}`;
              setTimeout(() => appStore.successMessage = '', 2000);
              console.log('[Murajah] Tajweed toggled via keyboard:', settingsStore.tajweedEnabled);
            }
            
            // Left Arrow - Previous Page
            if (event.key === 'ArrowLeft') {
              event.preventDefault();
              previousPage();
              console.log('[Murajah] Previous page via keyboard');
            }
            
            // Right Arrow - Next Page
            if (event.key === 'ArrowRight') {
              event.preventDefault();
              nextPage();
              console.log('[Murajah] Next page via keyboard');
            }
            
            // M - Toggle Memorized
            if (key === 'm') {
              event.preventDefault();
              toggleMemorized();
              console.log('[Murajah] Memorized toggled via keyboard');
            }
            
            // P - Perfect Revision
            if (key === 'p') {
              event.preventDefault();
              incrementPerfectRevision(appStore.currentPage);
              console.log('[Murajah] Perfect revision via keyboard');
            }
            
            // D - Toggle Dark Mode
            if (key === 'd') {
              event.preventDefault();
              toggleTheme();
              appStore.successMessage = `${appStore.theme === 'dark' ? 'Dark' : 'Light'} mode`;
              setTimeout(() => appStore.successMessage = '', 2000);
              console.log('[Murajah] Theme toggled via keyboard:', appStore.theme);
            }
            
            // R - Random Page
            if (key === 'r') {
              event.preventDefault();
              selectRandomPage();
              console.log('[Murajah] Random page selected via keyboard');
            }
            
            // G - Go to page (with prompt)
            if (key === 'g') {
              event.preventDefault();
              const pageNum = prompt('Go to page (1-604):', appStore.currentPage.toString());
              if (pageNum) {
                const num = parseInt(pageNum);
                if (!isNaN(num) && num >= 1 && num <= 604) {
                  appStore.currentPage = num;
                  updateURL();
                } else {
                  appStore.errorMessage = 'Invalid page number';
                  setTimeout(() => appStore.errorMessage = '', 2000);
                }
              }
              console.log('[Murajah] Go to page via keyboard');
            }
            
            // ? or H - Show Help (keyboard shortcuts)
            if (key === '?' || key === 'h') {
              event.preventDefault();
              showKeyboardShortcutsHelp();
            }
          };

          const showKeyboardShortcutsHelp = () => {
            const shortcuts = `
Murajah Keyboard Shortcuts:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Navigation:
  ← / → Arrow Keys   Navigate between pages
  G                  Go to specific page
  R                  Random memorized page

Memorization:
  M                  Toggle memorized status
  P                  Mark perfect revision
  T                  Toggle Tajweed colors

Display:
  D                  Toggle dark mode
  ? / H              Show this help menu

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            `;
            alert(shortcuts);
            console.log('[Murajah] Keyboard shortcuts displayed');
          };

          // Add keyboard event listener on mount
          onMounted(() => {
            document.addEventListener('keydown', handleKeyboardShortcut);
            console.log('[Murajah] Keyboard shortcuts enabled');
          });

          // Clean up keyboard listener before unmount (optional for Vue 3)
          const cleanupKeyboardListener = () => {
            document.removeEventListener('keydown', handleKeyboardShortcut);
            console.log('[Murajah] Keyboard shortcuts disabled');
          };

          return {
            appStore,
            settingsStore,
            memorizedStore,
            mistakesStore,
            audioStore,
            perfectRevisionsStore,
            isInitializing,
            quranData,
            gotoInput,
            showSettingsModal,
            statistics,
            recentRecordings,
            formattedCompletion,
            currentJuzProgress,
            daysRemaining,
            bulkStartPage,
            bulkEndPage,
            bulkWarning,
            selectedJuzPreset,
            getJuzRange,
            juzMemorizedCount,
            currentPageText,
            currentPageWords,
            fontSizeStyle,
            hoveredWordId,
            showTooltip,
            tooltipX,
            tooltipY,
            tooltipText,
            isCurrentPageMemorized,
            currentPagePerfectCount,
            currentPageHifzStatus,
            currentPageAudioCount,
            currentPageMistakeCount,
            currentPageMistakes,
            currentSurahName,
            recordingDuration,
            previousPage,
            nextPage,
            gotoPage,
            goToPageNumber,
            selectRandomPage,
            toggleTheme,
            toggleMemorized,
            incrementPerfectRevision,
            highlightWord,
            showWordTooltip,
            updateTooltipPosition,
            hideWordTooltip,
            getSurahNameArabic,
            updateSettings,
            clearPageMistakes,
            bulkMemorize,
            bulkMemorizePreset,
            playAudio,
            startRecording,
            stopRecording,
            cancelRecording,
            deleteAudio,
            formatAudioDuration,
            AudioRecorder,
            exportData,
            importData,
            resetApp,
            loadPageFont,
            handleKeyboardShortcut,
            showKeyboardShortcutsHelp,
            cleanupKeyboardListener
          };
        }
      });

      app.mount('#app');
    })();
  </script>
</body>
</html>
