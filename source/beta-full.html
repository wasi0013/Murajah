<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Murajah - Quran Memorization App">
  <meta name="theme-color" content="#1f2937">
  <title>Murajah - Quran Memorization</title>
  
  <!-- Tailwind CSS -->
  <script src="./resources/js/tailwind.3.4.7.js"></script>
  
  <!-- Line Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Vue 3 -->
  <script src="./resources/js/vue.global.js"></script>

  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #1e40af;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    body.dark-mode {
      @apply bg-gray-900 text-gray-100;
    }

    body:not(.dark-mode) {
      @apply bg-white text-gray-900;
    }

    /* Quran Text Styling */
    .quran-text {
      font-family: 'QPCV2Page', 'Traditional Arabic', 'Arial Unicode MS', sans-serif;
      font-size: 2rem;
      line-height: 2;
      direction: rtl;
      text-align: right;
      letter-spacing: 0.1em;
    }

    .quran-word {
      display: inline-block;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0.25rem;
      border-radius: 4px;
    }

    .quran-word:hover {
      @apply bg-blue-200;
    }

    .quran-word.mistake {
      @apply bg-red-200;
    }

    .quran-word.memorized-highlight {
      @apply bg-green-200;
    }

    .dark-mode .quran-word:hover {
      @apply bg-blue-800;
    }

    .dark-mode .quran-word.mistake {
      @apply bg-red-800;
    }

    .dark-mode .quran-word.memorized-highlight {
      @apply bg-green-800;
    }

    /* Smooth Transitions */
    .transition-all {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Touch Targets */
    button, a {
      min-height: 44px;
      min-width: 44px;
    }

    /* Loading Animation */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    /* Progress Bar */
    .progress-bar {
      height: 6px;
      background-color: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }

    .dark-mode .progress-bar {
      background-color: #374151;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #10b981);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 50;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Modal */
    .modal-backdrop {
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Responsive Grid */
    .bubble-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(20px, 1fr));
      gap: 4px;
      padding: 16px;
    }

    .memorized-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
      gap: 8px;
      padding: 16px;
    }

    /* Dark Mode Utilities */
    .dark-mode * {
      color-scheme: dark;
    }

    /* Focus Visible for Accessibility */
    button:focus-visible, a:focus-visible, input:focus-visible {
      @apply outline-offset-2 outline-2 outline-blue-500;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      @apply bg-gray-100;
    }

    .dark-mode ::-webkit-scrollbar-track {
      @apply bg-gray-800;
    }

    ::-webkit-scrollbar-thumb {
      @apply bg-gray-400 rounded;
    }

    ::-webkit-scrollbar-thumb:hover {
      @apply bg-gray-500;
    }

    .dark-mode ::-webkit-scrollbar-thumb {
      @apply bg-gray-600 rounded;
    }

    .dark-mode ::-webkit-scrollbar-thumb:hover {
      @apply bg-gray-500;
    }
  </style>
</head>
<body class="overflow-x-hidden">
  <div id="app"></div>

  <script type="module">
    // Access Vue from global scope since it's loaded as a script tag
    const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

    // IIFE to handle async imports
    (async () => {
      // Import utility modules
      const dataLoaderModule = await import('./resources/js/utils/dataLoader.js');
      const { loadAllQuranData, getPageText, getPageWordsDetailed } = dataLoaderModule;
      
      const calculationsModule = await import('./resources/js/utils/calculations.js');
      const { 
        calculateMemorizationPercentage, 
        calculateProgress,
        formatDuration,
        generateMistakeBubbles,
        generateMemorizedGrid,
        calculateStatistics,
        estimateCompletionDate,
        formatDate,
        getScoreColor,
        generatePageRange
      } = calculationsModule;
      
      const audioRecorderModule = await import('./resources/js/utils/audioRecorder.js');
      const AudioRecorder = audioRecorderModule.default;

      const app = createApp({
        template: `
          <div :class="{ 'dark-mode': appStore.theme === 'dark' }" class="min-h-screen transition-all">
            <!-- Loading Screen -->
            <div v-if="isInitializing" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
              <div class="text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-white mb-4"></i>
                <p class="text-white text-lg">Loading Murajah...</p>
              </div>
            </div>

            <!-- Header -->
            <header class="sticky top-0 z-40 bg-gradient-to-r from-blue-600 to-blue-500 text-white shadow-lg">
              <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <i class="fas fa-quran text-2xl"></i>
                  <h1 class="text-2xl font-bold">Murajah</h1>
                </div>
                <div class="flex items-center gap-4">
                  <!-- Hifz Status in Header -->
                  <div v-if="currentPageHifzStatus" class="hidden sm:flex items-center gap-2 px-3 py-2 rounded-lg bg-white/20 backdrop-blur">
                    <i :class="'la ' + currentPageHifzStatus.icon" class="text-lg"></i>
                    <div class="text-xs">
                      <div class="opacity-75">{{ currentPageHifzStatus.label }}</div>
                    </div>
                  </div>
                  
                  <button @click="toggleTheme" class="p-2 hover:bg-blue-700 rounded-lg transition-colors" :title="appStore.theme === 'light' ? 'Dark Mode' : 'Light Mode'">
                    <i :class="appStore.theme === 'light' ? 'fas fa-moon' : 'fas fa-sun'" class="text-xl"></i>
                  </button>
                </div>
              </div>
            </header>

            <!-- Main Content -->
            <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
              <!-- Daily Revision Banner -->
              <div v-if="memorizedStore.memorizedPages.size > 0" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg shadow-lg p-6 flex items-center justify-between">
                <div class="flex-1">
                  <h3 class="text-xl font-bold mb-2 flex items-center gap-2">
                    <i class="fas fa-calendar-check"></i>
                    Daily Revision
                  </h3>
                  <p class="text-sm opacity-90">Revise pages from your memorized collection today</p>
                </div>
                <button 
                  @click="selectRandomPage" 
                  class="ml-4 px-6 py-3 bg-white text-green-600 font-bold rounded-lg hover:bg-gray-100 transition-colors whitespace-nowrap flex items-center gap-2"
                >
                  <i class="fas fa-random"></i>
                  Random Page
                </button>
              </div>

              <!-- Status Indicators Row -->
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-blue-500 text-white p-6 rounded-lg shadow">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm opacity-90">Memorized</p>
                      <p class="text-3xl font-bold">{{ statistics.memorized }}</p>
                      <p class="text-xs opacity-75">{{ statistics.percentage }}%</p>
                    </div>
                    <i class="fas fa-bookmark text-4xl opacity-30"></i>
                  </div>
                </div>

                <div class="bg-purple-500 text-white p-6 rounded-lg shadow">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm opacity-90">Perfect Revisions</p>
                      <p class="text-3xl font-bold">{{ statistics.perfectRevisions }}</p>
                      <p class="text-xs opacity-75">Avg: {{ statistics.averagePerfect }}/page</p>
                    </div>
                    <i class="fas fa-star text-4xl opacity-30"></i>
                  </div>
                </div>

                <div class="bg-red-500 text-white p-6 rounded-lg shadow">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm opacity-90">Mistakes</p>
                      <p class="text-3xl font-bold">{{ statistics.mistakes }}</p>
                      <p class="text-xs opacity-75">Word-level</p>
                    </div>
                    <i class="fas fa-exclamation-circle text-4xl opacity-30"></i>
                  </div>
                </div>

                <div class="bg-green-500 text-white p-6 rounded-lg shadow">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm opacity-90">Recordings</p>
                      <p class="text-3xl font-bold">{{ statistics.audios }}</p>
                      <p class="text-xs opacity-75">Audio practice</p>
                    </div>
                    <i class="fas fa-microphone text-4xl opacity-30"></i>
                  </div>
                </div>
              </div>

              <!-- Progress Section -->
              <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 space-y-4">
                <div class="flex items-center justify-between">
                  <h2 class="text-2xl font-bold">Progress</h2>
                  <span class="text-sm text-gray-600 dark:text-gray-400">{{ statistics.memorized }}/604 Pages</span>
                </div>

                <div class="space-y-2">
                  <div class="progress-bar">
                    <div class="progress-fill" :style="{ width: statistics.percentage + '%' }"></div>
                  </div>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
                  <div>
                    <p class="text-gray-600 dark:text-gray-400">Remaining</p>
                    <p class="text-xl font-bold">{{ statistics.remaining }}</p>
                  </div>
                  <div>
                    <p class="text-gray-600 dark:text-gray-400">Juzs (Parts)</p>
                    <p class="text-xl font-bold">{{ statistics.juzCount }}/30</p>
                  </div>
                  <div>
                    <p class="text-gray-600 dark:text-gray-400">Est. Completion</p>
                    <p class="text-sm font-bold">{{ formattedCompletion }}</p>
                  </div>
                </div>
              </div>

              <!-- Quran Text Display with Overlay Navigation -->
              <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8 space-y-6 border-2 border-blue-200 dark:border-blue-900 relative group">
                <div class="text-center space-y-2">
                  <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Page {{ appStore.currentPage }} of 604</p>
                  <h2 class="text-3xl font-bold text-blue-600 dark:text-blue-400">Quran Content</h2>
                </div>

                <!-- Quran Text Content - Word by Word Display -->
                <div v-if="quranData && currentPageWords.length > 0" class="quran-text text-center p-8 bg-gray-50 dark:bg-gray-900 rounded-lg min-h-96 overflow-y-auto space-y-4">
                  <div v-for="(line, lineIdx) in currentPageWords" :key="lineIdx" class="flex flex-wrap justify-center gap-2 leading-loose">
                    <!-- Surah Name Display -->
                    <div v-if="line.type === 'surah_name'" class="w-full text-xl font-bold text-blue-600 dark:text-blue-400 my-2">
                      {{ line.text }}
                    </div>
                    
                    <!-- Words Display -->
                    <span 
                      v-for="word in line.words" 
                      :key="word.id"
                      @click="highlightWord(word)"
                      @mouseenter="hoveredWordId = word.id"
                      @mouseleave="hoveredWordId = null"
                      :class="{
                        'bg-blue-100 dark:bg-blue-900 rounded-md px-2 py-1': hoveredWordId === word.id,
                        'cursor-pointer transition-all duration-200': true
                      }"
                      :title="'Word ' + word.id + ' - Surah ' + word.surah + ':' + word.ayah"
                      class="quran-word inline-block"
                    >
                      {{ word.text }}
                    </span>
                  </div>
                </div>

                <!-- Empty State -->
                <div v-else class="flex flex-col items-center justify-center p-12 bg-gray-100 dark:bg-gray-700 rounded-lg">
                  <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                  <p class="text-gray-600 dark:text-gray-400">Loading Quran text...</p>
                </div>

                <!-- Overlay Navigation Arrows (Hidden by default, visible on hover) -->
                <div class="absolute inset-0 flex items-center justify-between px-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none rounded-lg">
                  <!-- Previous Page Arrow -->
                  <button 
                    v-if="appStore.currentPage > 1"
                    @click="previousPage" 
                    class="p-3 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg transition-all pointer-events-auto"
                    :title="'Previous Page (' + (appStore.currentPage - 1) + ')'"
                  >
                    <i class="fas fa-chevron-left text-2xl"></i>
                  </button>
                  <div v-else class="w-12"></div>

                  <!-- Next Page Arrow -->
                  <button 
                    v-if="appStore.currentPage < appStore.totalPages"
                    @click="nextPage" 
                    class="p-3 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg transition-all pointer-events-auto"
                    :title="'Next Page (' + (appStore.currentPage + 1) + ')'"
                  >
                    <i class="fas fa-chevron-right text-2xl"></i>
                  </button>
                  <div v-else class="w-12"></div>
                </div>
              </div>

              <!-- Page Navigation -->
              <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 space-y-4">
                <h2 class="text-2xl font-bold">Current Page</h2>
                
                <div class="flex items-center justify-between gap-4 flex-wrap">
                  <button @click="previousPage" :disabled="appStore.currentPage === 1" class="flex items-center gap-2 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    <i class="fas fa-chevron-left"></i>
                    <span>Previous</span>
                  </button>

                  <div class="flex items-center gap-3">
                    <span class="text-2xl font-bold">{{ appStore.currentPage }}</span>
                    <span class="text-gray-600 dark:text-gray-400">/604</span>
                    <input v-model.number="gotoInput" @keyup.enter="gotoPage" type="number" min="1" max="604" class="w-20 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 text-center" placeholder="Go to">
                    <button @click="gotoPage" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">Go</button>
                  </div>

                  <button @click="nextPage" :disabled="appStore.currentPage === 604" class="flex items-center gap-2 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    <span>Next</span>
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>

                <!-- Memorization Button -->
                <div class="flex items-center gap-3 flex-wrap">
                  <button @click="toggleMemorized" :class="isCurrentPageMemorized ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-400 hover:bg-gray-500'" class="flex items-center gap-2 px-6 py-3 text-white rounded-lg transition-colors">
                    <i :class="isCurrentPageMemorized ? 'fas fa-check-circle' : 'fas fa-circle'"></i>
                    <span>{{ isCurrentPageMemorized ? 'Memorized' : 'Mark as Memorized' }}</span>
                  </button>
                  <span v-if="isCurrentPageMemorized" class="text-green-600 dark:text-green-400 text-sm font-medium">âœ“ Memorized</span>

                  <!-- Perfect Revision Button -->
                  <button @click="incrementPerfectRevision(appStore.currentPage)" class="flex items-center gap-2 px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors">
                    <i class="fas fa-star"></i>
                    <span>Perfect Revision</span>
                    <span v-if="currentPagePerfectCount > 0" class="ml-1 font-bold">({{ currentPagePerfectCount }})</span>
                  </button>

                  <!-- Hifz Status Indicator -->
                  <div v-if="currentPageHifzStatus" class="flex items-center gap-2 px-4 py-3 rounded-lg text-white transition-all" :style="{ backgroundColor: currentPageHifzStatus.bg }">
                    <i :class="'la ' + currentPageHifzStatus.icon"></i>
                    <div class="text-left">
                      <div class="text-xs opacity-75">Status</div>
                      <div class="font-bold">{{ currentPageHifzStatus.label }}</div>
                    </div>
                  </div>

                  <!-- Audio Recording Section -->
                  <div v-if="AudioRecorder.isSupported()" class="flex flex-col gap-2">
                    <div v-if="!audioStore.isRecording" class="flex items-center gap-2">
                      <button @click="startRecording" class="flex items-center gap-2 px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                        <i class="fas fa-microphone"></i>
                        <span>Record</span>
                      </button>
                      <span v-if="currentPageAudioCount > 0" class="text-sm font-medium text-gray-600 dark:text-gray-400">{{ currentPageAudioCount }} recording(s)</span>
                    </div>
                    <div v-else class="flex items-center gap-2 p-4 bg-red-100 dark:bg-red-900 rounded-lg border-2 border-red-500">
                      <div class="flex-1">
                        <p class="font-bold text-red-700 dark:text-red-200">Recording...</p>
                        <p class="text-sm text-red-600 dark:text-red-300">{{ recordingDuration }}</p>
                      </div>
                      <button @click="stopRecording" class="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-stop"></i>
                        <span>Stop</span>
                      </button>
                      <button @click="cancelRecording" class="flex items-center gap-2 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-times"></i>
                        <span>Cancel</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Dashboard Stats Grid -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Recent Recordings -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 space-y-4">
                  <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-microphone text-blue-600"></i>
                    Recent Recordings
                  </h3>
                  <div v-if="statistics.audios > 0" class="space-y-3 max-h-48 overflow-y-auto">
                    <div v-for="(recording, idx) in recentRecordings" :key="idx" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-between gap-3">
                      <div class="flex-1 min-w-0">
                        <p class="font-medium">Page {{ recording.pageNumber }}</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400">{{ recording.recordedAt }}</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400" v-if="recording.duration">Duration: {{ formatAudioDuration(recording.duration) }}</p>
                      </div>
                      <div class="flex items-center gap-2">
                        <button @click="playAudio(recording)" class="p-2 hover:bg-blue-600 hover:text-white rounded-lg transition-colors" :title="'Play recording for page ' + recording.pageNumber">
                          <i class="fas fa-play"></i>
                        </button>
                        <button @click="deleteAudio(idx)" class="p-2 hover:bg-red-600 hover:text-white rounded-lg transition-colors" :title="'Delete recording for page ' + recording.pageNumber">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <div v-else class="text-gray-600 dark:text-gray-400 text-sm">
                    <i class="fas fa-circle-info mr-2"></i> No recordings yet
                  </div>
                </div>

                <!-- Quick Stats -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 space-y-4">
                  <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-chart-bar text-purple-600"></i>
                    Statistics
                  </h3>
                  <div class="space-y-3">
                    <div class="flex justify-between">
                      <span class="text-gray-600 dark:text-gray-400">Completion Rate</span>
                      <span class="font-bold">{{ statistics.percentage }}%</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600 dark:text-gray-400">Total Points</span>
                      <span class="font-bold text-green-600">{{ statistics.totalPoints }}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600 dark:text-gray-400">Avg Perfect/Page</span>
                      <span class="font-bold">{{ statistics.averagePerfect }}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600 dark:text-gray-400">Pages This Juz</span>
                      <span class="font-bold">{{ currentJuzProgress }}/20</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Mistake Bubble Grid -->
              <div v-if="currentPageMistakeCount > 0" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 space-y-4">
                <h3 class="text-xl font-bold flex items-center gap-2">
                  <i class="fas fa-exclamation-circle text-red-600"></i>
                  Mistakes on Page {{ appStore.currentPage }}
                </h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">{{ currentPageMistakeCount }} mistake(s) found</p>
                
                <!-- Mistake Bubbles Grid -->
                <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-2">
                  <button 
                    v-for="wordId in currentPageMistakes" 
                    :key="wordId"
                    @click="highlightWord({ id: wordId })"
                    class="p-3 rounded-full bg-red-200 dark:bg-red-900 text-red-700 dark:text-red-200 font-bold text-sm hover:bg-red-300 dark:hover:bg-red-800 transition-colors text-center"
                    :title="'Mistake: Word ' + wordId"
                  >
                    {{ wordId }}
                  </button>
                </div>
                
                <button 
                  @click="clearPageMistakes"
                  class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                >
                  Clear All Mistakes
                </button>
              </div>

              <!-- Advanced Analytics Section -->
              <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 space-y-6">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                  <i class="fas fa-chart-pie text-purple-600"></i>
                  Analytics & Progress
                </h2>

                <!-- Juz Progress Grid -->
                <div>
                  <h3 class="text-lg font-bold mb-4">Progress by Juz</h3>
                  <div class="grid grid-cols-5 sm:grid-cols-10 gap-2">
                    <button 
                      v-for="juzNum in 30" 
                      :key="juzNum"
                      @click="gotoPage((juzNum - 1) * 20 + 1)"
                      :class="[
                        'px-3 py-2 rounded-lg font-bold text-sm transition-colors',
                        juzMemorizedCount(juzNum) === 20 
                          ? 'bg-green-500 text-white' 
                          : juzMemorizedCount(juzNum) > 0
                            ? 'bg-yellow-400 text-gray-900'
                            : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
                      ]"
                      :title="'Juz ' + juzNum + ': ' + juzMemorizedCount(juzNum) + '/20 pages'"
                    >
                      {{ juzNum }}
                    </button>
                  </div>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
                    Green = Completed | Yellow = Partial | Gray = Not started
                  </p>
                </div>

                <!-- Completion Estimate -->
                <div class="border-t border-gray-300 dark:border-gray-700 pt-6">
                  <h3 class="text-lg font-bold mb-4">Completion Estimate</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-blue-50 dark:bg-blue-900 rounded-lg">
                      <p class="text-sm text-gray-600 dark:text-gray-400">Estimated Completion Date</p>
                      <p class="text-2xl font-bold text-blue-600 dark:text-blue-300">{{ formattedCompletion }}</p>
                    </div>
                    <div class="p-4 bg-purple-50 dark:bg-purple-900 rounded-lg">
                      <p class="text-sm text-gray-600 dark:text-gray-400">Days Remaining</p>
                      <p class="text-2xl font-bold text-purple-600 dark:text-purple-300">{{ daysRemaining }}</p>
                    </div>
                  </div>
                  <div class="mt-4 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <p class="text-sm">
                      Based on {{ settingsStore.pagesPerDay }} page(s) per day, you will complete memorization in approximately {{ daysRemaining }} days.
                    </p>
                  </div>
                </div>

                <!-- Bulk Memorization Tool -->
                <div class="border-t border-gray-300 dark:border-gray-700 pt-6">
                  <h3 class="text-lg font-bold mb-4">Bulk Memorization</h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Mark multiple pages as memorized at once</p>
                  
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <label class="block text-sm font-medium mb-2">Start Page</label>
                      <input v-model.number="bulkStartPage" type="number" min="1" max="604" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700">
                    </div>
                    <div>
                      <label class="block text-sm font-medium mb-2">End Page</label>
                      <input v-model.number="bulkEndPage" type="number" min="1" max="604" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700">
                    </div>
                    <div class="flex items-end">
                      <button 
                        @click="bulkMemorize"
                        class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center gap-2"
                      >
                        <i class="fas fa-check-double"></i>
                        <span>Memorize Range</span>
                      </button>
                    </div>
                  </div>

                  <!-- Preset Buttons for Common Ranges -->
                  <div class="mt-4 flex flex-wrap gap-2">
                    <button 
                      @click="bulkMemorizePreset('juz', selectedJuzPreset)"
                      class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm"
                    >
                      <i class="fas fa-book"></i> Juz
                    </button>
                    <button 
                      @click="bulkMemorizePreset('all', null)"
                      class="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors text-sm"
                    >
                      <i class="fas fa-star"></i> All Pages
                    </button>
                    <button 
                      @click="bulkMemorizePreset('clear', null)"
                      class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm"
                    >
                      <i class="fas fa-times"></i> Clear All
                    </button>
                  </div>

                  <div v-if="bulkWarning" class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900 rounded-lg text-sm text-yellow-800 dark:text-yellow-200">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    {{ bulkWarning }}
                  </div>
                </div>

                <!-- Stats Summary -->
                <div class="border-t border-gray-300 dark:border-gray-700 pt-6">
                  <h3 class="text-lg font-bold mb-4">Summary Statistics</h3>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="p-3 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900 dark:to-blue-800 rounded-lg">
                      <p class="text-xs text-gray-600 dark:text-gray-400">Memorized Pages</p>
                      <p class="text-2xl font-bold text-blue-600 dark:text-blue-300">{{ statistics.memorized }}</p>
                      <p class="text-xs text-gray-500 dark:text-gray-400">of 604</p>
                    </div>
                    <div class="p-3 bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900 dark:to-purple-800 rounded-lg">
                      <p class="text-xs text-gray-600 dark:text-gray-400">Juzs</p>
                      <p class="text-2xl font-bold text-purple-600 dark:text-purple-300">{{ statistics.juzCount }}</p>
                      <p class="text-xs text-gray-500 dark:text-gray-400">of 30</p>
                    </div>
                    <div class="p-3 bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900 dark:to-green-800 rounded-lg">
                      <p class="text-xs text-gray-600 dark:text-gray-400">Completion</p>
                      <p class="text-2xl font-bold text-green-600 dark:text-green-300">{{ statistics.percentage }}%</p>
                    </div>
                    <div class="p-3 bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900 dark:to-orange-800 rounded-lg">
                      <p class="text-xs text-gray-600 dark:text-gray-400">Total Points</p>
                      <p class="text-2xl font-bold text-orange-600 dark:text-orange-300">{{ statistics.totalPoints }}</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Settings Section -->
              <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 space-y-6">
                <h2 class="text-2xl font-bold">Settings</h2>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                  <div>
                    <label class="block text-sm font-medium mb-2">Pages Per Day</label>
                    <input v-model.number="settingsStore.pagesPerDay" @change="updateSettings" type="number" min="1" max="604" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700">
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-2">Finish in (days)</label>
                    <input v-model.number="settingsStore.finishRevisionDays" @change="updateSettings" type="number" min="1" max="365" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700">
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-2">Font Size</label>
                    <select v-model="settingsStore.fontSize" @change="updateSettings" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700">
                      <option value="small">Small</option>
                      <option value="medium">Medium</option>
                      <option value="large">Large</option>
                    </select>
                  </div>

                  <div class="flex items-center">
                    <input v-model="settingsStore.tajweedEnabled" @change="updateSettings" type="checkbox" id="tajweed" class="rounded">
                    <label for="tajweed" class="ml-3">Enable Tajweed Colors</label>
                  </div>
                </div>

                <!-- Data Management -->
                <div class="border-t border-gray-300 dark:border-gray-700 pt-6 space-y-4">
                  <h3 class="text-lg font-bold">Data Management</h3>
                  
                  <div class="flex gap-3 flex-wrap">
                    <button @click="exportData" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                      <i class="fas fa-download"></i>
                      <span>Export Data</span>
                    </button>

                    <button @click="importData" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                      <i class="fas fa-upload"></i>
                      <span>Import Data</span>
                    </button>

                    <button @click="resetApp" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                      <i class="fas fa-redo"></i>
                      <span>Reset All</span>
                    </button>
                  </div>
                </div>
              </div>
            </main>

            <!-- Footer -->
            <footer class="bg-gray-900 text-gray-400 text-center py-6 mt-12">
              <p>Murajah v2.0.0 - Beta | Made with <i class="fas fa-heart text-red-500"></i> for Qur'an memorization</p>
            </footer>

            <!-- Error Toast -->
            <div v-if="appStore.errorMessage" class="toast bg-red-500 text-white p-4 rounded-lg shadow-lg">
              <div class="flex items-center gap-3">
                <i class="fas fa-exclamation-circle"></i>
                <span>{{ appStore.errorMessage }}</span>
                <button @click="appStore.errorMessage = ''" class="ml-auto text-xl">&times;</button>
              </div>
            </div>

            <!-- Success Toast -->
            <div v-if="appStore.successMessage" class="toast bg-green-500 text-white p-4 rounded-lg shadow-lg">
              <div class="flex items-center gap-3">
                <i class="fas fa-check-circle"></i>
                <span>{{ appStore.successMessage }}</span>
                <button @click="appStore.successMessage = ''" class="ml-auto text-xl">&times;</button>
              </div>
            </div>
          </div>
        `,

        setup() {
          // State Stores
          const appStore = reactive({
            currentPage: parseInt(new URLSearchParams(window.location.search).get('page') || 1),
            totalPages: 604,
            isLoading: false,
            theme: localStorage.getItem('murajah-theme') || 'light',
            appVersion: '2.0.0-beta',
            errorMessage: '',
            successMessage: ''
          });

          const settingsStore = reactive({
            finishRevisionDays: 30,
            pagesPerDay: 1,
            fontSize: 'medium',
            tajweedEnabled: true
          });

          const memorizedStore = reactive({
            memorizedPages: new Set(),
            lastUpdated: null
          });

          const mistakesStore = reactive({
            mistakes: new Map(),
            lastUpdated: null
          });

          const audioStore = reactive({
            recordings: [],
            isRecording: false,
            lastUpdated: null
          });

          const perfectRevisionsStore = reactive({
            perfectRevisions: new Map(), // pageNum -> count
            lastUpdated: null
          });

          // Local state
          const isInitializing = ref(true);
          const quranData = ref(null);
          const gotoInput = ref('');
          const audioRecorder = new AudioRecorder();
          
          // Word interaction state
          const hoveredWordId = ref(null);
          const selectedWords = ref(new Set());

          // Initialize app
          const initializeApp = async () => {
            try {
              isInitializing.value = true;
              
              // Load Quran data
              quranData.value = await loadAllQuranData();
              
              // Load stored data
              await loadStoredData();
              
              console.log('[Murajah] App initialized successfully');
              appStore.successMessage = 'Murajah loaded successfully!';
              setTimeout(() => appStore.successMessage = '', 3000);
            } catch (error) {
              console.error('[Murajah] Initialization error:', error);
              appStore.errorMessage = 'Failed to load Murajah. Please refresh.';
            } finally {
              isInitializing.value = false;
            }
          };

          const loadStoredData = async () => {
            // Simulate loading from IndexedDB
            // In production, this would use the MurajahDB class
            const stored = localStorage.getItem('murajah-data');
            if (stored) {
              const data = JSON.parse(stored);
              if (data.memorized) memorizedStore.memorizedPages = new Set(data.memorized);
              if (data.perfectRevisions) {
                perfectRevisionsStore.perfectRevisions = new Map(Object.entries(data.perfectRevisions).map(([k, v]) => [parseInt(k), v]));
              }
              if (data.recordings) audioStore.recordings = data.recordings;
            }
          };

          // Navigation functions
          const previousPage = () => {
            if (appStore.currentPage > 1) {
              appStore.currentPage--;
              updateURL();
            }
          };

          const nextPage = () => {
            if (appStore.currentPage < 604) {
              appStore.currentPage++;
              updateURL();
            }
          };

          const gotoPage = () => {
            const num = parseInt(gotoInput.value);
            if (num >= 1 && num <= 604) {
              appStore.currentPage = num;
              gotoInput.value = '';
              updateURL();
            }
          };

          const selectRandomPage = () => {
            if (memorizedStore.memorizedPages.size === 0) {
              appStore.errorMessage = 'No memorized pages yet';
              return;
            }
            const memorizedArray = Array.from(memorizedStore.memorizedPages);
            const randomPage = memorizedArray[Math.floor(Math.random() * memorizedArray.length)];
            appStore.currentPage = randomPage;
            updateURL();
            appStore.successMessage = `Random page selected: Page ${randomPage}`;
            setTimeout(() => appStore.successMessage = '', 3000);
          };

          const updateURL = () => {
            window.history.replaceState(
              {},
              '',
              `?page=${appStore.currentPage}`
            );
          };

          // Memorization functions
          const toggleMemorized = () => {
            if (memorizedStore.memorizedPages.has(appStore.currentPage)) {
              memorizedStore.memorizedPages.delete(appStore.currentPage);
              appStore.successMessage = 'Removed from memorized';
            } else {
              memorizedStore.memorizedPages.add(appStore.currentPage);
              appStore.successMessage = 'Marked as memorized!';
            }
            setTimeout(() => appStore.successMessage = '', 2000);
            saveData();
          };

          const isCurrentPageMemorized = computed(() => {
            return memorizedStore.memorizedPages.has(appStore.currentPage);
          });

          // Theme functions
          const toggleTheme = () => {
            appStore.theme = appStore.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('murajah-theme', appStore.theme);
            document.documentElement.classList.toggle('dark');
          };

          // Perfect Revision functions
          const getPerfectCount = (pageNum) => {
            return perfectRevisionsStore.perfectRevisions.get(pageNum) || 0;
          };

          const incrementPerfectRevision = (pageNum) => {
            const currentCount = getPerfectCount(pageNum);
            perfectRevisionsStore.perfectRevisions.set(pageNum, currentCount + 1);
            perfectRevisionsStore.lastUpdated = new Date();
            appStore.successMessage = `Page ${pageNum} marked perfect! (+1)`;
            setTimeout(() => appStore.successMessage = '', 2000);
            saveData();
          };

          const currentPagePerfectCount = computed(() => {
            return getPerfectCount(appStore.currentPage);
          });

          // Get memorization score (0-100) based on perfect revision count
          const getHifzScore = (pageNum) => {
            const perfectCount = getPerfectCount(pageNum);
            // Score increases: 0 perfect = 0, 1 = 15, 2 = 30, 3+ = 50
            // Higher counts increase score further up to 100
            if (perfectCount === 0) return 0;
            if (perfectCount === 1) return 15;
            if (perfectCount === 2) return 30;
            if (perfectCount === 3) return 50;
            if (perfectCount >= 4 && perfectCount < 7) return 60 + (perfectCount - 4) * 5;
            return 90;
          };

          // Get score colors for UI display
          const getScoreColors = (score) => {
            if (score > 90) {
              return { label: 'Firm', bg: '#111', color: '#fff', icon: 'la-star' };
            } else if (score >= 80) {
              return { label: 'Strong', bg: '#1b5e20', color: '#fff', icon: 'la-check-circle' };
            } else if (score >= 60) {
              return { label: 'Good', bg: '#0277bd', color: '#fff', icon: 'la-thumbs-up' };
            } else if (score >= 40) {
              return { label: 'Fair', bg: '#ff8f00', color: '#fff', icon: 'la-exclamation-circle' };
            } else if (score > 0) {
              return { label: 'Weak', bg: '#c62828', color: '#fff', icon: 'la-exclamation-triangle' };
            } else {
              return { label: 'New', bg: '#757575', color: '#fff', icon: 'la-bookmark' };
            }
          };

          const currentPageHifzStatus = computed(() => {
            const score = getHifzScore(appStore.currentPage);
            return getScoreColors(score);
          });

          // Word interaction functions
          const highlightWord = (word) => {
            // Toggle word selection
            if (selectedWords.value.has(word.id)) {
              selectedWords.value.delete(word.id);
            } else {
              selectedWords.value.add(word.id);
            }
            console.log(`[Murajah] Word ${word.id} selected - Total: ${selectedWords.value.size}`);
          };

          // Settings functions
          const updateSettings = () => {
            localStorage.setItem('murajah-settings', JSON.stringify(settingsStore));
            appStore.successMessage = 'Settings updated!';
            setTimeout(() => appStore.successMessage = '', 2000);
          };

          const clearPageMistakes = () => {
            if (confirm(`Clear all mistakes on page ${appStore.currentPage}?`)) {
              mistakesStore.mistakes.delete(appStore.currentPage);
              saveData();
              appStore.successMessage = 'Mistakes cleared!';
              setTimeout(() => appStore.successMessage = '', 2000);
            }
          };

          // Bulk memorization and statistics functions
          const bulkStartPage = ref(1);
          const bulkEndPage = ref(20);
          const bulkWarning = ref('');
          const selectedJuzPreset = ref(1);

          const juzMemorizedCount = (juzNum) => {
            const startPage = (juzNum - 1) * 20 + 1;
            const endPage = juzNum * 20;
            let count = 0;
            for (let i = startPage; i <= endPage; i++) {
              if (memorizedStore.memorizedPages.has(i)) count++;
            }
            return count;
          };

          const daysRemaining = computed(() => {
            if (statistics.value.remaining <= 0) return 0;
            if (settingsStore.pagesPerDay <= 0) return 0;
            return Math.ceil(statistics.value.remaining / settingsStore.pagesPerDay);
          });

          const bulkMemorize = () => {
            bulkWarning.value = '';
            const start = Math.max(1, Math.min(bulkStartPage.value, 604));
            const end = Math.max(start, Math.min(bulkEndPage.value, 604));

            if (start > end) {
              bulkWarning.value = 'Start page must be less than or equal to end page';
              return;
            }

            let added = 0;
            for (let i = start; i <= end; i++) {
              if (!memorizedStore.memorizedPages.has(i)) {
                memorizedStore.memorizedPages.add(i);
                added++;
              }
            }

            if (added > 0) {
              saveData();
              appStore.successMessage = `${added} page(s) marked as memorized!`;
              setTimeout(() => appStore.successMessage = '', 2000);
            } else {
              bulkWarning.value = `All pages in range ${start}-${end} were already memorized`;
            }
          };

          const bulkMemorizePreset = (type, value) => {
            bulkWarning.value = '';

            if (type === 'juz' && selectedJuzPreset.value >= 1 && selectedJuzPreset.value <= 30) {
              const juzNum = selectedJuzPreset.value;
              bulkStartPage.value = (juzNum - 1) * 20 + 1;
              bulkEndPage.value = juzNum * 20;
              bulkMemorize();
            } else if (type === 'all') {
              if (confirm('Mark ALL 604 pages as memorized?')) {
                for (let i = 1; i <= 604; i++) {
                  memorizedStore.memorizedPages.add(i);
                }
                saveData();
                appStore.successMessage = 'All 604 pages marked as memorized!';
                setTimeout(() => appStore.successMessage = '', 2000);
              }
            } else if (type === 'clear') {
              if (confirm('Clear all memorized pages?')) {
                memorizedStore.memorizedPages.clear();
                saveData();
                appStore.successMessage = 'All memorized pages cleared!';
                setTimeout(() => appStore.successMessage = '', 2000);
              }
            }
          };

          // Audio functions
          const playAudio = async (recording) => {
            try {
              await AudioRecorder.playAudio(recording.blob);
            } catch (error) {
              console.error('[Murajah] Playback error:', error);
              appStore.errorMessage = 'Failed to play recording';
            }
          };

          let recordingTimer = null;
          const recordingStartTime = ref(null);
          const recordingDuration = ref('0:00');

          const startRecording = async () => {
            try {
              await audioRecorder.startRecording();
              audioStore.isRecording = true;
              recordingStartTime.value = Date.now();

              recordingTimer = setInterval(() => {
                const elapsed = Date.now() - recordingStartTime.value;
                recordingDuration.value = AudioRecorder.formatDuration(elapsed);
              }, 100);

              appStore.successMessage = 'Recording started...';
              setTimeout(() => appStore.successMessage = '', 2000);
            } catch (error) {
              console.error('[Murajah] Recording error:', error);
              appStore.errorMessage = 'Failed to start recording: ' + error.message;
              audioStore.isRecording = false;
            }
          };

          const stopRecording = async () => {
            try {
              if (recordingTimer) clearInterval(recordingTimer);
              
              const result = await audioRecorder.stopRecording();
              
              if (result) {
                const recording = {
                  pageNumber: appStore.currentPage,
                  recordedAt: new Date().toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                  }),
                  duration: result.duration,
                  blob: result.blob,
                  timestamp: Date.now()
                };

                audioStore.recordings.push(recording);
                audioStore.isRecording = false;
                recordingStartTime.value = null;
                recordingDuration.value = '0:00';

                saveData();
                appStore.successMessage = `Recording saved! (${AudioRecorder.formatDuration(result.duration)})`;
                setTimeout(() => appStore.successMessage = '', 3000);
              }
            } catch (error) {
              console.error('[Murajah] Stop recording error:', error);
              appStore.errorMessage = 'Failed to stop recording';
              audioStore.isRecording = false;
            }
          };

          const cancelRecording = () => {
            try {
              if (recordingTimer) clearInterval(recordingTimer);
              
              audioRecorder.cancelRecording();
              
              audioStore.isRecording = false;
              recordingStartTime.value = null;
              recordingDuration.value = '0:00';

              appStore.successMessage = 'Recording cancelled';
              setTimeout(() => appStore.successMessage = '', 2000);
            } catch (error) {
              console.error('[Murajah] Cancel recording error:', error);
              audioStore.isRecording = false;
            }
          };

          const deleteAudio = (index) => {
            if (confirm('Delete this recording?')) {
              audioStore.recordings.splice(index, 1);
              saveData();
              appStore.successMessage = 'Recording deleted';
              setTimeout(() => appStore.successMessage = '', 2000);
            }
          };

          const formatAudioDuration = (ms) => {
            return AudioRecorder.formatDuration(ms);
          };
          const saveData = () => {
            const data = {
              memorized: Array.from(memorizedStore.memorizedPages),
              perfectRevisions: Object.fromEntries(perfectRevisionsStore.perfectRevisions),
              recordings: audioStore.recordings,
              settings: settingsStore,
              lastSaved: new Date().toISOString()
            };
            localStorage.setItem('murajah-data', JSON.stringify(data));
          };

          const exportData = () => {
            const data = {
              version: '2.0.0',
              exported: new Date().toISOString(),
              memorized: Array.from(memorizedStore.memorizedPages),
              perfectRevisions: Object.fromEntries(perfectRevisionsStore.perfectRevisions),
              mistakes: Object.fromEntries(
                Array.from(mistakesStore.mistakes).map(([key, val]) => [key, Array.from(val)])
              ),
              settings: settingsStore,
              recordings: audioStore.recordings
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `murajah-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            appStore.successMessage = 'Data exported!';
            setTimeout(() => appStore.successMessage = '', 2000);
          };

          const importData = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
              try {
                const file = e.target.files[0];
                const text = await file.text();
                const data = JSON.parse(text);

                if (data.version === '2.0.0') {
                  if (data.memorized) memorizedStore.memorizedPages = new Set(data.memorized);
                  if (data.settings) Object.assign(settingsStore, data.settings);
                  saveData();
                  appStore.successMessage = 'Data imported successfully!';
                  setTimeout(() => location.reload(), 2000);
                }
              } catch (error) {
                appStore.errorMessage = 'Invalid backup file';
              }
            };
            input.click();
          };

          const resetApp = () => {
            if (confirm('Are you sure? This will reset all data.')) {
              memorizedStore.memorizedPages.clear();
              mistakesStore.mistakes.clear();
              audioStore.recordings = [];
              appStore.currentPage = 1;
              localStorage.clear();
              appStore.successMessage = 'App reset!';
              setTimeout(() => location.reload(), 2000);
            }
          };

          // Computed
          const currentPageAudioCount = computed(() => {
            return audioStore.recordings.filter(r => r.pageNumber === appStore.currentPage).length;
          });

          const currentPageMistakeCount = computed(() => {
            const mistakes = mistakesStore.mistakes.get(appStore.currentPage);
            return mistakes ? mistakes.size : 0;
          });

          const currentPageMistakes = computed(() => {
            const mistakes = mistakesStore.mistakes.get(appStore.currentPage);
            return mistakes ? Array.from(mistakes).sort((a, b) => a - b) : [];
          });

          const statistics = computed(() => {
            return calculateStatistics({
              memorized: memorizedStore.memorizedPages.size,
              mistakes: Array.from(mistakesStore.mistakes.values()).reduce((sum, set) => sum + set.size, 0),
              audios: audioStore.recordings.length,
              perfectRevisions: 0
            });
          });

          const recentRecordings = computed(() => {
            return audioStore.recordings.slice(-5).reverse();
          });

          const formattedCompletion = computed(() => {
            const estimate = estimateCompletionDate(statistics.value.remaining, settingsStore.pagesPerDay);
            return estimate ? formatDate(estimate) : 'N/A';
          });

          const currentJuzProgress = computed(() => {
            const juzNum = Math.ceil(appStore.currentPage / 20);
            const startPage = (juzNum - 1) * 20 + 1;
            let count = 0;
            for (let i = startPage; i < appStore.currentPage && i <= juzNum * 20; i++) {
              if (memorizedStore.memorizedPages.has(i)) count++;
            }
            return count;
          });

          // Get current page text on demand
          const currentPageText = computed(() => {
            if (!quranData.value || !quranData.value.layout || !quranData.value.words) {
              return [];
            }
            return getPageText(appStore.currentPage, quranData.value.layout, quranData.value.words);
          });

          // Get current page words with word-by-word detail
          const currentPageWords = computed(() => {
            if (!quranData.value || !quranData.value.layout || !quranData.value.words) {
              return [];
            }
            return getPageWordsDetailed(appStore.currentPage, quranData.value.layout, quranData.value.words);
          });

          // Load font dynamically for current page
          const loadPageFont = (pageNum) => {
            const fontId = 'dynamicQPCPageFont';
            let styleTag = document.getElementById(fontId);
            if (styleTag) styleTag.remove();
            
            styleTag = document.createElement('style');
            styleTag.id = fontId;
            
            // Check if tajweed is enabled (default: true)
            const tajweed = localStorage.getItem('tajweed') !== 'false' ? true : false;
            
            let src;
            if (tajweed) {
              src = `src: url('./resources/tajweed/p${pageNum}.woff2') format('woff2')`;
            } else {
              src = `src: url('./resources/font/p${pageNum}.woff2') format('woff2')`;
            }
            
            styleTag.innerHTML = `@font-face { font-family: 'QPCV2Page'; ${src}; font-weight: normal; font-style: normal; }`;
            document.head.appendChild(styleTag);
            console.log(`[Murajah] Loaded font for page ${pageNum}`);
          };

          // Lifecycle
          onMounted(async () => {
            await initializeApp();
            if (appStore.theme === 'dark') {
              document.documentElement.classList.add('dark');
            }
            // Load font for initial page
            loadPageFont(appStore.currentPage);
          });

          // Watch URL changes and load font when page changes
          watch(() => appStore.currentPage, (newPage) => {
            updateURL();
            loadPageFont(newPage);
          });

          return {
            appStore,
            settingsStore,
            memorizedStore,
            mistakesStore,
            audioStore,
            perfectRevisionsStore,
            isInitializing,
            quranData,
            gotoInput,
            statistics,
            recentRecordings,
            formattedCompletion,
            currentJuzProgress,
            daysRemaining,
            bulkStartPage,
            bulkEndPage,
            bulkWarning,
            selectedJuzPreset,
            juzMemorizedCount,
            currentPageText,
            currentPageWords,
            hoveredWordId,
            isCurrentPageMemorized,
            currentPagePerfectCount,
            currentPageHifzStatus,
            currentPageAudioCount,
            currentPageMistakeCount,
            currentPageMistakes,
            recordingDuration,
            previousPage,
            nextPage,
            gotoPage,
            selectRandomPage,
            toggleTheme,
            toggleMemorized,
            incrementPerfectRevision,
            highlightWord,
            updateSettings,
            clearPageMistakes,
            bulkMemorize,
            bulkMemorizePreset,
            playAudio,
            startRecording,
            stopRecording,
            cancelRecording,
            deleteAudio,
            formatAudioDuration,
            AudioRecorder,
            exportData,
            importData,
            resetApp,
            loadPageFont
          };
        }
      });

      app.mount('#app');
    })();
  </script>
</body>
</html>
