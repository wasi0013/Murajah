<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Murajah Quran Layout</title>
  <style>
    body {
      background: #f9f9f9;
      font-family: 'QPCV2Page', serif;
      margin: 0;
      padding: 0;
    }
    .quran-page {
      max-width: 900px;
      margin: 40px auto;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-radius: 12px;
      padding: 32px 24px;
    }
    .quran-line {
      display: flex;
      justify-content: center;
      margin: 8px 0;
      font-size: 2.2em;
      line-height: 1.5;
    }
    .quran-word {
      cursor: pointer;
      margin: 0 2px;
      transition: background 0.2s;
      border-radius: 6px;
      padding: 0 4px;
    }
    .quran-word:hover {
      background: #e0f7fa;
    }
    .surah-name, .basmallah {
      text-align: center;
      font-size: 2.4em;
      font-weight: bold;
      margin: 16px 0 8px 0;
      color: #2e7d32;
    }
    .navigation {
      display: flex;
      justify-content: center;
      margin: 24px 0 0 0;
      gap: 16px;
    }
    .navigation button {
      font-size: 1.1em;
      padding: 8px 18px;
      border-radius: 6px;
      border: none;
      background: #2e7d32;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    .navigation button:disabled {
      background: #bdbdbd;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="quran-page" id="quranPage"></div>
  <div class="navigation">
  <button id="prevPage">Previous</button>
  <span id="pageIndicator">Page 1 / 604</span>
  <button id="nextPage">Next</button>
  <input type="number" id="gotoPageInput" min="1" max="604" placeholder="Page #" style="width: 70px; font-size: 1em; margin-left: 16px;">
  <button id="gotoPageBtn">Go</button>
  <button id="memorizeBtn" style="margin-left:16px;">Mark as Memorized</button>
  </div>
  
  <div id="dashboard" style="max-width:900px;margin:24px auto 32px auto;padding:12px 24px 24px 24px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
    <div style="background:#e3f2fd;border-radius:8px;height:24px;width:100%;overflow:hidden;">
      <div id="progressBar" style="height:100%;background:#1976d2;width:0%;transition:width 0.5s;"></div>
    </div>
    <div id="progressText" style="text-align:center;font-size:1.1em;margin-top:8px;color:#1976d2;"></div>
    <div id="memorizedGrid" style="margin:18px auto 0 auto;max-width:880px;"></div>
  </div>
  <div id="bulkMemorizeSection" style="max-width:900px;margin:0 auto 32px auto;padding:0 24px 0 24px;">
    <div id="bulkHeader" style="cursor:pointer;background:#e3f2fd;color:#1976d2;padding:12px 16px;border-radius:8px;font-size:1.1em;font-weight:500;user-select:none;">
      Bulk Mark Pages as Memorized
      <span id="bulkArrow" style="float:right;font-size:1.2em;">&#9654;</span>
    </div>
    <div id="bulkContent" style="display:none;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.04);padding:18px 16px 12px 16px;margin-top:4px;">
      <div style="margin-bottom:8px;color:#555;font-size:0.98em;">Enter a start and end page (1–604). Start page must be less than end page. All pages in this range will be marked as memorized. Example: 5–10 will mark pages 5, 6, 7, 8, 9, 10.</div>
      <input type="number" id="bulkStart" min="1" max="604" placeholder="Start Page" style="width:90px;margin-right:12px;font-size:1em;">
      <input type="number" id="bulkEnd" min="1" max="604" placeholder="End Page" style="width:90px;margin-right:12px;font-size:1em;">
      <button id="bulkMarkBtn" style="background:#1976d2;color:#fff;border:none;border-radius:6px;padding:7px 18px;font-size:1em;cursor:pointer;">Mark Range as Memorized</button>
      <div id="bulkError" style="color:#d32f2f;font-size:0.98em;margin-top:8px;display:none;"></div>
    </div>
  </div>
  <script>
    function renderMemorizedGrid() {
      const grid = document.getElementById('memorizedGrid');
      const total = TOTAL_PAGES;
      let html = '';
      // First row: page 1 centered
      html += '<div style="display:flex;justify-content:center;margin-bottom:4px;">';
      const isMemorized1 = memorizedPages.includes(1);
      html += `<div class="grid-cell" data-page="1" title="Page 1" style="width:18px;height:18px;border-radius:4px;background:${isMemorized1 ? '#43a047' : '#e0e0e0'};border:1px solid #bdbdbd;display:inline-block;cursor:pointer;"></div>`;
      html += '</div>';

      // Next rows: 20 cells per row
      let page = 2;
      for (let row = 0; row < Math.floor((total - 1) / 20); row++) {
        html += '<div style="display:flex;justify-content:center;margin-bottom:2px;">';
        for (let col = 0; col < 20 && page <= total; col++, page++) {
          const isMemorized = memorizedPages.includes(page);
          html += `<div class="grid-cell" data-page="${page}" title="Page ${page}" style="width:13px;height:13px;border-radius:2px;background:${isMemorized ? '#43a047' : '#e0e0e0'};border:1px solid #bdbdbd;display:inline-block;cursor:pointer;margin-right:1px;"></div>`;
        }
        html += '</div>';
      }

      // Last row: remaining cells centered
      if (page <= total) {
        html += '<div style="display:flex;justify-content:center;margin-bottom:2px;">';
        for (; page <= total; page++) {
          const isMemorized = memorizedPages.includes(page);
          html += `<div class="grid-cell" data-page="${page}" title="Page ${page}" style="width:13px;height:13px;border-radius:2px;background:${isMemorized ? '#43a047' : '#e0e0e0'};border:1px solid #bdbdbd;display:inline-block;cursor:pointer;margin-right:1px;"></div>`;
        }
        html += '</div>';
      }

      grid.innerHTML = html;
      // Add click event listeners to each cell
      Array.from(grid.getElementsByClassName('grid-cell')).forEach(cell => {
        cell.onclick = function() {
          const page = parseInt(cell.getAttribute('data-page'), 10);
          const idx = memorizedPages.indexOf(page);
          if (idx === -1) {
            memorizedPages.push(page);
          } else {
            memorizedPages.splice(idx, 1);
          }
          localStorage.setItem('memorizedPages', JSON.stringify(memorizedPages));
          updateDashboard();
          updateMemorizeBtn();
        };
      });
    }
    // Collapsible bulk memorization section logic
    document.addEventListener('DOMContentLoaded', function() {
      const bulkHeader = document.getElementById('bulkHeader');
      const bulkContent = document.getElementById('bulkContent');
      const bulkArrow = document.getElementById('bulkArrow');
      bulkHeader.onclick = function() {
        if (bulkContent.style.display === 'none') {
          bulkContent.style.display = 'block';
          bulkArrow.innerHTML = '&#9660;';
        } else {
          bulkContent.style.display = 'none';
          bulkArrow.innerHTML = '&#9654;';
        }
      };
      document.getElementById('bulkMarkBtn').onclick = function() {
        const start = parseInt(document.getElementById('bulkStart').value, 10);
        const end = parseInt(document.getElementById('bulkEnd').value, 10);
        const errorDiv = document.getElementById('bulkError');
        errorDiv.style.display = 'none';
        if (isNaN(start) || isNaN(end) || start < 1 || end > TOTAL_PAGES || start >= end) {
          errorDiv.textContent = 'Please enter valid start and end pages (start < end, both between 1 and 604).';
          errorDiv.style.display = 'block';
          return;
        }
        let changed = false;
        for (let p = start; p <= end; p++) {
          if (!memorizedPages.includes(p)) {
            memorizedPages.push(p);
            changed = true;
          }
        }
        if (changed) {
          localStorage.setItem('memorizedPages', JSON.stringify(memorizedPages));
          updateDashboard();
          updateMemorizeBtn();
        }
        errorDiv.textContent = `Marked pages ${start} to ${end} as memorized.`;
        errorDiv.style.color = '#1976d2';
        errorDiv.style.display = 'block';
      };
    });
    // Paths to JSON files (update as needed)
    const LAYOUT_PATH = './resources/qpc-v2-15-lines.json';
    const WORDS_PATH = './resources/qpc-v2-word-by-word.json';
    const TOTAL_PAGES = 604;
    let layoutData = [];
    let wordsData = {};
    let surahNames = {};
    let currentPage = 1;
let memorizedPages = [];

    async function loadJSON(path) {
      const res = await fetch(path);
      return res.json();
    }

    function updateMemorizeBtn() {
      const btn = document.getElementById('memorizeBtn');
      if (memorizedPages.includes(currentPage)) {
        btn.textContent = 'Memorized ✓';
        btn.style.background = '#1976d2'; // Soothing blue
        btn.style.color = '#fff';
        btn.style.border = 'none';
        btn.style.boxShadow = '0 2px 8px rgba(25, 118, 210, 0.08)';
      } else {
        btn.textContent = 'Mark as Memorized';
        btn.style.background = '#2196f3'; // Lighter blue for default
        btn.style.color = '#fff';
        btn.style.border = 'none';
        btn.style.boxShadow = '0 2px 8px rgba(33, 150, 243, 0.08)';
      }
    }

    function toggleMemorized(pageNum) {
      const idx = memorizedPages.indexOf(pageNum);
      if (idx === -1) {
        memorizedPages.push(pageNum);
      } else {
        memorizedPages.splice(idx, 1);
      }
      localStorage.setItem('memorizedPages', JSON.stringify(memorizedPages));
      updateMemorizeBtn();
    }

    function updateDashboard() {
  const total = TOTAL_PAGES;
  const memorized = memorizedPages.length;
  const percent = total ? Math.round((memorized / total) * 100) : 0;
  document.getElementById('progressBar').style.width = percent + '%';
  document.getElementById('progressText').textContent = `${memorized} / ${total} (${percent}%)`;
  renderMemorizedGrid();
    }

    async function init() {
      // Load memorized pages from localStorage
      const mem = localStorage.getItem('memorizedPages');
      memorizedPages = mem ? JSON.parse(mem) : [];
      layoutData = await loadJSON(LAYOUT_PATH);
      wordsData = await loadJSON(WORDS_PATH);
      surahNames = await loadJSON('./resources/surah-names.json');
  renderPage(currentPage);
  updateDashboard();
  renderMemorizedGrid();
      document.getElementById('prevPage').onclick = () => changePage(currentPage - 1);
      document.getElementById('nextPage').onclick = () => changePage(currentPage + 1);
      document.getElementById('gotoPageBtn').onclick = () => {
        const val = parseInt(document.getElementById('gotoPageInput').value, 10);
        if (!isNaN(val) && val >= 1 && val <= TOTAL_PAGES) {
          changePage(val);
        } else {
          alert('Please enter a valid page number (1-604).');
        }
      };
      document.getElementById('gotoPageInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('gotoPageBtn').click();
        }
      });
      document.getElementById('memorizeBtn').onclick = () => {
        toggleMemorized(currentPage);
      };
    }

    function changePage(page) {
      if (page < 1 || page > TOTAL_PAGES) return;
      currentPage = page;
      renderPage(currentPage);
  updateMemorizeBtn();
    }

    function renderPage(pageNum) {
      // Dynamically inject @font-face for the current page
      const fontId = 'dynamicQPCFont';
      let styleTag = document.getElementById(fontId);
      if (styleTag) styleTag.remove();
      styleTag = document.createElement('style');
      styleTag.id = fontId;
      styleTag.innerHTML = `@font-face { font-family: 'QPCV2Page'; src: url('./resources/QPC V2 Font.ttf/p${pageNum}.ttf') format('truetype'); font-weight: normal; font-style: normal; }`;
      document.head.appendChild(styleTag);

      const pageLines = layoutData.pages.filter(l => l.page_number === pageNum);
      const container = document.getElementById('quranPage');
      container.innerHTML = '';
      pageLines.forEach(line => {
        if (line.line_type === 'surah_name') {
          const surahDiv = document.createElement('div');
          surahDiv.className = 'surah-name';
          surahDiv.textContent = `سورة ${getSurahName(line.surah_number)}`;
          container.appendChild(surahDiv);
        } else if (line.line_type === 'basmallah') {
          const basmallahDiv = document.createElement('div');
          basmallahDiv.className = 'basmallah';
          basmallahDiv.textContent = '﷽';
          container.appendChild(basmallahDiv);
        } else {
          const lineDiv = document.createElement('div');
          lineDiv.className = 'quran-line';
          lineDiv.style.fontFamily = 'QPCV2Page, serif';
          if (line.first_word_id && line.last_word_id) {
            for (let wid = line.last_word_id; wid >= line.first_word_id; wid--) {
              const wordObj = getWordById(wid);
              if (!wordObj) continue;
              const wordSpan = document.createElement('span');
              wordSpan.className = 'quran-word';
              wordSpan.textContent = wordObj.text;
              wordSpan.title = `Surah ${wordObj.surah}, Ayah ${wordObj.ayah}, Word ${wordObj.word}`;
              wordSpan.onclick = () => onWordClick(wordObj);
              lineDiv.appendChild(wordSpan);
            }
          }
          container.appendChild(lineDiv);
        }
      });
      document.getElementById('pageIndicator').textContent = `Page ${pageNum} / ${TOTAL_PAGES}`;
      document.getElementById('prevPage').disabled = pageNum === 1;
      document.getElementById('nextPage').disabled = pageNum === TOTAL_PAGES;
  updateMemorizeBtn();
function updateMemorizeBtn() {
  const btn = document.getElementById('memorizeBtn');
  btn.style.background = '';
  btn.style.color = '';
  btn.style.border = '';
  btn.style.boxShadow = '';
  if (memorizedPages.includes(currentPage)) {
    btn.textContent = 'Memorized ✓';
    btn.style.background = '#1976d2'; // Soothing blue
    btn.style.color = '#fff';
    btn.style.border = 'none';
    btn.style.boxShadow = '0 2px 8px rgba(25, 118, 210, 0.08)';
  } else {
    btn.textContent = 'Mark as Memorized';
    btn.style.background = '#2196f3'; // Lighter blue for default
    btn.style.color = '#fff';
    btn.style.border = 'none';
    btn.style.boxShadow = '0 2px 8px rgba(33, 150, 243, 0.08)';
  }
}

function toggleMemorized(pageNum) {
  const idx = memorizedPages.indexOf(pageNum);
  if (idx === -1) {
    memorizedPages.push(pageNum);
  } else {
    memorizedPages.splice(idx, 1);
  }
  localStorage.setItem('memorizedPages', JSON.stringify(memorizedPages));
  updateMemorizeBtn();
  updateDashboard();
}
    }

    function getWordById(id) {
      // Find word by id in wordsData
      for (const key in wordsData) {
        if (wordsData[key].id == id) return wordsData[key];
      }
      return null;
    }

    function getSurahName(num) {
  // Lookup surah name from surahNames JSON
  return surahNames && surahNames[num] ? surahNames[num] : num;
    }

    function onWordClick(wordObj) {
      alert(`Word: ${wordObj.text}\nSurah: ${wordObj.surah}\nAyah: ${wordObj.ayah}\nWord #: ${wordObj.word}`);
    }

    window.onload = init;
  </script>
</body>
</html>
